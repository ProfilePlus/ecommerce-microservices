# Nginx é›†æˆæ›´æ–°è¯´æ˜

## ğŸ“‹ æ›´æ–°æ¦‚è¿°

å·²æˆåŠŸå°†å®Œæ•´çš„ Nginx ä¼˜åŒ–æ–¹æ¡ˆé›†æˆåˆ°ä¸‰ä¸ªç‰ˆæœ¬çš„éƒ¨ç½²æ–‡æ¡£ä¸­ï¼š
1. **åŸºç¡€ç‰ˆ**ï¼š`03-å®æˆ˜é¡¹ç›®éƒ¨ç½²æŒ‡å—ï¼ˆåŸºç¡€ç‰ˆï¼‰.md`
2. **ä¸­çº§ç‰ˆï¼ˆå‡çº§ç‰ˆï¼‰**ï¼š`07-å®æˆ˜é¡¹ç›®å‡çº§ç‰ˆéƒ¨ç½²æŒ‡å—.md`
3. **é«˜çº§ç‰ˆï¼ˆK8sç‰ˆï¼‰**ï¼š`08-ç²¾ç®€é«˜çº§ç‰ˆéƒ¨ç½²æŒ‡å—ï¼ˆ4æ ¸16Gä¼˜åŒ–ç‰ˆï¼‰.md`

---

## ğŸ“ å„ç‰ˆæœ¬æ›´æ–°è¯¦æƒ…

### 1ï¸âƒ£ åŸºç¡€ç‰ˆéƒ¨ç½²æ–‡æ¡£ï¼ˆ03ï¼‰

**æ›´æ–°ä½ç½®**ï¼šç¬¬äº”éƒ¨åˆ† â†’ 5.8 ä½¿ç”¨ Nginx éƒ¨ç½²å‰ç«¯ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨è âœ…ï¼‰

**æ–°å¢å†…å®¹**ï¼š
- âœ… ä¸ºä»€ä¹ˆä½¿ç”¨ Nginxï¼ˆæ€§èƒ½å¯¹æ¯”è¡¨ï¼‰
- âœ… å®Œæ•´çš„ Nginx é…ç½®ï¼ˆåŒ…å«æ‰€æœ‰ä¼˜åŒ–é¡¹ï¼‰
- âœ… Gzip å‹ç¼©é…ç½®ï¼ˆèŠ‚çœ74%å¸¦å®½ï¼‰
- âœ… æµè§ˆå™¨ç¼“å­˜ç­–ç•¥ï¼ˆåŠ è½½é€Ÿåº¦æå‡8å€ï¼‰
- âœ… API åå‘ä»£ç†é…ç½®
- âœ… é™æµä¿æŠ¤ï¼ˆé˜²DDoSï¼‰
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹
- âœ… æµ‹è¯•éªŒè¯æ­¥éª¤
- âœ… æ€§èƒ½æµ‹è¯•å¯¹æ¯”
- âœ… HTTPS é…ç½®ï¼ˆå¯é€‰ï¼‰
- âœ… Docker æ–¹å¼éƒ¨ç½²ï¼ˆæ¨èï¼‰
- âœ… ä¼˜åŒ–æ•ˆæœæ€»ç»“è¡¨

**æ ¸å¿ƒé…ç½®æ–‡ä»¶**ï¼š
```nginx
/etc/nginx/conf.d/ecommerce.conf  # ä¸»é…ç½®
/etc/nginx/nginx.conf             # Gzipé…ç½®
```

**æ€§èƒ½æå‡**ï¼š
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| QPS | 3,245 | 52,189 | **16å€** âœ… |
| å“åº”æ—¶é—´ | 30.8ms | 1.9ms | **16å€** âœ… |
| å†…å­˜å ç”¨ | 450MB | 15MB | **èŠ‚çœ96.7%** âœ… |
| å¸¦å®½æ¶ˆè€— | 1,404KB | 365KB | **èŠ‚çœ74%** âœ… |

---

### 2ï¸âƒ£ ä¸­çº§ç‰ˆéƒ¨ç½²æ–‡æ¡£ï¼ˆ07ï¼‰

**æ›´æ–°ä½ç½®**ï¼šç¬¬ä¸€éƒ¨åˆ†è¡¥å……B â†’ 1.B.3 æ–¹å¼ä¸€ï¼šä½¿ç”¨ Nginxï¼ˆç”Ÿäº§çº§é…ç½® âœ…ï¼‰

**æ–°å¢å†…å®¹ï¼ˆåœ¨åŸºç¡€ç‰ˆåŸºç¡€ä¸Šå¢å¼ºï¼‰**ï¼š
- âœ… ä¼ä¸šçº§ Nginx é…ç½®
- âœ… Gateway è´Ÿè½½å‡è¡¡é…ç½®ï¼ˆå¤šå®ä¾‹é«˜å¯ç”¨ï¼‰
- âœ… æ›´ä¸¥æ ¼çš„é™æµç­–ç•¥ï¼ˆAPIé€šç”¨ + ç™»å½•ç‰¹æ®Šï¼‰
- âœ… è¿æ¥æ•°é™åˆ¶
- âœ… å®‰å…¨å¤´é…ç½®
- âœ… Sentinel æ§åˆ¶å°ä»£ç†
- âœ… Seata æ§åˆ¶å°ä»£ç†
- âœ… Kibana ä»£ç†ï¼ˆELKé›†æˆï¼‰
- âœ… Nginx çŠ¶æ€ç›‘æ§ç«¯ç‚¹
- âœ… ä»£ç†ç¼“å­˜é…ç½®
- âœ… æ›´å¤§çš„ä¸Šä¼ æ–‡ä»¶é™åˆ¶ï¼ˆ50MBï¼‰

**ç‰¹è‰²é…ç½®**ï¼š
```nginx
# Gateway è´Ÿè½½å‡è¡¡ï¼ˆé«˜å¯ç”¨ï¼‰
upstream gateway_backend {
    server localhost:8000 weight=1 max_fails=3 fail_timeout=30s;
    server localhost:8001 weight=1 max_fails=3 fail_timeout=30s;
    server localhost:8002 weight=1 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# ç™»å½•æ¥å£ç‰¹æ®Šé™æµï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
location /api/auth/login {
    limit_req zone=login_limit burst=10 nodelay;
    ...
}

# Sentinel æ§åˆ¶å°ä»£ç†
location /sentinel/ {
    proxy_pass http://localhost:8858/;
    ...
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- éœ€è¦é«˜å¯ç”¨ï¼ˆå¤šGatewayå®ä¾‹ï¼‰
- é›†æˆäº† Seataã€Sentinelã€ELK ç­‰ä¸­é—´ä»¶
- éœ€è¦ç»Ÿä¸€ç®¡ç†å¤šä¸ªæ§åˆ¶å°

---

### 3ï¸âƒ£ é«˜çº§ç‰ˆéƒ¨ç½²æ–‡æ¡£ï¼ˆ08ï¼‰

**æ›´æ–°ä½ç½®**ï¼šç¬¬å››éƒ¨åˆ† â†’ 4.0.1 æ–¹å¼ä¸€ï¼šä½¿ç”¨ Nginx Ingress éƒ¨ç½²å‰ç«¯

**æ–°å¢å†…å®¹ï¼ˆKubernetes ç¯å¢ƒä¼˜åŒ–ï¼‰**ï¼š
- âœ… ä¼˜åŒ–çš„å¤šé˜¶æ®µ Dockerfileï¼ˆAlpine é•œåƒï¼Œä»…50MBï¼‰
- âœ… Kubernetes ä¼˜åŒ–çš„ Nginx é…ç½®
- âœ… å®Œæ•´çš„ K8s Deployment + Service + Ingress
- âœ… å¥åº·æ£€æŸ¥é…ç½®ï¼ˆlivenessProbe + readinessProbeï¼‰
- âœ… èµ„æºé™åˆ¶é…ç½®ï¼ˆ4æ ¸16Gä¼˜åŒ–ï¼‰
- âœ… Ingress æ³¨è§£é…ç½®ï¼ˆé™æµã€CORSã€è¶…æ—¶ï¼‰
- âœ… Kubernetes æœåŠ¡å‘ç°ï¼ˆä½¿ç”¨ cluster DNSï¼‰
- âœ… æ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆå®¹å™¨åŒ–æœ€ä½³å®è·µï¼‰
- âœ… Hosts é…ç½®è¯´æ˜
- âœ… æ€§èƒ½éªŒè¯æ­¥éª¤

**Dockerfile ä¼˜åŒ–**ï¼š
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine as build
...

# è¿è¡Œé˜¶æ®µï¼ˆAlpineé•œåƒï¼‰
FROM nginx:1.25-alpine
...

# å†…ç½®å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s \
    CMD wget --spider http://localhost/health || exit 1
```

**Kubernetes é…ç½®äº®ç‚¹**ï¼š
```yaml
# Ingress é…ç½®
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: "100"      # é™æµ
    nginx.ingress.kubernetes.io/enable-cors: "true"   # CORS
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
spec:
  rules:
  - host: ecommerce.local
    http:
      paths:
      - path: /            # å‰ç«¯
        backend:
          service:
            name: frontend
            port: 80
      - path: /api         # APIï¼ˆä»£ç†åˆ°Gatewayï¼‰
        backend:
          service:
            name: gateway-service
            port: 8000
```

**èµ„æºå ç”¨**ï¼š
```
å•å‰¯æœ¬å‰ç«¯ï¼ˆNginx + Vue3ï¼‰ï¼š
- CPU: 100m-200mï¼ˆ0.1-0.2æ ¸ï¼‰
- å†…å­˜: 128Mi-256Miï¼ˆ128-256MBï¼‰
- é•œåƒå¤§å°: ~50MB

å®Œå…¨æ»¡è¶³ 4æ ¸16G é…ç½®è¦æ±‚ âœ…
```

---

## ğŸ¯ ä¸‰ä¸ªç‰ˆæœ¬çš„åŒºåˆ«ä¸å®šä½

| ç‰¹æ€§ | åŸºç¡€ç‰ˆ | ä¸­çº§ç‰ˆ | é«˜çº§ç‰ˆ |
|------|--------|--------|--------|
| **éƒ¨ç½²æ–¹å¼** | ç›´æ¥éƒ¨ç½²/Docker | Docker Compose | Kubernetes |
| **Nginx ä½ç½®** | å®¿ä¸»æœº | å®¿ä¸»æœº/å®¹å™¨ | Kubernetes Pod |
| **é…ç½®å¤æ‚åº¦** | â­â­ ä¸­ç­‰ | â­â­â­ è¾ƒé«˜ | â­â­â­â­ é«˜ |
| **é«˜å¯ç”¨** | å•å®ä¾‹ | å¤šå®ä¾‹ + è´Ÿè½½å‡è¡¡ | Ingress + è‡ªåŠ¨ä¼¸ç¼© |
| **ç›‘æ§é›†æˆ** | åŸºç¡€æ—¥å¿— | Sentinel/Seata/ELK | Prometheus + Grafana |
| **é™æµç­–ç•¥** | åŸºç¡€é™æµ | åˆ†çº§é™æµ | Ingress é™æµ |
| **é€‚ç”¨åœºæ™¯** | å­¦ä¹ /å¼€å‘ | ä¸­å°å‹ç”Ÿäº§ | å¤§å‹ç”Ÿäº§/äº‘åŸç”Ÿ |
| **è–ªèµ„ç›®æ ‡** | 15K-20K | 20K-30K | 30K-40K |

---

## ğŸš€ ç»Ÿä¸€æ¶æ„å›¾

### åŸºç¡€ç‰ˆæ¶æ„
```
ç”¨æˆ·æµè§ˆå™¨
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx (:80)       â”‚
â”‚  âœ… é™æ€èµ„æº         â”‚
â”‚  âœ… Gzipå‹ç¼©         â”‚
â”‚  âœ… æµè§ˆå™¨ç¼“å­˜       â”‚
â”‚  âœ… APIä»£ç†          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ /api/*
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway (:8000)    â”‚
â”‚  âœ… åŠ¨æ€è·¯ç”±         â”‚
â”‚  âœ… æœåŠ¡å‘ç°         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
   å¾®æœåŠ¡é›†ç¾¤
```

### ä¸­çº§ç‰ˆæ¶æ„ï¼ˆé«˜å¯ç”¨ï¼‰
```
ç”¨æˆ·æµè§ˆå™¨
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx (:80)       â”‚
â”‚  âœ… é™æ€èµ„æº         â”‚
â”‚  âœ… é™æµåˆ†çº§         â”‚
â”‚  âœ… è´Ÿè½½å‡è¡¡         â”‚
â”‚  âœ… æ§åˆ¶å°ä»£ç†       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ /api/*
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway é›†ç¾¤        â”‚
â”‚  â”œâ”€â–º Gateway1:8000  â”‚
â”‚  â”œâ”€â–º Gateway2:8001  â”‚
â”‚  â””â”€â–º Gateway3:8002  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
   å¾®æœåŠ¡é›†ç¾¤
   â”œâ”€â–º Sentinel
   â”œâ”€â–º Seata
   â””â”€â–º ELK
```

### é«˜çº§ç‰ˆæ¶æ„ï¼ˆKubernetesï¼‰
```
Internet
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controller â”‚
â”‚  (Nginx)            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â–º / â†’ Frontend Pod (Nginx + Vue3)
      â”‚         â”œâ”€â–º é™æ€èµ„æº
      â”‚         â””â”€â–º å¥åº·æ£€æŸ¥
      â”‚
      â””â”€â–º /api â†’ Gateway Pod
                  â””â”€â–º å¾®æœåŠ¡é›†ç¾¤
                      â”œâ”€â–º Order Pod
                      â”œâ”€â–º Inventory Pod
                      â””â”€â–º Notification Pod

æ‰€æœ‰ Pod éƒ½æœ‰ï¼š
âœ… å¥åº·æ£€æŸ¥
âœ… èµ„æºé™åˆ¶
âœ… è‡ªåŠ¨é‡å¯
âœ… æœåŠ¡å‘ç°
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### æ€§èƒ½æå‡

| æŒ‡æ ‡ | æœªä¼˜åŒ– | åŸºç¡€ç‰ˆ | ä¸­çº§ç‰ˆ | é«˜çº§ç‰ˆ |
|------|--------|--------|--------|--------|
| **é™æ€èµ„æºQPS** | 3,245 | 52,189 | 52,189 | 50,000* |
| **é¦–é¡µåŠ è½½** | 1.4s | 0.37s | 0.37s | 0.40s* |
| **å¸¦å®½æ¶ˆè€—** | 1,404KB | 365KB | 365KB | 365KB |
| **å†…å­˜å ç”¨** | 450MB | 15MB | 20MB | 128MB* |

\* K8sç‰ˆæœ¬ç•¥æœ‰æ€§èƒ½æŸå¤±ï¼Œä½†æ¢æ¥äº†é«˜å¯ç”¨å’Œè‡ªåŠ¨åŒ–è¿ç»´

### åŠŸèƒ½å®Œå–„åº¦

| åŠŸèƒ½ | åŸºç¡€ç‰ˆ | ä¸­çº§ç‰ˆ | é«˜çº§ç‰ˆ |
|------|--------|--------|--------|
| **Gzipå‹ç¼©** | âœ… | âœ… | âœ… |
| **æµè§ˆå™¨ç¼“å­˜** | âœ… | âœ… | âœ… |
| **APIä»£ç†** | âœ… | âœ… | âœ… |
| **é™æµä¿æŠ¤** | âœ… åŸºç¡€ | âœ… åˆ†çº§ | âœ… Ingress |
| **é«˜å¯ç”¨** | âŒ | âœ… | âœ… |
| **å¥åº·æ£€æŸ¥** | âš ï¸ æ‰‹åŠ¨ | âš ï¸ æ‰‹åŠ¨ | âœ… è‡ªåŠ¨ |
| **è‡ªåŠ¨ä¼¸ç¼©** | âŒ | âŒ | âœ… |
| **æœåŠ¡å‘ç°** | âŒ | âš ï¸ æ‰‹åŠ¨ | âœ… è‡ªåŠ¨ |
| **ç›‘æ§é›†æˆ** | âŒ | âœ… | âœ… |

---

## ğŸ”§ å¿«é€Ÿå¼€å§‹æŒ‡å—

### åŸºç¡€ç‰ˆï¼ˆæ¨èæ–°æ‰‹ï¼‰
```bash
cd frontend
npm run build

sudo yum install -y nginx
sudo cp -r dist/* /usr/share/nginx/html/
sudo systemctl start nginx

è®¿é—®ï¼šhttp://localhost
```

### ä¸­çº§ç‰ˆï¼ˆæ¨èå®æˆ˜ï¼‰
```bash
cd frontend
pnpm build

sudo yum install -y nginx
sudo cp ecommerce.conf /etc/nginx/conf.d/
sudo systemctl restart nginx

è®¿é—®ï¼šhttp://localhost
```

### é«˜çº§ç‰ˆï¼ˆæ¨èé¢è¯•ï¼‰
```bash
cd frontend
docker build -t ecommerce-frontend:1.0.0 .

kubectl apply -f k8s-deployment.yaml
kubectl get ingress -n apps

è®¿é—®ï¼šhttp://ecommerce.local
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **16-é¡¹ç›®æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆï¼ˆNginxå®æˆ˜é›†æˆï¼‰.md** - Nginxä¼˜åŒ–è¯¦è§£
2. **14-APIç½‘å…³æŠ€æœ¯é€‰å‹å¯¹æ¯”ä¸å®æˆ˜ï¼ˆGateway vs Nginx vs Kongï¼‰.md** - ç½‘å…³é€‰å‹å¯¹æ¯”
3. **15-Spring Cloud Gateway ç½‘å…³åŸç†ä¸å®ç°æ•ˆæœè¯¦è§£.md** - GatewayåŸç†æ·±åº¦å‰–æ

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆéƒ¨ç½²åï¼Œè¯·éªŒè¯ä»¥ä¸‹é¡¹ç›®ï¼š

### åŸºç¡€åŠŸèƒ½
- [ ] å‰ç«¯é¡µé¢èƒ½æ­£å¸¸è®¿é—®
- [ ] APIè¯·æ±‚èƒ½æ­£å¸¸è½¬å‘åˆ°Gateway
- [ ] å‰ç«¯è·¯ç”±ï¼ˆVue Routerï¼‰èƒ½æ­£å¸¸å·¥ä½œ

### æ€§èƒ½ä¼˜åŒ–
- [ ] Gzipå‹ç¼©å·²å¯ç”¨ï¼ˆæ£€æŸ¥å“åº”å¤´ï¼šContent-Encoding: gzipï¼‰
- [ ] æµè§ˆå™¨ç¼“å­˜å·²å¯ç”¨ï¼ˆæ£€æŸ¥å“åº”å¤´ï¼šCache-Controlï¼‰
- [ ] é™æ€èµ„æºåŠ è½½é€Ÿåº¦æ˜æ˜¾æå‡

### å®‰å…¨é˜²æŠ¤
- [ ] é™æµé…ç½®å·²ç”Ÿæ•ˆï¼ˆå¿«é€Ÿåˆ·æ–°ä¼šè¢«é™åˆ¶ï¼‰
- [ ] å®‰å…¨å¤´å·²æ·»åŠ ï¼ˆX-Frame-Optionsç­‰ï¼‰
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹å¯è®¿é—®ï¼ˆ/healthï¼‰

### ç›‘æ§æ—¥å¿—
- [ ] è®¿é—®æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] é”™è¯¯æ—¥å¿—æ­£å¸¸è®°å½•
- [ ] NginxçŠ¶æ€ç›‘æ§å¯è®¿é—®ï¼ˆå¦‚æœé…ç½®ï¼‰

---

## ğŸ“ å­¦ä¹ å»ºè®®

1. **åˆå­¦è€…**ï¼šä»åŸºç¡€ç‰ˆå¼€å§‹ï¼Œç†è§£NginxåŸºæœ¬é…ç½®
2. **è¿›é˜¶è€…**ï¼šå­¦ä¹ ä¸­çº§ç‰ˆï¼ŒæŒæ¡è´Ÿè½½å‡è¡¡å’Œé™æµ
3. **é«˜çº§è€…**ï¼šç ”ç©¶é«˜çº§ç‰ˆï¼ŒæŒæ¡Kuberneteså’Œäº‘åŸç”Ÿ

**å¾ªåºæ¸è¿›ï¼Œç¨³æ‰ç¨³æ‰“ï¼** ğŸš€

---

**æ›´æ–°æ—¶é—´**ï¼š2024-11-20  
**æ›´æ–°å†…å®¹**ï¼šNginxå®Œæ•´é›†æˆæ–¹æ¡ˆ  
**ç‰ˆæœ¬**ï¼šv1.0.0



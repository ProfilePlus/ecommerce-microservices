# ç”µå•†å¾®æœåŠ¡é¡¹ç›®é¢è¯•é¢˜å¤§å…¨ï¼ˆå«ç­”æ¡ˆï¼‰
## æ¶µç›–JavaåŸºç¡€ã€æ¡†æ¶ã€å¾®æœåŠ¡ã€ä¸­é—´ä»¶ã€äº‘åŸç”Ÿå…¨æ ˆ

---

## ğŸ“‹ é¢è¯•é¢˜åˆ†ç±»

- **ç¬¬ä¸€éƒ¨åˆ†**ï¼šé¡¹ç›®ä»‹ç»ä¸æ¶æ„è®¾è®¡ï¼ˆå¿…é—®ï¼‰
- **ç¬¬äºŒéƒ¨åˆ†**ï¼šJavaåŸºç¡€ï¼ˆé«˜é¢‘ï¼‰
- **ç¬¬ä¸‰éƒ¨åˆ†**ï¼šSpringæ¡†æ¶ï¼ˆå¿…é—®ï¼‰
- **ç¬¬å››éƒ¨åˆ†**ï¼šå¾®æœåŠ¡æŠ€æœ¯ï¼ˆæ ¸å¿ƒï¼‰
- **ç¬¬äº”éƒ¨åˆ†**ï¼šä¸­é—´ä»¶åº”ç”¨ï¼ˆé«˜é¢‘ï¼‰
- **ç¬¬å…­éƒ¨åˆ†**ï¼šæ•°æ®åº“ç›¸å…³ï¼ˆå¿…é—®ï¼‰
- **ç¬¬ä¸ƒéƒ¨åˆ†**ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆåŠ åˆ†é¡¹ï¼‰
- **ç¬¬å…«éƒ¨åˆ†**ï¼šäº‘åŸç”ŸæŠ€æœ¯ï¼ˆåŠ åˆ†é¡¹ï¼‰
- **ç¬¬ä¹éƒ¨åˆ†**ï¼šä¸šåŠ¡åœºæ™¯é¢˜ï¼ˆå®æˆ˜ï¼‰
- **ç¬¬åéƒ¨åˆ†**ï¼šç»¼åˆé—®é¢˜ï¼ˆæ·±åº¦ï¼‰

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®ä»‹ç»ä¸æ¶æ„è®¾è®¡

### 1.1 è¯·ä»‹ç»ä¸€ä¸‹ä½ åšçš„è¿™ä¸ªç”µå•†å¾®æœåŠ¡é¡¹ç›®

**æ ‡å‡†å›ç­”**ï¼š

è¿™æ˜¯ä¸€ä¸ªåŸºäºSpring Cloud Alibabaçš„åˆ†å¸ƒå¼ç”µå•†å¾®æœåŠ¡é¡¹ç›®ï¼Œä¸»è¦åŒ…å«è®¢å•ã€åº“å­˜ã€é€šçŸ¥ã€ç½‘å…³ç­‰æ ¸å¿ƒæœåŠ¡ã€‚

**æŠ€æœ¯æ ˆ**ï¼š
- **åç«¯æ¡†æ¶**ï¼šSpring Boot 2.7ã€Spring Cloud Alibaba 2021
- **æœåŠ¡æ²»ç†**ï¼šNacosï¼ˆæ³¨å†Œä¸­å¿ƒ+é…ç½®ä¸­å¿ƒï¼‰
- **ç½‘å…³**ï¼šSpring Cloud Gateway
- **æ•°æ®åº“**ï¼šPostgreSQL 14
- **ç¼“å­˜**ï¼šRedis 7.0
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šKafka + RabbitMQ
- **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šSeata
- **é™æµé™çº§**ï¼šSentinel
- **å…¨æ–‡æœç´¢**ï¼šElasticsearch
- **ç›‘æ§**ï¼šPrometheus + Grafana + SkyWalking
- **å®¹å™¨åŒ–**ï¼šDocker + Kubernetes

**ç³»ç»Ÿæ¶æ„**ï¼š
```
ç”¨æˆ·è¯·æ±‚ 
   â†“
APIç½‘å…³ï¼ˆGatewayï¼‰
   â†“
NacosæœåŠ¡å‘ç°
   â†“
â”œâ”€â”€ è®¢å•æœåŠ¡ï¼ˆOrder Serviceï¼‰
â”‚   â”œâ”€â”€ PostgreSQLï¼ˆä¸»æ•°æ®ï¼‰
â”‚   â”œâ”€â”€ Redisï¼ˆç¼“å­˜ï¼‰
â”‚   â””â”€â”€ Kafkaï¼ˆæ¶ˆæ¯ï¼‰
â”‚
â”œâ”€â”€ åº“å­˜æœåŠ¡ï¼ˆInventory Serviceï¼‰
â”‚   â”œâ”€â”€ PostgreSQL
â”‚   â””â”€â”€ Redisï¼ˆåˆ†å¸ƒå¼é”ï¼‰
â”‚
â””â”€â”€ é€šçŸ¥æœåŠ¡ï¼ˆNotification Serviceï¼‰
    â””â”€â”€ RabbitMQï¼ˆæ¶ˆæ¯æ¶ˆè´¹ï¼‰
```

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
1. è®¢å•ç®¡ç†ï¼šåˆ›å»ºã€æŸ¥è¯¢ã€å–æ¶ˆè®¢å•
2. åº“å­˜ç®¡ç†ï¼šåº“å­˜æ‰£å‡ã€åº“å­˜æŸ¥è¯¢ï¼ˆæ”¯æŒé«˜å¹¶å‘ï¼‰
3. æ¶ˆæ¯é€šçŸ¥ï¼šè®¢å•çŠ¶æ€é€šçŸ¥ã€åº“å­˜é¢„è­¦
4. åˆ†å¸ƒå¼äº‹åŠ¡ï¼šSeataä¿è¯è®¢å•å’Œåº“å­˜ä¸€è‡´æ€§
5. é™æµé™çº§ï¼šSentinelä¿æŠ¤æœåŠ¡ç¨³å®šæ€§

**äº®ç‚¹**ï¼š
- âœ… ä½¿ç”¨Kuberneteséƒ¨ç½²ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… å®Œæ•´çš„ç›‘æ§ä½“ç³»ï¼ˆé“¾è·¯è¿½è¸ªã€æ—¥å¿—ã€æŒ‡æ ‡ï¼‰
- âœ… é«˜å¹¶å‘å¤„ç†ï¼ˆRedisåˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°ï¼‰
- âœ… é«˜å¯ç”¨è®¾è®¡ï¼ˆå¤šå‰¯æœ¬éƒ¨ç½²ã€ç†”æ–­é™çº§ï¼‰

---

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©å¾®æœåŠ¡æ¶æ„ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

é€‰æ‹©å¾®æœåŠ¡æ¶æ„ä¸»è¦åŸºäºä»¥ä¸‹è€ƒè™‘ï¼š

**1. ä¸šåŠ¡å¤æ‚åº¦**ï¼š
- ç”µå•†ç³»ç»Ÿä¸šåŠ¡å¤æ‚ï¼Œè®¢å•ã€åº“å­˜ã€æ”¯ä»˜ã€ç‰©æµç­‰æ¨¡å—è€¦åˆåº¦é«˜
- å¾®æœåŠ¡å¯ä»¥æŒ‰ä¸šåŠ¡é¢†åŸŸæ‹†åˆ†ï¼Œé™ä½å¤æ‚åº¦
- æ¯ä¸ªæœåŠ¡èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤

**2. å›¢é˜Ÿåä½œ**ï¼š
- ä¸åŒå›¢é˜Ÿå¯ä»¥ç‹¬ç«‹å¼€å‘å„è‡ªçš„æœåŠ¡
- å‡å°‘ä»£ç å†²çªï¼Œæé«˜å¼€å‘æ•ˆç‡
- å¯ä»¥ä½¿ç”¨ä¸åŒæŠ€æœ¯æ ˆï¼ˆè™½ç„¶æˆ‘ä»¬ç»Ÿä¸€ç”¨Javaï¼‰

**3. æ‰©å±•æ€§**ï¼š
- å¯ä»¥é’ˆå¯¹é«˜å¹¶å‘æœåŠ¡ï¼ˆå¦‚è®¢å•ã€åº“å­˜ï¼‰å•ç‹¬æ‰©å®¹
- ä¸éœ€è¦æ•´ä½“æ‰©å®¹ï¼ŒèŠ‚çœèµ„æº
- æ”¯æŒæ°´å¹³æ‰©å±•

**4. å®¹é”™æ€§**ï¼š
- å•ä¸ªæœåŠ¡æ•…éšœä¸ä¼šå½±å“æ•´ä½“ç³»ç»Ÿ
- é€šè¿‡ç†”æ–­ã€é™çº§ä¿è¯æœåŠ¡å¯ç”¨æ€§
- æé«˜ç³»ç»Ÿç¨³å®šæ€§

**5. æŠ€æœ¯æ¼”è¿›**ï¼š
- å¯ä»¥é’ˆå¯¹å•ä¸ªæœåŠ¡è¿›è¡ŒæŠ€æœ¯å‡çº§
- ä¸å½±å“å…¶ä»–æœåŠ¡
- é™ä½æŠ€æœ¯å€ºåŠ¡

**å¯¹æ¯”å•ä½“æ¶æ„**ï¼š
```
å•ä½“æ¶æ„é—®é¢˜ï¼š
âŒ ä»£ç è€¦åˆåº¦é«˜ï¼Œæ”¹ä¸€å¤„å½±å“å…¨å±€
âŒ æ‰©å±•æ€§å·®ï¼Œåªèƒ½æ•´ä½“æ‰©å®¹
âŒ éƒ¨ç½²æ…¢ï¼Œæ”¹ä¸€è¡Œä»£ç è¦é‡æ–°éƒ¨ç½²æ•´ä¸ªåº”ç”¨
âŒ æŠ€æœ¯æ ˆå›ºå®šï¼Œéš¾ä»¥å‡çº§

å¾®æœåŠ¡æ¶æ„ä¼˜åŠ¿ï¼š
âœ… ä½è€¦åˆï¼Œç‹¬ç«‹å¼€å‘éƒ¨ç½²
âœ… æŒ‰éœ€æ‰©å±•ï¼ŒèŠ‚çœèµ„æº
âœ… éƒ¨ç½²å¿«ï¼Œç°åº¦å‘å¸ƒ
âœ… æŠ€æœ¯æ ˆçµæ´»
```

---

### 1.3 å¾®æœåŠ¡ä¹‹é—´å¦‚ä½•é€šä¿¡ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†ä¸¤ç§é€šä¿¡æ–¹å¼ï¼š

**1. åŒæ­¥é€šä¿¡ - OpenFeignï¼ˆRPCï¼‰**

ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦ç«‹å³è·å–ç»“æœçš„åœºæ™¯

ç¤ºä¾‹ï¼šè®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡æ£€æŸ¥åº“å­˜

```java
@FeignClient(name = "inventory-service")
public interface InventoryClient {
    
    @GetMapping("/api/inventory/{productId}/stock")
    Integer getStock(@PathVariable("productId") Long productId);
    
    @PostMapping("/api/inventory/deduct")
    Boolean deductStock(@RequestParam("productId") Long productId,
                       @RequestParam("quantity") Integer quantity);
}

// è®¢å•æœåŠ¡ä¸­ä½¿ç”¨
@Service
public class OrderService {
    
    @Autowired
    private InventoryClient inventoryClient;
    
    public void createOrder(OrderRequest request) {
        // æ£€æŸ¥åº“å­˜
        Integer stock = inventoryClient.getStock(request.getProductId());
        if (stock < request.getQuantity()) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        // æ‰£å‡åº“å­˜
        inventoryClient.deductStock(request.getProductId(), request.getQuantity());
        
        // åˆ›å»ºè®¢å•
        // ...
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®æ—¶æ€§å¼ºï¼Œç«‹å³è·å–ç»“æœ
- âœ… ä»£ç ç®€æ´ï¼Œåƒè°ƒç”¨æœ¬åœ°æ–¹æ³•

**ç¼ºç‚¹**ï¼š
- âš ï¸ è€¦åˆåº¦é«˜ï¼ŒæœåŠ¡ä¾èµ–
- âš ï¸ æ€§èƒ½å¼€é”€å¤§ï¼ˆç½‘ç»œIOï¼‰
- âš ï¸ éœ€è¦è€ƒè™‘è¶…æ—¶ã€é‡è¯•

**ä¼˜åŒ–æªæ–½**ï¼š
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- é…ç½®é‡è¯•æœºåˆ¶
- å®ç°ç†”æ–­é™çº§ï¼ˆSentinelï¼‰

---

**2. å¼‚æ­¥é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafka/RabbitMQï¼‰**

ä½¿ç”¨åœºæ™¯ï¼šä¸éœ€è¦ç«‹å³è·å–ç»“æœçš„åœºæ™¯

ç¤ºä¾‹ï¼šè®¢å•åˆ›å»ºåå‘é€é€šçŸ¥

```java
// è®¢å•æœåŠ¡ - å‘é€æ¶ˆæ¯
@Service
public class OrderService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    public void createOrder(OrderRequest request) {
        // åˆ›å»ºè®¢å•
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // å‘é€æ¶ˆæ¯ï¼ˆå¼‚æ­¥ï¼‰
        OrderCreatedEvent event = new OrderCreatedEvent(
            order.getId(),
            order.getOrderNo(),
            order.getUserId()
        );
        kafkaTemplate.send("order-created", event);
        
        // ä¸ç­‰å¾…æ¶ˆæ¯å¤„ç†ç»“æœï¼Œç›´æ¥è¿”å›
    }
}

// é€šçŸ¥æœåŠ¡ - æ¶ˆè´¹æ¶ˆæ¯
@Service
public class NotificationService {
    
    @KafkaListener(topics = "order-created")
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å‘é€é€šçŸ¥
        sendNotification(event.getUserId(), 
                        "è®¢å•åˆ›å»ºæˆåŠŸï¼š" + event.getOrderNo());
    }
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… è§£è€¦ï¼ŒæœåŠ¡ç‹¬ç«‹
- âœ… å¼‚æ­¥å¤„ç†ï¼Œæé«˜æ€§èƒ½
- âœ… å‰Šå³°å¡«è°·ï¼Œåº”å¯¹é«˜å¹¶å‘
- âœ… æ¶ˆæ¯æŒä¹…åŒ–ï¼Œä¿è¯å¯é æ€§

**ç¼ºç‚¹**ï¼š
- âš ï¸ å¤æ‚åº¦å¢åŠ ï¼ˆæ¶ˆæ¯ä¸¢å¤±ã€é‡å¤ã€é¡ºåºï¼‰
- âš ï¸ ä¸€è‡´æ€§é—®é¢˜ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰

**æˆ‘ä»¬çš„é€‰æ‹©ç­–ç•¥**ï¼š
```
åŒæ­¥è°ƒç”¨ï¼ˆOpenFeignï¼‰ï¼š
- å¼ºä¸€è‡´æ€§è¦æ±‚ï¼ˆåº“å­˜æ‰£å‡ï¼‰
- éœ€è¦ç«‹å³è·å–ç»“æœ
- æ ¸å¿ƒä¸šåŠ¡æµç¨‹

å¼‚æ­¥æ¶ˆæ¯ï¼ˆKafkaï¼‰ï¼š
- æœ€ç»ˆä¸€è‡´æ€§å³å¯ï¼ˆå‘é€é€šçŸ¥ï¼‰
- ä¸éœ€è¦ç«‹å³ç»“æœ
- æ—¥å¿—ã€ç»Ÿè®¡ã€é€šçŸ¥ç­‰
```

---

### 1.4 å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬ä½¿ç”¨Seataåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼Œé‡‡ç”¨ATæ¨¡å¼ä¿è¯å¼ºä¸€è‡´æ€§ã€‚

**åœºæ™¯**ï¼šåˆ›å»ºè®¢å•æ—¶éœ€è¦æ‰£å‡åº“å­˜ï¼Œæ¶‰åŠä¸¤ä¸ªæœåŠ¡ï¼š

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryClient inventoryClient;
    
    // å¼€å¯å…¨å±€äº‹åŠ¡
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼Œåˆ†æ”¯äº‹åŠ¡ï¼‰
        inventoryClient.deductStock(request.getProductId(), request.getQuantity());
        
        // å¦‚æœæ‰£å‡åº“å­˜å¤±è´¥ï¼ŒSeataä¼šè‡ªåŠ¨å›æ»šè®¢å•çš„åˆ›å»º
    }
}

// åº“å­˜æœåŠ¡
@Service
public class InventoryService {
    
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @Transactional(rollbackFor = Exception.class)
    public void deductStock(Long productId, Integer quantity) {
        Inventory inventory = inventoryRepository.findByProductId(productId)
            .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨"));
        
        if (inventory.getStock() < quantity) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        inventory.setStock(inventory.getStock() - quantity);
        inventoryRepository.save(inventory);
    }
}
```

**Seataå·¥ä½œæµç¨‹**ï¼š

```
1. è®¢å•æœåŠ¡å¼€å¯å…¨å±€äº‹åŠ¡ï¼ˆTMï¼‰
   - ç”Ÿæˆå…¨å±€äº‹åŠ¡IDï¼ˆXIDï¼‰

2. è®¢å•æœåŠ¡åˆ›å»ºè®¢å•
   - è®°å½•Beforeé•œåƒï¼ˆè®¢å•æ•°æ®ä¸ºç©ºï¼‰
   - æ‰§è¡ŒSQLæ’å…¥è®¢å•
   - è®°å½•Afteré•œåƒï¼ˆæ–°è®¢å•æ•°æ®ï¼‰
   - æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°TC

3. è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡
   - ä¼ é€’XIDåˆ°åº“å­˜æœåŠ¡

4. åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜
   - è®°å½•Beforeé•œåƒï¼ˆåŸåº“å­˜æ•°æ®ï¼‰
   - æ‰§è¡ŒSQLæ›´æ–°åº“å­˜
   - è®°å½•Afteré•œåƒï¼ˆæ–°åº“å­˜æ•°æ®ï¼‰
   - æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°TC

5. æ‰€æœ‰æ“ä½œæˆåŠŸ
   - TMé€šçŸ¥TCæäº¤å…¨å±€äº‹åŠ¡
   - TCé€šçŸ¥æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡æäº¤
   - åˆ é™¤é•œåƒæ•°æ®ï¼Œé‡Šæ”¾é”

6. å¦‚æœä»»ä½•æ“ä½œå¤±è´¥
   - TMé€šçŸ¥TCå›æ»šå…¨å±€äº‹åŠ¡
   - TCé€šçŸ¥æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡å›æ»š
   - ä½¿ç”¨Beforeé•œåƒæ¢å¤æ•°æ®
```

**ä¸ºä»€ä¹ˆé€‰æ‹©Seata ATæ¨¡å¼ï¼Ÿ**

```
ATæ¨¡å¼ä¼˜ç‚¹ï¼š
âœ… æ— ä¾µå…¥ï¼ˆä¸æ”¹ä¸šåŠ¡ä»£ç ï¼‰
âœ… æ€§èƒ½å¥½ï¼ˆä¸€é˜¶æ®µæäº¤ï¼‰
âœ… é€‚åˆå¤§éƒ¨åˆ†åœºæ™¯

å…¶ä»–æ¨¡å¼å¯¹æ¯”ï¼š

TCCæ¨¡å¼ï¼š
âš ï¸ éœ€è¦å®ç°Tryã€Confirmã€Cancel
âš ï¸ ä»£ç ä¾µå…¥æ€§å¼º
âœ… æ€§èƒ½æœ€å¥½
âœ… é€‚åˆæ ¸å¿ƒä¸šåŠ¡

Sagaæ¨¡å¼ï¼š
âš ï¸ éœ€è¦å®ç°æ­£å‘å’Œè¡¥å¿æ“ä½œ
âœ… é€‚åˆé•¿äº‹åŠ¡
âœ… é€‚åˆè·¨ç³»ç»Ÿ

æˆ‘ä»¬é€‰ATæ¨¡å¼å› ä¸ºï¼š
1. ä¸šåŠ¡ä»£ç ç®€å•ï¼Œæ— éœ€æ”¹é€ 
2. æ€§èƒ½æ»¡è¶³éœ€æ±‚
3. å¯é æ€§é«˜
```

**æ³¨æ„äº‹é¡¹**ï¼š

1. **å¹‚ç­‰æ€§**ï¼šæ¥å£è¦æ”¯æŒå¹‚ç­‰
2. **è¶…æ—¶è®¾ç½®**ï¼šé¿å…é•¿æ—¶é—´é”å®šèµ„æº
3. **é™çº§æ–¹æ¡ˆ**ï¼šSeataä¸å¯ç”¨æ—¶çš„å¤„ç†

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šJavaåŸºç¡€

### 2.1 è¯´è¯´HashMapçš„åº•å±‚åŸç†

**æ ‡å‡†å›ç­”**ï¼š

**HashMapåº•å±‚ç»“æ„**ï¼ˆJDK 1.8+ï¼‰ï¼š

```
æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘

å“ˆå¸Œè¡¨ç»“æ„ï¼š
+---------+---------+---------+---------+
| Node[0] | Node[1] | Node[2] | Node[3] | ... æ•°ç»„ï¼ˆæ¡¶ï¼‰
+---------+---------+---------+---------+
    â†“
  é“¾è¡¨/çº¢é»‘æ ‘ï¼ˆè§£å†³å“ˆå¸Œå†²çªï¼‰
```

**æ ¸å¿ƒåŸç†**ï¼š

1. **å­˜å‚¨ç»“æ„**ï¼š
```java
// NodeèŠ‚ç‚¹
static class Node<K,V> implements Map.Entry<K,V> {
    final int hash;        // å“ˆå¸Œå€¼
    final K key;           // é”®
    V value;               // å€¼
    Node<K,V> next;        // ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
}

// å†…éƒ¨æ•°ç»„
transient Node<K,V>[] table;

// é»˜è®¤åˆå§‹å®¹é‡ï¼š16
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4;

// é»˜è®¤è´Ÿè½½å› å­ï¼š0.75
static final float DEFAULT_LOAD_FACTOR = 0.75f;

// é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼ï¼š8
static final int TREEIFY_THRESHOLD = 8;

// çº¢é»‘æ ‘è½¬é“¾è¡¨é˜ˆå€¼ï¼š6
static final int UNTREEIFY_THRESHOLD = 6;
```

2. **putæ“ä½œæµç¨‹**ï¼š
```java
public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}

final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
               boolean evict) {
    // 1. è®¡ç®—ç´¢å¼•ä½ç½®
    int index = (n - 1) & hash;  // næ˜¯æ•°ç»„é•¿åº¦
    
    // 2. åˆ¤æ–­è¯¥ä½ç½®æ˜¯å¦æœ‰å…ƒç´ 
    if (table[index] == null) {
        // 2.1 æ²¡æœ‰å…ƒç´ ï¼Œç›´æ¥æ”¾å…¥
        table[index] = new Node(hash, key, value, null);
    } else {
        // 2.2 æœ‰å…ƒç´ ï¼ˆå“ˆå¸Œå†²çªï¼‰
        Node<K,V> e = table[index];
        
        // 2.3 åˆ¤æ–­keyæ˜¯å¦ç›¸åŒ
        if (e.hash == hash && (e.key == key || key.equals(e.key))) {
            // keyç›¸åŒï¼Œè¦†ç›–value
            e.value = value;
        } else if (e instanceof TreeNode) {
            // 2.4 çº¢é»‘æ ‘ï¼Œæ’å…¥åˆ°æ ‘ä¸­
            ((TreeNode)e).putTreeVal(this, table, hash, key, value);
        } else {
            // 2.5 é“¾è¡¨ï¼Œéå†é“¾è¡¨
            int binCount = 0;
            for (Node<K,V> p = e; ; p = p.next) {
                if (p.next == null) {
                    // æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨
                    p.next = new Node(hash, key, value, null);
                    
                    // åˆ¤æ–­æ˜¯å¦éœ€è¦è½¬çº¢é»‘æ ‘ï¼ˆé“¾è¡¨é•¿åº¦>=8ï¼‰
                    if (binCount >= TREEIFY_THRESHOLD - 1) {
                        treeifyBin(table, hash);
                    }
                    break;
                }
                
                // æ‰¾åˆ°ç›¸åŒkeyï¼Œè¦†ç›–
                if (p.hash == hash && (p.key == key || key.equals(p.key))) {
                    p.value = value;
                    break;
                }
                binCount++;
            }
        }
    }
    
    // 3. åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼ˆsize > capacity * loadFactorï¼‰
    if (++size > threshold) {
        resize();  // æ‰©å®¹ä¸º2å€
    }
    
    return null;
}
```

3. **getæ“ä½œæµç¨‹**ï¼š
```java
public V get(Object key) {
    Node<K,V> e;
    
    // 1. è®¡ç®—hash
    int hash = hash(key);
    
    // 2. è®¡ç®—ç´¢å¼•
    int index = (table.length - 1) & hash;
    
    // 3. è·å–å¤´èŠ‚ç‚¹
    e = table[index];
    
    // 4. åˆ¤æ–­å¤´èŠ‚ç‚¹æ˜¯å¦æ˜¯ç›®æ ‡
    if (e != null && e.hash == hash && (e.key == key || key.equals(e.key))) {
        return e.value;
    }
    
    // 5. éå†é“¾è¡¨æˆ–çº¢é»‘æ ‘
    if (e instanceof TreeNode) {
        // çº¢é»‘æ ‘æŸ¥æ‰¾
        return ((TreeNode)e).getTreeNode(hash, key).value;
    } else {
        // é“¾è¡¨æŸ¥æ‰¾
        while (e != null) {
            if (e.hash == hash && (e.key == key || key.equals(e.key))) {
                return e.value;
            }
            e = e.next;
        }
    }
    
    return null;
}
```

**å…³é”®ç‚¹**ï¼š

1. **å“ˆå¸Œå‡½æ•°**ï¼š
```java
static final int hash(Object key) {
    int h;
    // é«˜16ä½ä¸ä½16ä½å¼‚æˆ–ï¼Œå‡å°‘å“ˆå¸Œå†²çª
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

2. **ä¸ºä»€ä¹ˆå®¹é‡æ˜¯2çš„å¹‚æ¬¡ï¼Ÿ**
```
å› ä¸ºè®¡ç®—ç´¢å¼•ä½¿ç”¨ï¼šindex = (n - 1) & hash

næ˜¯2çš„å¹‚æ¬¡æ—¶ï¼š
n = 16 = 0001 0000
n - 1 = 15 = 0000 1111

(n - 1) & hash ç­‰ä»·äº hash % nï¼Œä½†ä½è¿ç®—æ›´å¿«
```

3. **ä¸ºä»€ä¹ˆé“¾è¡¨é•¿åº¦>=8è½¬çº¢é»‘æ ‘ï¼Ÿ**
```
é“¾è¡¨æŸ¥è¯¢ï¼šO(n)
çº¢é»‘æ ‘æŸ¥è¯¢ï¼šO(log n)

é“¾è¡¨é•¿åº¦ä¸º8æ—¶ï¼š
- é“¾è¡¨æŸ¥è¯¢ï¼š8æ¬¡
- çº¢é»‘æ ‘æŸ¥è¯¢ï¼š3æ¬¡ï¼ˆlogâ‚‚8 = 3ï¼‰

æ€§èƒ½æå‡æ˜æ˜¾ï¼Œä½†çº¢é»‘æ ‘éœ€è¦é¢å¤–ç©ºé—´å’Œç»´æŠ¤æˆæœ¬
```

4. **ä¸ºä»€ä¹ˆè´Ÿè½½å› å­æ˜¯0.75ï¼Ÿ**
```
è´Ÿè½½å› å­ = å…ƒç´ æ•°é‡ / æ•°ç»„å®¹é‡

0.75æ˜¯æ—¶é—´å’Œç©ºé—´çš„æƒè¡¡ï¼š
- å¤ªå°ï¼ˆ0.5ï¼‰ï¼šç©ºé—´åˆ©ç”¨ç‡ä½ï¼Œæµªè´¹å†…å­˜
- å¤ªå¤§ï¼ˆ1.0ï¼‰ï¼šå“ˆå¸Œå†²çªå¤šï¼Œæ€§èƒ½ä¸‹é™

0.75æ˜¯ç»Ÿè®¡å­¦ä¸Šçš„æœ€ä½³å€¼
```

**çº¿ç¨‹å®‰å…¨é—®é¢˜**ï¼š

HashMapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä½¿ç”¨ï¼š
- `ConcurrentHashMap`ï¼ˆæ¨èï¼‰
- `Collections.synchronizedMap()`
- `Hashtable`ï¼ˆå·²è¿‡æ—¶ï¼‰

---

### 2.2 è¯´è¯´ConcurrentHashMapçš„åŸç†

**æ ‡å‡†å›ç­”**ï¼š

`ConcurrentHashMap`æ˜¯çº¿ç¨‹å®‰å…¨çš„HashMapï¼Œé‡‡ç”¨**åˆ†æ®µé”**ï¼ˆJDK 1.7ï¼‰æˆ–**CAS + synchronized**ï¼ˆJDK 1.8+ï¼‰å®ç°ã€‚

**JDK 1.8+çš„å®ç°ï¼ˆé‡ç‚¹ï¼‰**ï¼š

1. **æ ¸å¿ƒç»“æ„**ï¼š
```java
// æ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘ï¼ˆå’ŒHashMapä¸€æ ·ï¼‰
transient volatile Node<K,V>[] table;

// å…³é”®åŒºåˆ«ï¼šNodeèŠ‚ç‚¹ç”¨volatileä¿®é¥°
static class Node<K,V> implements Map.Entry<K,V> {
    final int hash;
    final K key;
    volatile V val;          // volatileä¿è¯å¯è§æ€§
    volatile Node<K,V> next; // volatileä¿è¯å¯è§æ€§
}
```

2. **putæ“ä½œï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰**ï¼š
```java
public V put(K key, V value) {
    return putVal(key, value, false);
}

final V putVal(K key, V value, boolean onlyIfAbsent) {
    int hash = spread(key.hashCode());
    int binCount = 0;
    
    for (Node<K,V>[] tab = table;;) {
        Node<K,V> f; int n, i, fh;
        
        // 1. æ•°ç»„æœªåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–æ•°ç»„
        if (tab == null || (n = tab.length) == 0)
            tab = initTable();
        
        // 2. æ¡¶ä¸ºç©ºï¼Œä½¿ç”¨CASæ·»åŠ å…ƒç´ ï¼ˆæ— é”ï¼‰
        else if ((f = tabAt(tab, i = (n - 1) & hash)) == null) {
            if (casTabAt(tab, i, null, new Node<K,V>(hash, key, value, null)))
                break;  // CASæˆåŠŸï¼Œé€€å‡º
        }
        
        // 3. æ­£åœ¨æ‰©å®¹ï¼Œå¸®åŠ©æ‰©å®¹
        else if ((fh = f.hash) == MOVED)
            tab = helpTransfer(tab, f);
        
        // 4. æ¡¶ä¸ä¸ºç©ºï¼ŒåŠ é”æ“ä½œ
        else {
            V oldVal = null;
            synchronized (f) {  // é”ä½é“¾è¡¨å¤´èŠ‚ç‚¹
                if (tabAt(tab, i) == f) {
                    if (fh >= 0) {
                        // 4.1 é“¾è¡¨
                        binCount = 1;
                        for (Node<K,V> e = f;; ++binCount) {
                            K ek;
                            if (e.hash == hash &&
                                ((ek = e.key) == key ||
                                 (ek != null && key.equals(ek)))) {
                                oldVal = e.val;
                                if (!onlyIfAbsent)
                                    e.val = value;
                                break;
                            }
                            Node<K,V> pred = e;
                            if ((e = e.next) == null) {
                                pred.next = new Node<K,V>(hash, key,
                                                          value, null);
                                break;
                            }
                        }
                    }
                    else if (f instanceof TreeBin) {
                        // 4.2 çº¢é»‘æ ‘
                        Node<K,V> p;
                        binCount = 2;
                        if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,
                                                       value)) != null) {
                            oldVal = p.val;
                            if (!onlyIfAbsent)
                                p.val = value;
                        }
                    }
                }
            }
            
            // 5. åˆ¤æ–­æ˜¯å¦è½¬çº¢é»‘æ ‘
            if (binCount != 0) {
                if (binCount >= TREEIFY_THRESHOLD)
                    treeifyBin(tab, i);
                if (oldVal != null)
                    return oldVal;
                break;
            }
        }
    }
    
    // 6. å¢åŠ è®¡æ•°
    addCount(1L, binCount);
    return null;
}
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š

1. **CASï¼ˆæ— é”ï¼‰**ï¼š
```java
// æ¡¶ä¸ºç©ºæ—¶ï¼Œä½¿ç”¨CASæ·»åŠ å…ƒç´ ï¼ˆæ— é”ï¼Œé«˜æ€§èƒ½ï¼‰
static final <K,V> boolean casTabAt(Node<K,V>[] tab, int i,
                                     Node<K,V> c, Node<K,V> v) {
    return U.compareAndSwapObject(tab, ((long)i << ASHIFT) + ABASE, c, v);
}
```

2. **synchronizedï¼ˆé”ï¼‰**ï¼š
```java
// æ¡¶ä¸ä¸ºç©ºæ—¶ï¼Œé”ä½é“¾è¡¨å¤´èŠ‚ç‚¹ï¼ˆåªé”ä¸€ä¸ªæ¡¶ï¼Œä¸å½±å“å…¶ä»–æ¡¶ï¼‰
synchronized (f) {
    // é“¾è¡¨æ“ä½œ
}
```

3. **å¯¹æ¯”HashMapå’ŒConcurrentHashMap**ï¼š
```
HashMap:
âŒ ä¸åŠ é”ï¼Œçº¿ç¨‹ä¸å®‰å…¨
âœ… æ€§èƒ½æœ€å¥½ï¼ˆå•çº¿ç¨‹ï¼‰

ConcurrentHashMap:
âœ… åˆ†æ®µåŠ é”ï¼Œçº¿ç¨‹å®‰å…¨
âœ… å¹¶å‘æ€§èƒ½å¥½
âœ… é”ç²’åº¦ç»†ï¼ˆåªé”ä¸€ä¸ªæ¡¶ï¼‰

Hashtable:
âŒ å…¨è¡¨åŠ é”ï¼ˆsynchronizedæ–¹æ³•ï¼‰
âŒ å¹¶å‘æ€§èƒ½å·®
âŒ å·²è¿‡æ—¶
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

```
å¹¶å‘å†™å…¥1000ä¸‡æ¬¡ï¼š

HashMapï¼ˆå•çº¿ç¨‹ï¼‰:         1000ms
ConcurrentHashMapï¼ˆ8çº¿ç¨‹ï¼‰: 1500ms
Hashtableï¼ˆ8çº¿ç¨‹ï¼‰:        8000ms
```

**ä½¿ç”¨åœºæ™¯**ï¼š

```java
// å•çº¿ç¨‹
Map<String, String> map = new HashMap<>();

// å¤šçº¿ç¨‹
Map<String, String> map = new ConcurrentHashMap<>();

// éœ€è¦æœ‰åºï¼ˆå¤šçº¿ç¨‹ï¼‰
Map<String, String> map = new ConcurrentSkipListMap<>();
```

---

### 2.3 è¯´è¯´JVMå†…å­˜æ¨¡å‹å’Œåƒåœ¾å›æ”¶

**æ ‡å‡†å›ç­”**ï¼š

**JVMå†…å­˜æ¨¡å‹**ï¼š

```
å †ï¼ˆHeapï¼‰ï¼š
â”œâ”€â”€ æ–°ç”Ÿä»£ï¼ˆYoung Generationï¼‰
â”‚   â”œâ”€â”€ EdenåŒºï¼ˆ80%ï¼‰
â”‚   â”œâ”€â”€ Survivor0ï¼ˆFromï¼Œ10%ï¼‰
â”‚   â””â”€â”€ Survivor1ï¼ˆToï¼Œ10%ï¼‰
â””â”€â”€ è€å¹´ä»£ï¼ˆOld Generationï¼‰

æ–¹æ³•åŒºï¼ˆMethod Area / Metaspaceï¼‰ï¼š
â”œâ”€â”€ ç±»ä¿¡æ¯
â”œâ”€â”€ å¸¸é‡æ± 
â””â”€â”€ é™æ€å˜é‡

ç¨‹åºè®¡æ•°å™¨ï¼ˆPC Registerï¼‰
è™šæ‹Ÿæœºæ ˆï¼ˆVM Stackï¼‰
æœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰
```

**å †å†…å­˜è¯¦è§£**ï¼š

```
1. EdenåŒºï¼ˆæ–°å¯¹è±¡åˆ†é…ï¼‰ï¼š
   - å¤§éƒ¨åˆ†å¯¹è±¡åˆ›å»ºåœ¨è¿™é‡Œ
   - æ»¡äº†è§¦å‘Minor GC

2. SurvivoråŒºï¼ˆå­˜æ´»å¯¹è±¡ï¼‰ï¼š
   - ç»è¿‡Minor GCå­˜æ´»çš„å¯¹è±¡
   - Fromå’ŒToäº¤æ›¿ä½¿ç”¨
   - é»˜è®¤ç»è¿‡15æ¬¡GCåæ™‹å‡åˆ°è€å¹´ä»£

3. è€å¹´ä»£ï¼ˆé•¿æœŸå­˜æ´»å¯¹è±¡ï¼‰ï¼š
   - å¤§å¯¹è±¡ç›´æ¥åˆ†é…
   - ç»è¿‡å¤šæ¬¡GCçš„å¯¹è±¡
   - æ»¡äº†è§¦å‘Full GC
```

**åƒåœ¾å›æ”¶ç®—æ³•**ï¼š

1. **æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰**ï¼š
```
æ­¥éª¤ï¼š
1. æ ‡è®°ï¼šæ ‡è®°æ‰€æœ‰å­˜æ´»å¯¹è±¡
2. æ¸…é™¤ï¼šæ¸…é™¤æœªæ ‡è®°å¯¹è±¡

ç¼ºç‚¹ï¼š
âŒ äº§ç”Ÿå†…å­˜ç¢ç‰‡
âŒ æ•ˆç‡ä½ï¼ˆä¸¤æ¬¡éå†ï¼‰

é€‚ç”¨ï¼šè€å¹´ä»£
```

2. **å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰**ï¼š
```
æ­¥éª¤ï¼š
1. å°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€å—å†…å­˜
2. æ¸…ç©ºåŸå†…å­˜

ä¼˜ç‚¹ï¼š
âœ… æ²¡æœ‰å†…å­˜ç¢ç‰‡
âœ… æ•ˆç‡é«˜

ç¼ºç‚¹ï¼š
âŒ æµªè´¹50%ç©ºé—´

é€‚ç”¨ï¼šæ–°ç”Ÿä»£ï¼ˆEden + Survivorï¼‰
```

3. **æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰**ï¼š
```
æ­¥éª¤ï¼š
1. æ ‡è®°ï¼šæ ‡è®°æ‰€æœ‰å­˜æ´»å¯¹è±¡
2. æ•´ç†ï¼šå°†å­˜æ´»å¯¹è±¡ç§»åˆ°ä¸€ç«¯
3. æ¸…é™¤ï¼šæ¸…é™¤è¾¹ç•Œå¤–çš„å¯¹è±¡

ä¼˜ç‚¹ï¼š
âœ… æ²¡æœ‰å†…å­˜ç¢ç‰‡
âœ… ä¸æµªè´¹ç©ºé—´

ç¼ºç‚¹ï¼š
âŒ æ•ˆç‡ä½ï¼ˆéœ€è¦ç§»åŠ¨å¯¹è±¡ï¼‰

é€‚ç”¨ï¼šè€å¹´ä»£
```

**åƒåœ¾æ”¶é›†å™¨**ï¼š

1. **Serialæ”¶é›†å™¨ï¼ˆå•çº¿ç¨‹ï¼‰**ï¼š
```
æ–°ç”Ÿä»£ï¼šSerial
è€å¹´ä»£ï¼šSerial Old

ç‰¹ç‚¹ï¼š
- å•çº¿ç¨‹
- Stop The World
- é€‚åˆClientæ¨¡å¼

å‚æ•°ï¼š-XX:+UseSerialGC
```

2. **Parallelæ”¶é›†å™¨ï¼ˆå¤šçº¿ç¨‹ï¼‰**ï¼š
```
æ–°ç”Ÿä»£ï¼šParallel Scavenge
è€å¹´ä»£ï¼šParallel Old

ç‰¹ç‚¹ï¼š
- å¤šçº¿ç¨‹
- ååé‡ä¼˜å…ˆ
- é€‚åˆåå°è®¡ç®—

å‚æ•°ï¼š-XX:+UseParallelGC
```

3. **CMSæ”¶é›†å™¨ï¼ˆå¹¶å‘ï¼‰**ï¼š
```
è€å¹´ä»£ï¼šCMSï¼ˆConcurrent Mark Sweepï¼‰

ç‰¹ç‚¹ï¼š
- å¹¶å‘æ”¶é›†
- åœé¡¿æ—¶é—´çŸ­
- é€‚åˆå“åº”æ—¶é—´è¦æ±‚é«˜çš„åº”ç”¨

ç¼ºç‚¹ï¼š
- äº§ç”Ÿå†…å­˜ç¢ç‰‡
- CPUèµ„æºæ•æ„Ÿ

å‚æ•°ï¼š-XX:+UseConcMarkSweepGC
```

4. **G1æ”¶é›†å™¨ï¼ˆæ¨èï¼‰**ï¼š
```
æ–°ç”Ÿä»£ + è€å¹´ä»£

ç‰¹ç‚¹ï¼š
- åˆ†åŒºåŸŸæ”¶é›†
- å¯é¢„æµ‹åœé¡¿æ—¶é—´
- æ²¡æœ‰å†…å­˜ç¢ç‰‡
- é€‚åˆå¤§å †å†…å­˜ï¼ˆ>4GBï¼‰

å‚æ•°ï¼š-XX:+UseG1GC
```

**æˆ‘ä»¬é¡¹ç›®ä¸­çš„JVMé…ç½®**ï¼š

```bash
java -jar order-service.jar \
  -Xms512m \              # åˆå§‹å †512MB
  -Xmx512m \              # æœ€å¤§å †512MBï¼ˆä¸åˆå§‹å †ç›¸åŒï¼Œé¿å…æ‰©å®¹ï¼‰
  -Xmn256m \              # æ–°ç”Ÿä»£256MB
  -XX:+UseG1GC \          # ä½¿ç”¨G1æ”¶é›†å™¨
  -XX:MaxGCPauseMillis=200 \  # æœ€å¤§åœé¡¿200ms
  -XX:+HeapDumpOnOutOfMemoryError \  # OOMæ—¶ç”Ÿæˆå †è½¬å‚¨
  -XX:HeapDumpPath=/tmp/heapdump.hprof \
  -XX:+PrintGCDetails \   # æ‰“å°GCæ—¥å¿—
  -XX:+PrintGCDateStamps \
  -Xloggc:/tmp/gc.log
```

**GCè°ƒä¼˜å®æˆ˜**ï¼š

é—®é¢˜ï¼šFull GCé¢‘ç¹ï¼Œæ¯æ¬¡åœé¡¿1-2ç§’

æ’æŸ¥ï¼š
```bash
# 1. æŸ¥çœ‹GCæ—¥å¿—
tail -f gc.log

# 2. å‘ç°è€å¹´ä»£å ç”¨ç‡90%+ï¼Œé¢‘ç¹Full GC
# 3. ä½¿ç”¨jmapç”Ÿæˆå †è½¬å‚¨
jmap -dump:live,format=b,file=heapdump.hprof <pid>

# 4. ä½¿ç”¨MATåˆ†æ
# å‘ç°ç¼“å­˜å ç”¨2GBï¼ˆæœ¬åœ°ç¼“å­˜æ²¡æœ‰é™åˆ¶å¤§å°ï¼‰

# 5. è§£å†³æ–¹æ¡ˆ
# é™åˆ¶ç¼“å­˜å¤§å°10000æ¡ï¼Œé—®é¢˜è§£å†³
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šSpringæ¡†æ¶

### 3.1 Spring Beançš„ç”Ÿå‘½å‘¨æœŸ

**æ ‡å‡†å›ç­”**ï¼š

Spring Beançš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥åˆ†ä¸º4ä¸ªé˜¶æ®µï¼šå®ä¾‹åŒ–ã€å±æ€§èµ‹å€¼ã€åˆå§‹åŒ–ã€é”€æ¯ã€‚

**å®Œæ•´æµç¨‹**ï¼š

```
1. å®ä¾‹åŒ–ï¼ˆInstantiationï¼‰
   â†“
2. å±æ€§èµ‹å€¼ï¼ˆPopulateï¼‰
   â†“
3. åˆå§‹åŒ–ï¼ˆInitializationï¼‰
   â”œâ”€â”€ Awareæ¥å£å›è°ƒï¼ˆBeanNameAwareã€ApplicationContextAwareç­‰ï¼‰
   â”œâ”€â”€ BeanPostProcessorå‰ç½®å¤„ç†ï¼ˆ@PostConstructï¼‰
   â”œâ”€â”€ InitializingBeançš„afterPropertiesSet()
   â”œâ”€â”€ è‡ªå®šä¹‰init-method
   â””â”€â”€ BeanPostProcessoråç½®å¤„ç†ï¼ˆAOPä»£ç†ï¼‰
   â†“
4. ä½¿ç”¨Bean
   â†“
5. é”€æ¯ï¼ˆDestructionï¼‰
   â”œâ”€â”€ @PreDestroy
   â”œâ”€â”€ DisposableBeançš„destroy()
   â””â”€â”€ è‡ªå®šä¹‰destroy-method
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
@Component
public class OrderService implements BeanNameAware, 
                                    ApplicationContextAware,
                                    InitializingBean,
                                    DisposableBean {
    
    private String beanName;
    private ApplicationContext applicationContext;
    
    @Autowired
    private OrderRepository orderRepository;
    
    // 1. æ„é€ å‡½æ•°ï¼ˆå®ä¾‹åŒ–ï¼‰
    public OrderService() {
        System.out.println("1. æ„é€ å‡½æ•°æ‰§è¡Œ");
    }
    
    // 2. å±æ€§èµ‹å€¼ï¼ˆ@Autowiredï¼‰
    // orderRepositoryæ³¨å…¥
    
    // 3. Awareæ¥å£å›è°ƒ
    @Override
    public void setBeanName(String name) {
        this.beanName = name;
        System.out.println("2. BeanNameAware: " + name);
    }
    
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) {
        this.applicationContext = applicationContext;
        System.out.println("3. ApplicationContextAware");
    }
    
    // 4. @PostConstructï¼ˆæ¨èï¼‰
    @PostConstruct
    public void init() {
        System.out.println("4. @PostConstructæ‰§è¡Œ");
    }
    
    // 5. InitializingBeanæ¥å£
    @Override
    public void afterPropertiesSet() throws Exception {
        System.out.println("5. InitializingBean.afterPropertiesSet()æ‰§è¡Œ");
    }
    
    // 6. è‡ªå®šä¹‰init-method
    public void customInit() {
        System.out.println("6. è‡ªå®šä¹‰init-methodæ‰§è¡Œ");
    }
    
    // 7. ä½¿ç”¨Bean
    public void doSomething() {
        System.out.println("7. Beanæ­£å¸¸ä½¿ç”¨");
    }
    
    // 8. @PreDestroyï¼ˆæ¨èï¼‰
    @PreDestroy
    public void preDestroy() {
        System.out.println("8. @PreDestroyæ‰§è¡Œ");
    }
    
    // 9. DisposableBeanæ¥å£
    @Override
    public void destroy() throws Exception {
        System.out.println("9. DisposableBean.destroy()æ‰§è¡Œ");
    }
    
    // 10. è‡ªå®šä¹‰destroy-method
    public void customDestroy() {
        System.out.println("10. è‡ªå®šä¹‰destroy-methodæ‰§è¡Œ");
    }
}

// é…ç½®ç±»
@Configuration
public class BeanConfig {
    
    @Bean(initMethod = "customInit", destroyMethod = "customDestroy")
    public OrderService orderService() {
        return new OrderService();
    }
}
```

**è¾“å‡ºç»“æœ**ï¼š

```
1. æ„é€ å‡½æ•°æ‰§è¡Œ
2. BeanNameAware: orderService
3. ApplicationContextAware
4. @PostConstructæ‰§è¡Œ
5. InitializingBean.afterPropertiesSet()æ‰§è¡Œ
6. è‡ªå®šä¹‰init-methodæ‰§è¡Œ
7. Beanæ­£å¸¸ä½¿ç”¨
8. @PreDestroyæ‰§è¡Œ
9. DisposableBean.destroy()æ‰§è¡Œ
10. è‡ªå®šä¹‰destroy-methodæ‰§è¡Œ
```

**æœ€ä½³å®è·µ**ï¼š

```java
// æ¨èä½¿ç”¨æ³¨è§£æ–¹å¼
@Component
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    // åˆå§‹åŒ–
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–é€»è¾‘
    }
    
    // é”€æ¯
    @PreDestroy
    public void destroy() {
        // æ¸…ç†é€»è¾‘
    }
}
```

---

### 3.2 Springäº‹åŠ¡ä¼ æ’­æœºåˆ¶

**æ ‡å‡†å›ç­”**ï¼š

Springå®šä¹‰äº†7ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼Œå¸¸ç”¨çš„æœ‰3ç§ã€‚

**7ç§ä¼ æ’­è¡Œä¸º**ï¼š

```java
1. REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼š
   - æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±æ–°å»º
   - æœ€å¸¸ç”¨

2. REQUIRES_NEWï¼š
   - æ€»æ˜¯æ–°å»ºäº‹åŠ¡ï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡
   - ç”¨äºç‹¬ç«‹äº‹åŠ¡

3. SUPPORTSï¼š
   - æœ‰äº‹åŠ¡å°±åŠ å…¥ï¼Œæ²¡æœ‰å°±ä»¥éäº‹åŠ¡æ‰§è¡Œ

4. NOT_SUPPORTEDï¼š
   - ä»¥éäº‹åŠ¡æ‰§è¡Œï¼ŒæŒ‚èµ·å½“å‰äº‹åŠ¡

5. MANDATORYï¼š
   - å¿…é¡»åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸

6. NEVERï¼š
   - ä¸èƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸

7. NESTEDï¼š
   - åµŒå¥—äº‹åŠ¡ï¼ˆä½¿ç”¨Savepointï¼‰
```

**æ ¸å¿ƒåœºæ™¯ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private LogService logService;
    
    // åœºæ™¯1ï¼šREQUIREDï¼ˆé»˜è®¤ï¼‰
    @Transactional(propagation = Propagation.REQUIRED)
    public void createOrder(OrderRequest request) {
        // 1. ä¿å­˜è®¢å•
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // 2. è®°å½•æ—¥å¿—ï¼ˆåŠ å…¥å½“å‰äº‹åŠ¡ï¼‰
        logService.saveLog("è®¢å•åˆ›å»º");  // ä½¿ç”¨åŒä¸€ä¸ªäº‹åŠ¡
        
        // å¦‚æœsaveLogæŠ›å¼‚å¸¸ï¼Œè®¢å•ä¹Ÿä¼šå›æ»š
    }
}

@Service
public class LogService {
    
    @Autowired
    private LogRepository logRepository;
    
    @Transactional(propagation = Propagation.REQUIRED)
    public void saveLog(String message) {
        Log log = new Log();
        log.setMessage(message);
        logRepository.save(log);
    }
}
```

**äº‹åŠ¡ä¼ æ’­æ¼”ç¤º**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private LogService logService;
    
    // åœºæ™¯2ï¼šREQUIRES_NEWï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
    @Transactional
    public void createOrder(OrderRequest request) {
        // 1. ä¿å­˜è®¢å•
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // 2. è®°å½•æ—¥å¿—ï¼ˆæ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼‰
        logService.saveLogWithNewTransaction("è®¢å•åˆ›å»º");
        
        // 3. æ¨¡æ‹Ÿå¼‚å¸¸
        throw new RuntimeException("è®¢å•ä¿å­˜å¤±è´¥");
        
        // ç»“æœï¼š
        // - è®¢å•å›æ»šï¼ˆäº‹åŠ¡1ï¼‰
        // - æ—¥å¿—ä¿å­˜æˆåŠŸï¼ˆäº‹åŠ¡2ï¼Œç‹¬ç«‹çš„ï¼‰
    }
}

@Service
public class LogService {
    
    @Autowired
    private LogRepository logRepository;
    
    // ä½¿ç”¨REQUIRES_NEWï¼šæ— è®ºå¤–éƒ¨æœ‰æ— äº‹åŠ¡ï¼Œéƒ½æ–°å»ºäº‹åŠ¡
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveLogWithNewTransaction(String message) {
        Log log = new Log();
        log.setMessage(message);
        logRepository.save(log);
    }
}
```

**å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private AuditLogService auditLogService;
    
    @Transactional(rollbackFor = Exception.class)
    public void createOrder(OrderRequest request) {
        try {
            // 1. åˆ›å»ºè®¢å•
            Order order = buildOrder(request);
            orderRepository.save(order);
            
            // 2. æ‰£å‡åº“å­˜
            inventoryService.deductStock(request.getProductId(), 
                                        request.getQuantity());
            
            // 3. è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼Œå³ä½¿è®¢å•å¤±è´¥ä¹Ÿè¦è®°å½•ï¼‰
            auditLogService.saveAuditLog("è®¢å•åˆ›å»º", order.getOrderNo());
            
        } catch (Exception e) {
            // 4. è®°å½•å¼‚å¸¸æ—¥å¿—ï¼ˆç‹¬ç«‹äº‹åŠ¡ï¼‰
            auditLogService.saveErrorLog("è®¢å•åˆ›å»ºå¤±è´¥", e.getMessage());
            throw e;
        }
    }
}

@Service
public class AuditLogService {
    
    @Autowired
    private AuditLogRepository auditLogRepository;
    
    // å®¡è®¡æ—¥å¿—ä½¿ç”¨ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸å—ä¸šåŠ¡äº‹åŠ¡å½±å“
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveAuditLog(String action, String orderNo) {
        AuditLog log = new AuditLog();
        log.setAction(action);
        log.setOrderNo(orderNo);
        log.setCreateTime(LocalDateTime.now());
        auditLogRepository.save(log);
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveErrorLog(String action, String error) {
        AuditLog log = new AuditLog();
        log.setAction(action);
        log.setError(error);
        log.setCreateTime(LocalDateTime.now());
        auditLogRepository.save(log);
    }
}
```

**æ³¨æ„äº‹é¡¹**ï¼š

1. **äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„åœºæ™¯**ï¼š
```java
// âŒ é”™è¯¯1ï¼šæ–¹æ³•ä¸æ˜¯public
@Transactional
private void createOrder() {  // äº‹åŠ¡ä¸ç”Ÿæ•ˆ
}

// âŒ é”™è¯¯2ï¼šåŒç±»æ–¹æ³•è°ƒç”¨
@Service
public class OrderService {
    
    @Transactional
    public void createOrder() {
        saveOrder();  // ç›´æ¥è°ƒç”¨ï¼Œäº‹åŠ¡ä¸ç”Ÿæ•ˆ
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveOrder() {
        // ä¸ä¼šæ–°å»ºäº‹åŠ¡
    }
}

// âœ… æ­£ç¡®ï¼šæ³¨å…¥è‡ªå·±
@Service
public class OrderService {
    
    @Autowired
    private OrderService self;  // æ³¨å…¥è‡ªå·±
    
    @Transactional
    public void createOrder() {
        self.saveOrder();  // é€šè¿‡ä»£ç†è°ƒç”¨ï¼Œäº‹åŠ¡ç”Ÿæ•ˆ
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void saveOrder() {
        // æ–°å»ºäº‹åŠ¡æˆåŠŸ
    }
}
```

2. **å¼‚å¸¸ç±»å‹**ï¼š
```java
// é»˜è®¤åªå›æ»šRuntimeExceptionå’ŒError
@Transactional
public void createOrder() throws Exception {
    // æŠ›å‡ºExceptionä¸ä¼šå›æ»š
    throw new Exception("é”™è¯¯");
}

// æ¨èï¼šæŒ‡å®šå›æ»šæ‰€æœ‰å¼‚å¸¸
@Transactional(rollbackFor = Exception.class)
public void createOrder() throws Exception {
    // æŠ›å‡ºExceptionä¼šå›æ»š
    throw new Exception("é”™è¯¯");
}
```

---

### 3.3 Spring AOPçš„åŸç†

**æ ‡å‡†å›ç­”**ï¼š

Spring AOPä½¿ç”¨**åŠ¨æ€ä»£ç†**å®ç°ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼šJDKåŠ¨æ€ä»£ç†å’ŒCGLIBä»£ç†ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
åˆ‡é¢ï¼ˆAspectï¼‰ï¼š     æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—åŒ–
è¿æ¥ç‚¹ï¼ˆJoinPointï¼‰ï¼š æ–¹æ³•æ‰§è¡Œæ—¶çš„ç‚¹
åˆ‡å…¥ç‚¹ï¼ˆPointcutï¼‰ï¼š  åŒ¹é…è¿æ¥ç‚¹çš„è¡¨è¾¾å¼
é€šçŸ¥ï¼ˆAdviceï¼‰ï¼š     åœ¨åˆ‡å…¥ç‚¹æ‰§è¡Œçš„ä»£ç 
ç»‡å…¥ï¼ˆWeavingï¼‰ï¼š    å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡
```

**ä¸¤ç§ä»£ç†æ–¹å¼**ï¼š

1. **JDKåŠ¨æ€ä»£ç†**ï¼ˆåŸºäºæ¥å£ï¼‰ï¼š

```java
// æ¥å£
public interface OrderService {
    void createOrder(OrderRequest request);
}

// å®ç°ç±»
@Service
public class OrderServiceImpl implements OrderService {
    
    @Override
    public void createOrder(OrderRequest request) {
        System.out.println("åˆ›å»ºè®¢å•");
    }
}

// Springä¼šç”Ÿæˆä»£ç†ç±»
public class OrderServiceProxy implements OrderService {
    
    private OrderService target;
    
    @Override
    public void createOrder(OrderRequest request) {
        // å‰ç½®é€šçŸ¥
        System.out.println("è®°å½•æ—¥å¿—");
        
        // æ‰§è¡Œç›®æ ‡æ–¹æ³•
        target.createOrder(request);
        
        // åç½®é€šçŸ¥
        System.out.println("æ–¹æ³•æ‰§è¡Œå®Œæˆ");
    }
}
```

2. **CGLIBä»£ç†**ï¼ˆåŸºäºç±»ï¼‰ï¼š

```java
// æ²¡æœ‰æ¥å£ï¼Œç›´æ¥æ˜¯ç±»
@Service
public class OrderService {
    
    public void createOrder(OrderRequest request) {
        System.out.println("åˆ›å»ºè®¢å•");
    }
}

// Springä½¿ç”¨CGLIBç”Ÿæˆå­ç±»
public class OrderService$$EnhancerByCGLIB extends OrderService {
    
    @Override
    public void createOrder(OrderRequest request) {
        // å‰ç½®é€šçŸ¥
        System.out.println("è®°å½•æ—¥å¿—");
        
        // æ‰§è¡Œç›®æ ‡æ–¹æ³•
        super.createOrder(request);
        
        // åç½®é€šçŸ¥
        System.out.println("æ–¹æ³•æ‰§è¡Œå®Œæˆ");
    }
}
```

**AOPå®æˆ˜ç¤ºä¾‹ - æ—¥å¿—åˆ‡é¢**ï¼š

```java
/**
 * æ—¥å¿—åˆ‡é¢
 */
@Aspect
@Component
@Slf4j
public class LogAspect {
    
    /**
     * åˆ‡å…¥ç‚¹ï¼šæ‰€æœ‰Controllerçš„å…¬å…±æ–¹æ³•
     */
    @Pointcut("execution(public * com.demo.*.controller..*.*(..))")
    public void controllerLog() {}
    
    /**
     * ç¯ç»•é€šçŸ¥ï¼šè®°å½•è¯·æ±‚æ—¥å¿—
     */
    @Around("controllerLog()")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        // è·å–è¯·æ±‚ä¿¡æ¯
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        
        String method = request.getMethod();
        String url = request.getRequestURI();
        String className = point.getSignature().getDeclaringTypeName();
        String methodName = point.getSignature().getName();
        Object[] args = point.getArgs();
        
        // è®°å½•è¯·æ±‚æ—¥å¿—
        log.info("è¯·æ±‚å¼€å§‹ => method={}, url={}, class={}, method={}, args={}", 
                 method, url, className, methodName, JSON.toJSONString(args));
        
        Object result;
        try {
            // æ‰§è¡Œæ–¹æ³•
            result = point.proceed();
            
            long duration = System.currentTimeMillis() - startTime;
            
            // è®°å½•å“åº”æ—¥å¿—
            log.info("è¯·æ±‚ç»“æŸ => method={}, url={}, duration={}ms, result={}", 
                     method, url, duration, JSON.toJSONString(result));
            
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            
            // è®°å½•å¼‚å¸¸æ—¥å¿—
            log.error("è¯·æ±‚å¼‚å¸¸ => method={}, url={}, duration={}ms, error={}", 
                      method, url, duration, e.getMessage(), e);
            
            throw e;
        }
        
        return result;
    }
}
```

**å®é™…åº”ç”¨**ï¼š

```java
// 1. æƒé™æ ¡éªŒåˆ‡é¢
@Aspect
@Component
public class AuthAspect {
    
    @Around("@annotation(requiresPermission)")
    public Object checkPermission(ProceedingJoinPoint point, 
                                 RequiresPermission requiresPermission) throws Throwable {
        // è·å–å½“å‰ç”¨æˆ·
        User user = getCurrentUser();
        
        // æ£€æŸ¥æƒé™
        String permission = requiresPermission.value();
        if (!user.hasPermission(permission)) {
            throw new PermissionDeniedException("æ— æƒé™è®¿é—®");
        }
        
        // æ‰§è¡Œæ–¹æ³•
        return point.proceed();
    }
}

// ä½¿ç”¨
@RestController
public class OrderController {
    
    @GetMapping("/orders/{orderId}")
    @RequiresPermission("order:view")  // éœ€è¦æƒé™
    public Order getOrder(@PathVariable Long orderId) {
        return orderService.getOrderById(orderId);
    }
}

// 2. ç¼“å­˜åˆ‡é¢
@Aspect
@Component
public class CacheAspect {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Around("@annotation(cacheable)")
    public Object cache(ProceedingJoinPoint point, Cacheable cacheable) throws Throwable {
        // ç”Ÿæˆç¼“å­˜key
        String key = cacheable.key();
        
        // å°è¯•ä»ç¼“å­˜è·å–
        Object cached = redisTemplate.opsForValue().get(key);
        if (cached != null) {
            return cached;
        }
        
        // æ‰§è¡Œæ–¹æ³•
        Object result = point.proceed();
        
        // å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(key, result, 
                                       cacheable.expire(), TimeUnit.SECONDS);
        
        return result;
    }
}
```

**5ç§é€šçŸ¥ç±»å‹**ï¼š

```java
@Aspect
@Component
public class MyAspect {
    
    // 1. å‰ç½®é€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œå‰
    @Before("execution(* com.demo.service.*.*(..))")
    public void before(JoinPoint point) {
        System.out.println("å‰ç½®é€šçŸ¥");
    }
    
    // 2. åç½®é€šçŸ¥ï¼šæ–¹æ³•æ‰§è¡Œåï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
    @After("execution(* com.demo.service.*.*(..))")
    public void after(JoinPoint point) {
        System.out.println("åç½®é€šçŸ¥");
    }
    
    // 3. è¿”å›é€šçŸ¥ï¼šæ–¹æ³•æˆåŠŸæ‰§è¡Œå
    @AfterReturning(pointcut = "execution(* com.demo.service.*.*(..))", 
                    returning = "result")
    public void afterReturning(JoinPoint point, Object result) {
        System.out.println("è¿”å›é€šçŸ¥: " + result);
    }
    
    // 4. å¼‚å¸¸é€šçŸ¥ï¼šæ–¹æ³•æŠ›å¼‚å¸¸å
    @AfterThrowing(pointcut = "execution(* com.demo.service.*.*(..))", 
                   throwing = "ex")
    public void afterThrowing(JoinPoint point, Exception ex) {
        System.out.println("å¼‚å¸¸é€šçŸ¥: " + ex.getMessage());
    }
    
    // 5. ç¯ç»•é€šçŸ¥ï¼šæœ€å¼ºå¤§ï¼ŒåŒ…å«æ‰€æœ‰é€šçŸ¥
    @Around("execution(* com.demo.service.*.*(..))")
    public Object around(ProceedingJoinPoint point) throws Throwable {
        System.out.println("ç¯ç»•é€šçŸ¥ - å‰");
        Object result = point.proceed();
        System.out.println("ç¯ç»•é€šçŸ¥ - å");
        return result;
    }
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå¾®æœåŠ¡æŠ€æœ¯

### 4.1 Nacosæ³¨å†Œä¸­å¿ƒçš„åŸç†

**æ ‡å‡†å›ç­”**ï¼š

Nacosæ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼Œé‡‡ç”¨APæ¨¡å‹ï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š

1. **æœåŠ¡æ³¨å†Œä¸å‘ç°**
2. **é…ç½®ç®¡ç†**
3. **å¥åº·æ£€æŸ¥**
4. **åŠ¨æ€è·¯ç”±**

**æœåŠ¡æ³¨å†Œæµç¨‹**ï¼š

```
1. æœåŠ¡å¯åŠ¨
   â†“
2. æœåŠ¡å®ä¾‹ä¿¡æ¯æ³¨å†Œåˆ°Nacos
   - æœåŠ¡å
   - IPåœ°å€
   - ç«¯å£
   - å…ƒæ•°æ®
   â†“
3. Nacoså­˜å‚¨æœåŠ¡ä¿¡æ¯ï¼ˆå†…å­˜ + æŒä¹…åŒ–ï¼‰
   â†“
4. å®šæ—¶å¿ƒè·³ï¼ˆé»˜è®¤5ç§’ï¼‰
   â†“
5. å¥åº·æ£€æŸ¥
   - å¿ƒè·³è¶…æ—¶15ç§’ï¼šæ ‡è®°ä¸å¥åº·
   - å¿ƒè·³è¶…æ—¶30ç§’ï¼šå‰”é™¤å®ä¾‹
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
// æœåŠ¡æä¾›è€…
@SpringBootApplication
@EnableDiscoveryClient  // å¼€å¯æœåŠ¡æ³¨å†Œ
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

// application.yml
spring:
  application:
    name: order-service  # æœåŠ¡å
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848  # Nacosåœ°å€
        namespace: public
        group: DEFAULT_GROUP
        metadata:
          version: 1.0.0
          region: hangzhou

// æœåŠ¡æ¶ˆè´¹è€…
@FeignClient(name = "order-service")  // é€šè¿‡æœåŠ¡åè°ƒç”¨
public interface OrderClient {
    @GetMapping("/api/orders/{orderId}")
    Order getOrder(@PathVariable Long orderId);
}
```

**æœåŠ¡å‘ç°æµç¨‹**ï¼š

```
1. æœåŠ¡æ¶ˆè´¹è€…æŸ¥è¯¢Nacos
   â†“
2. Nacosè¿”å›æœåŠ¡å®ä¾‹åˆ—è¡¨
   - order-service: 192.168.1.10:8081
   - order-service: 192.168.1.11:8081
   â†“
3. å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼ˆRibbonï¼‰
   - è½®è¯¢
   - éšæœº
   - æœ€å°‘è¿æ¥
   â†“
4. è°ƒç”¨å…·ä½“å®ä¾‹
```

**ä¸Eurekaå¯¹æ¯”**ï¼š

```
Eurekaï¼ˆNetflixï¼Œå·²åœæ›´ï¼‰:
- APæ¨¡å‹ï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰
- æ— é…ç½®ä¸­å¿ƒ
- ç¤¾åŒºä¸æ´»è·ƒ

Nacosï¼ˆé˜¿é‡Œï¼‰:
- AP/CPå¯åˆ‡æ¢
- æœ‰é…ç½®ä¸­å¿ƒï¼ˆæ¨èï¼‰
- ç¤¾åŒºæ´»è·ƒ
- åŠŸèƒ½æ›´å¼ºå¤§

Consulï¼š
- CPæ¨¡å‹ï¼ˆä¸€è‡´æ€§ä¼˜å…ˆï¼‰
- æœ‰é…ç½®ä¸­å¿ƒ
- Goè¯­è¨€å¼€å‘
```

**Nacosé…ç½®ä¸­å¿ƒ**ï¼š

```java
// bootstrap.ymlï¼ˆä¼˜å…ˆçº§é«˜äºapplication.ymlï¼‰
spring:
  application:
    name: order-service
  cloud:
    nacos:
      config:
        server-addr: localhost:8848
        file-extension: yaml
        namespace: public
        group: DEFAULT_GROUP

// ä½¿ç”¨é…ç½®
@RestController
@RefreshScope  // æ”¯æŒåŠ¨æ€åˆ·æ–°
public class OrderController {
    
    @Value("${order.timeout:30}")  // ä»Nacosè·å–é…ç½®
    private Integer timeout;
    
    @GetMapping("/config")
    public String getConfig() {
        return "timeout=" + timeout;
    }
}
```

**åŠ¨æ€é…ç½®åˆ·æ–°**ï¼š

```
1. åœ¨Nacosæ§åˆ¶å°ä¿®æ”¹é…ç½®
   â†“
2. Nacosæ¨é€é…ç½®å˜æ›´ï¼ˆé•¿è½®è¯¢ï¼‰
   â†“
3. å®¢æˆ·ç«¯æ”¶åˆ°å˜æ›´é€šçŸ¥
   â†“
4. @RefreshScope Beané‡æ–°åˆ›å»º
   â†“
5. é…ç½®ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯ï¼‰
```

---

### 4.2 Sentinelé™æµé™çº§çš„åŸç†

**æ ‡å‡†å›ç­”**ï¼š

Sentinelæ˜¯é˜¿é‡Œå¼€æºçš„æµé‡æ§åˆ¶æ¡†æ¶ï¼Œæä¾›é™æµã€ç†”æ–­ã€é™çº§ç­‰åŠŸèƒ½ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
èµ„æºï¼ˆResourceï¼‰ï¼š    éœ€è¦ä¿æŠ¤çš„ä»£ç 
è§„åˆ™ï¼ˆRuleï¼‰ï¼š       é™æµã€ç†”æ–­è§„åˆ™
æ§½é“¾ï¼ˆSlot Chainï¼‰ï¼š è´£ä»»é“¾æ¨¡å¼å¤„ç†è¯·æ±‚
```

**é™æµè§„åˆ™**ï¼š

1. **QPSé™æµ**ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š

```java
// é…ç½®é™æµè§„åˆ™
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initFlowRules() {
        List<FlowRule> rules = new ArrayList<>();
        
        FlowRule rule = new FlowRule();
        rule.setResource("createOrder");  // èµ„æºå
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);  // QPSé™æµ
        rule.setCount(100);  // æ¯ç§’æœ€å¤š100æ¬¡
        
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
    }
}

// ä½¿ç”¨
@Service
public class OrderService {
    
    @SentinelResource(value = "createOrder",
                     blockHandler = "createOrderBlockHandler")
    public Order createOrder(OrderRequest request) {
        // ä¸šåŠ¡é€»è¾‘
        return order;
    }
    
    // é™æµåçš„å¤„ç†æ–¹æ³•
    public Order createOrderBlockHandler(OrderRequest request, BlockException ex) {
        throw new BusinessException(ErrorCode.SYSTEM_BUSY, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

2. **çº¿ç¨‹æ•°é™æµ**ï¼š

```java
FlowRule rule = new FlowRule();
rule.setResource("createOrder");
rule.setGrade(RuleConstant.FLOW_GRADE_THREAD);  // çº¿ç¨‹æ•°é™æµ
rule.setCount(10);  // æœ€å¤š10ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ
```

**ç†”æ–­è§„åˆ™**ï¼š

```java
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initDegradeRules() {
        List<DegradeRule> rules = new ArrayList<>();
        
        // æ…¢è°ƒç”¨æ¯”ä¾‹ç†”æ–­
        DegradeRule rule = new DegradeRule();
        rule.setResource("inventoryService");
        rule.setGrade(CircuitBreakerStrategy.SLOW_REQUEST_RATIO.getType());
        rule.setCount(0.5);  // æ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼50%
        rule.setTimeWindow(10);  // ç†”æ–­æ—¶é•¿10ç§’
        rule.setSlowRatioThreshold(1000);  // æ…¢è°ƒç”¨é˜ˆå€¼1ç§’
        rule.setMinRequestAmount(5);  // æœ€å°è¯·æ±‚æ•°5
        
        rules.add(rule);
        DegradeRuleManager.loadRules(rules);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryClient inventoryClient;
    
    @SentinelResource(value = "createOrder",
                     blockHandler = "createOrderBlockHandler",  // é™æµé™çº§
                     fallback = "createOrderFallback")         // å¼‚å¸¸é™çº§
    public Order createOrder(OrderRequest request) {
        // 1. æ£€æŸ¥åº“å­˜ï¼ˆå¯èƒ½è¢«ç†”æ–­ï¼‰
        Integer stock = inventoryClient.getStock(request.getProductId());
        
        if (stock < request.getQuantity()) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        // 2. åˆ›å»ºè®¢å•
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        return order;
    }
    
    // é™æµåçš„é™çº§æ–¹æ³•
    public Order createOrderBlockHandler(OrderRequest request, BlockException ex) {
        log.warn("è®¢å•åˆ›å»ºé™æµ, userId={}", request.getUserId());
        throw new BusinessException(ErrorCode.SYSTEM_BUSY, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    // å¼‚å¸¸åçš„é™çº§æ–¹æ³•
    public Order createOrderFallback(OrderRequest request, Throwable ex) {
        log.error("è®¢å•åˆ›å»ºå¤±è´¥, userId={}, error={}", 
                  request.getUserId(), ex.getMessage(), ex);
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    }
}
```

**Sentinelæ§åˆ¶å°**ï¼š

```bash
# å¯åŠ¨Sentinel Dashboard
java -Dserver.port=8080 \
     -Dcsp.sentinel.dashboard.server=localhost:8080 \
     -jar sentinel-dashboard.jar

# è®¿é—®ï¼šhttp://localhost:8080
# ç”¨æˆ·å/å¯†ç ï¼šsentinel/sentinel

# åœ¨æ§åˆ¶å°é…ç½®è§„åˆ™ï¼š
1. æµæ§è§„åˆ™ï¼ˆé™æµï¼‰
2. ç†”æ–­è§„åˆ™ï¼ˆç†”æ–­ï¼‰
3. çƒ­ç‚¹è§„åˆ™ï¼ˆçƒ­ç‚¹å‚æ•°é™æµï¼‰
4. ç³»ç»Ÿè§„åˆ™ï¼ˆç³»ç»Ÿä¿æŠ¤ï¼‰
5. æˆæƒè§„åˆ™ï¼ˆé»‘ç™½åå•ï¼‰
```

**å®æ—¶ç›‘æ§**ï¼š

```
Sentinelæ§åˆ¶å°å¯ä»¥å®æ—¶æŸ¥çœ‹ï¼š
- QPS
- é€šè¿‡æ•°
- æ‹’ç»æ•°
- å¼‚å¸¸æ•°
- å“åº”æ—¶é—´
```

---

### 4.3 å¦‚ä½•ä¿è¯æ¥å£å¹‚ç­‰æ€§ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æ¥å£å¹‚ç­‰æ€§æ˜¯æŒ‡åŒä¸€ä¸ªè¯·æ±‚å¤šæ¬¡è°ƒç”¨ï¼Œç»“æœä¸€è‡´ã€‚å¸¸è§åœºæ™¯ï¼šè®¢å•åˆ›å»ºã€æ”¯ä»˜ã€é€€æ¬¾ç­‰ã€‚

**å®ç°æ–¹æ¡ˆ**ï¼š

**1. å”¯ä¸€ç´¢å¼•ï¼ˆæ•°æ®åº“å±‚é¢ï¼‰**ï¼š

```sql
-- è®¢å•è¡¨ï¼Œè®¢å•å·å”¯ä¸€
CREATE TABLE t_order (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(64) NOT NULL UNIQUE,  -- å”¯ä¸€ç´¢å¼•
    ...
);

-- æ’å…¥è®¢å•
INSERT INTO t_order (order_no, user_id, ...) 
VALUES ('ORD202501010001', 1001, ...);

-- é‡å¤æ’å…¥ä¼šæŠ¥é”™ï¼ˆå”¯ä¸€çº¦æŸå†²çªï¼‰
```

**2. Tokenæœºåˆ¶ï¼ˆæ¨èï¼‰**ï¼š

```java
// 1. è·å–Token
@GetMapping("/order/token")
public ApiResponse<String> getOrderToken() {
    // ç”Ÿæˆå”¯ä¸€Token
    String token = UUID.randomUUID().toString();
    
    // å­˜å…¥Redisï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
    redisTemplate.opsForValue().set("order:token:" + token, "1", 5, TimeUnit.MINUTES);
    
    return ApiResponse.success(token);
}

// 2. æäº¤è®¢å•ï¼ˆä½¿ç”¨Tokenï¼‰
@PostMapping("/orders")
public ApiResponse<OrderResponse> createOrder(@RequestBody OrderRequest request,
                                              @RequestHeader("X-Order-Token") String token) {
    // éªŒè¯Token
    String key = "order:token:" + token;
    
    // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼ˆåˆ¤æ–­+åˆ é™¤ï¼‰
    String script = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                   "return redis.call('del', KEYS[1]) else return 0 end";
    
    Long result = redisTemplate.execute(
        new DefaultRedisScript<>(script, Long.class),
        Collections.singletonList(key),
        "1"
    );
    
    if (result == 0) {
        throw new BusinessException(ErrorCode.DUPLICATE_REQUEST, "é‡å¤è¯·æ±‚");
    }
    
    // åˆ›å»ºè®¢å•
    OrderResponse response = orderService.createOrder(request);
    
    return ApiResponse.success(response);
}
```

**3. çŠ¶æ€æœºï¼ˆè®¢å•çŠ¶æ€ï¼‰**ï¼š

```java
@Service
public class OrderService {
    
    @Transactional(rollbackFor = Exception.class)
    public void payOrder(Long orderId) {
        // 1. æŸ¥è¯¢è®¢å•
        Order order = getOrderById(orderId);
        
        // 2. æ£€æŸ¥è®¢å•çŠ¶æ€ï¼ˆåªæœ‰å¾…æ”¯ä»˜çŠ¶æ€æ‰èƒ½æ”¯ä»˜ï¼‰
        if (order.getStatus() != OrderStatus.PENDING) {
            throw new BusinessException(ErrorCode.ORDER_STATUS_ERROR, 
                                      "è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜");
        }
        
        // 3. æ›´æ–°è®¢å•çŠ¶æ€
        order.setStatus(OrderStatus.PAID);
        orderRepository.save(order);
        
        // é‡å¤è°ƒç”¨ä¼šå› ä¸ºçŠ¶æ€æ£€æŸ¥å¤±è´¥
    }
}
```

**4. åˆ†å¸ƒå¼é”ï¼ˆRedisï¼‰**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void createOrder(OrderRequest request) {
        // ä½¿ç”¨ç”¨æˆ·IDä½œä¸ºé”keyï¼ˆåŒä¸€ç”¨æˆ·ä¸èƒ½å¹¶å‘åˆ›å»ºè®¢å•ï¼‰
        String lockKey = "order:create:" + request.getUserId();
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•åŠ é”ï¼ˆç­‰å¾…3ç§’ï¼Œé”10ç§’è‡ªåŠ¨é‡Šæ”¾ï¼‰
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®¢å•ï¼ˆæŸ¥è¯¢æœ€è¿‘1åˆ†é’Ÿçš„è®¢å•ï¼‰
                Order existOrder = orderRepository.findRecentOrder(
                    request.getUserId(),
                    request.getProductId(),
                    LocalDateTime.now().minusMinutes(1)
                );
                
                if (existOrder != null) {
                    throw new BusinessException(ErrorCode.DUPLICATE_ORDER, "è®¢å•å·²å­˜åœ¨");
                }
                
                // 2. åˆ›å»ºè®¢å•
                Order order = buildOrder(request);
                orderRepository.save(order);
            } else {
                throw new BusinessException(ErrorCode.SYSTEM_BUSY, "ç³»ç»Ÿç¹å¿™");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
        } finally {
            // é‡Šæ”¾é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

**5. ä¹è§‚é”ï¼ˆç‰ˆæœ¬å·ï¼‰**ï¼š

```java
@Entity
@Table(name = "t_inventory")
public class Inventory {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private Long productId;
    
    private Integer stock;
    
    @Version  // ä¹è§‚é”ç‰ˆæœ¬å·
    private Integer version;
}

@Service
public class InventoryService {
    
    @Transactional(rollbackFor = Exception.class)
    public void deductStock(Long productId, Integer quantity) {
        // 1. æŸ¥è¯¢åº“å­˜
        Inventory inventory = inventoryRepository.findByProductId(productId)
            .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨"));
        
        // 2. æ£€æŸ¥åº“å­˜
        if (inventory.getStock() < quantity) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        // 3. æ‰£å‡åº“å­˜ï¼ˆè‡ªåŠ¨å¸¦ç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
        inventory.setStock(inventory.getStock() - quantity);
        inventoryRepository.save(inventory);
        
        // SQL: UPDATE t_inventory SET stock = ?, version = version + 1 
        //      WHERE id = ? AND version = ?
        
        // å¦‚æœversionä¸åŒ¹é…ï¼Œæ›´æ–°å¤±è´¥ï¼ŒæŠ›å‡ºOptimisticLockException
    }
}
```

**å¯¹æ¯”**ï¼š

```
æ–¹æ¡ˆ1ï¼šå”¯ä¸€ç´¢å¼•
âœ… ç®€å•å¯é 
âœ… æ•°æ®åº“å±‚é¢ä¿è¯
âš ï¸ åªé€‚åˆæœ‰å”¯ä¸€æ ‡è¯†çš„åœºæ™¯

æ–¹æ¡ˆ2ï¼šTokenæœºåˆ¶ï¼ˆæ¨èï¼‰
âœ… é€šç”¨æ€§å¼º
âœ… ç”¨æˆ·ä½“éªŒå¥½
âš ï¸ éœ€è¦Redis
âš ï¸ Tokenç®¡ç†å¤æ‚

æ–¹æ¡ˆ3ï¼šçŠ¶æ€æœº
âœ… ç®€å•ç›´è§‚
âœ… é€‚åˆæœ‰çŠ¶æ€æµè½¬çš„åœºæ™¯
âš ï¸ åªé€‚åˆç‰¹å®šåœºæ™¯

æ–¹æ¡ˆ4ï¼šåˆ†å¸ƒå¼é”
âœ… å¼ºä¸€è‡´æ€§
âš ï¸ æ€§èƒ½å¼€é”€å¤§
âš ï¸ é”è¶…æ—¶é£é™©

æ–¹æ¡ˆ5ï¼šä¹è§‚é”
âœ… æ€§èƒ½å¥½ï¼ˆæ— é”ï¼‰
âš ï¸ å†²çªé‡è¯•
âš ï¸ åªé€‚åˆæ›´æ–°åœºæ™¯
```

**æˆ‘ä»¬é¡¹ç›®ä¸­çš„å®è·µ**ï¼š

```java
// è®¢å•åˆ›å»ºï¼šToken + å”¯ä¸€ç´¢å¼•
@PostMapping("/orders")
public ApiResponse<OrderResponse> createOrder(
        @RequestBody OrderRequest request,
        @RequestHeader("X-Order-Token") String token) {
    
    // 1. éªŒè¯Tokenï¼ˆå¹‚ç­‰æ€§ï¼‰
    validateToken(token);
    
    // 2. åˆ›å»ºè®¢å•ï¼ˆè®¢å•å·å”¯ä¸€ç´¢å¼•ï¼‰
    OrderResponse response = orderService.createOrder(request);
    
    return ApiResponse.success(response);
}

// è®¢å•æ”¯ä»˜ï¼šçŠ¶æ€æœº
@PutMapping("/orders/{orderId}/pay")
public ApiResponse<Void> payOrder(@PathVariable Long orderId) {
    // çŠ¶æ€æœºæ£€æŸ¥ï¼ˆåªæœ‰PENDINGçŠ¶æ€æ‰èƒ½æ”¯ä»˜ï¼‰
    orderService.payOrder(orderId);
    
    return ApiResponse.success();
}

// åº“å­˜æ‰£å‡ï¼šä¹è§‚é”
@PostMapping("/inventory/deduct")
public ApiResponse<Void> deductStock(@RequestParam Long productId,
                                     @RequestParam Integer quantity) {
    // ä¹è§‚é”ä¿è¯å¹‚ç­‰æ€§
    inventoryService.deductStock(productId, quantity);
    
    return ApiResponse.success();
}
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šä¸­é—´ä»¶åº”ç”¨

### 5.1 Redisåœ¨é¡¹ç›®ä¸­çš„åº”ç”¨

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬é¡¹ç›®ä¸­Redisä¸»è¦ç”¨äºï¼šç¼“å­˜ã€åˆ†å¸ƒå¼é”ã€å¸ƒéš†è¿‡æ»¤å™¨ã€‚

**1. ç¼“å­˜åº”ç”¨**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String CACHE_PREFIX = "order:";
    private static final long CACHE_EXPIRE = 600; // 10åˆ†é’Ÿ
    
    public Order getOrderById(Long orderId) {
        String cacheKey = CACHE_PREFIX + orderId;
        
        // 1. å°è¯•ä»ç¼“å­˜è·å–
        Order order = (Order) redisTemplate.opsForValue().get(cacheKey);
        
        if (order != null) {
            log.debug("ç¼“å­˜å‘½ä¸­: {}", cacheKey);
            return order;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨"));
        
        // 3. å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, order, CACHE_EXPIRE, TimeUnit.SECONDS);
        
        return order;
    }
}
```

**ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆï¼ˆå¸ƒéš†è¿‡æ»¤å™¨ï¼‰**ï¼š

```java
@Configuration
public class BloomFilterConfig {
    
    @Bean
    public RBloomFilter<Long> orderBloomFilter(RedissonClient redissonClient) {
        RBloomFilter<Long> bloomFilter = redissonClient.getBloomFilter("order:bloom");
        
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé¢„è®¡1000ä¸‡æ•°æ®ï¼Œè¯¯åˆ¤ç‡0.01ï¼‰
        bloomFilter.tryInit(10000000L, 0.01);
        
        return bloomFilter;
    }
}

@Service
public class OrderService {
    
    @Autowired
    private RBloomFilter<Long> orderBloomFilter;
    
    // åˆ›å»ºè®¢å•æ—¶æ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨
    public void createOrder(OrderRequest request) {
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // æ·»åŠ åˆ°å¸ƒéš†è¿‡æ»¤å™¨
        orderBloomFilter.add(order.getId());
    }
    
    // æŸ¥è¯¢è®¢å•æ—¶å…ˆåˆ¤æ–­å¸ƒéš†è¿‡æ»¤å™¨
    public Order getOrderById(Long orderId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!orderBloomFilter.contains(orderId)) {
            throw new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨");
        }
        
        // 2. æŸ¥è¯¢ç¼“å­˜
        // 3. æŸ¥è¯¢æ•°æ®åº“
        // ...
    }
}
```

**ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆï¼ˆäº’æ–¥é”ï¼‰**ï¼š

```java
public Order getOrderById(Long orderId) {
    String cacheKey = "order:" + orderId;
    String lockKey = "lock:order:" + orderId;
    
    // 1. å°è¯•ä»ç¼“å­˜è·å–
    Order order = (Order) redisTemplate.opsForValue().get(cacheKey);
    if (order != null) {
        return order;
    }
    
    // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒåŠ é”
    RLock lock = redissonClient.getLock(lockKey);
    try {
        if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
            // 3. å†æ¬¡å°è¯•ä»ç¼“å­˜è·å–ï¼ˆåŒé‡æ£€æŸ¥ï¼‰
            order = (Order) redisTemplate.opsForValue().get(cacheKey);
            if (order != null) {
                return order;
            }
            
            // 4. æŸ¥è¯¢æ•°æ®åº“
            order = orderRepository.findById(orderId)
                .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨"));
            
            // 5. å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, order, 
                                           CACHE_EXPIRE, TimeUnit.SECONDS);
            
            return order;
        } else {
            throw new BusinessException(ErrorCode.SYSTEM_BUSY, "ç³»ç»Ÿç¹å¿™");
        }
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

**ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆï¼ˆéšæœºè¿‡æœŸæ—¶é—´ï¼‰**ï¼š

```java
// æ·»åŠ éšæœºè¿‡æœŸæ—¶é—´ï¼ˆé¿å…åŒæ—¶è¿‡æœŸï¼‰
long randomExpire = CACHE_EXPIRE + new Random().nextInt(300); // 10-15åˆ†é’Ÿ
redisTemplate.opsForValue().set(cacheKey, order, randomExpire, TimeUnit.SECONDS);
```

**2. åˆ†å¸ƒå¼é”åº”ç”¨**ï¼š

```java
@Service
public class InventoryService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void deductStock(Long productId, Integer quantity) {
        String lockKey = "inventory:lock:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•åŠ é”ï¼ˆç­‰å¾…3ç§’ï¼Œé”10ç§’è‡ªåŠ¨é‡Šæ”¾ï¼‰
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                // 1. æŸ¥è¯¢åº“å­˜
                Inventory inventory = getInventory(productId);
                
                // 2. æ£€æŸ¥åº“å­˜
                if (inventory.getStock() < quantity) {
                    throw new InsufficientStockException("åº“å­˜ä¸è¶³");
                }
                
                // 3. æ‰£å‡åº“å­˜
                inventory.setStock(inventory.getStock() - quantity);
                inventoryRepository.save(inventory);
                
            } else {
                throw new BusinessException(ErrorCode.SYSTEM_BUSY, "ç³»ç»Ÿç¹å¿™");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "ç³»ç»Ÿé”™è¯¯");
        } finally {
            // é‡Šæ”¾é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

**3. å¤šçº§ç¼“å­˜**ï¼š

```java
@Service
public class OrderService {
    
    // æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
    @Autowired
    private Cache<Long, Order> localCache;
    
    // Redisç¼“å­˜
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public Order getOrderById(Long orderId) {
        // 1. L1ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆæœ€å¿«ï¼Œ100nsï¼‰
        Order order = localCache.getIfPresent(orderId);
        if (order != null) {
            return order;
        }
        
        // 2. L2ç¼“å­˜ï¼šRedisï¼ˆå¿«ï¼Œ1msï¼‰
        String cacheKey = "order:" + orderId;
        order = (Order) redisTemplate.opsForValue().get(cacheKey);
        if (order != null) {
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(orderId, order);
            return order;
        }
        
        // 3. L3ï¼šæ•°æ®åº“ï¼ˆæ…¢ï¼Œ10-100msï¼‰
        order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("è®¢å•ä¸å­˜åœ¨"));
        
        // å†™å…¥Redis
        redisTemplate.opsForValue().set(cacheKey, order, 600, TimeUnit.SECONDS);
        
        // å†™å…¥æœ¬åœ°ç¼“å­˜
        localCache.put(orderId, order);
        
        return order;
    }
}
```

---

### 5.2 Kafkaæ¶ˆæ¯é˜Ÿåˆ—çš„åº”ç”¨

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬é¡¹ç›®ä¸­Kafkaä¸»è¦ç”¨äºï¼šå¼‚æ­¥é€šçŸ¥ã€æ—¥å¿—æ”¶é›†ã€æ•°æ®åŒæ­¥ã€‚

**1. è®¢å•åˆ›å»ºé€šçŸ¥**ï¼š

```java
// ç”Ÿäº§è€…
@Service
public class OrderService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // 2. å‘é€æ¶ˆæ¯ï¼ˆå¼‚æ­¥ï¼‰
        OrderCreatedEvent event = OrderCreatedEvent.builder()
            .orderId(order.getId())
            .orderNo(order.getOrderNo())
            .userId(order.getUserId())
            .productId(order.getProductId())
            .quantity(order.getQuantity())
            .totalAmount(order.getTotalAmount())
            .createTime(order.getCreateTime())
            .build();
        
        kafkaTemplate.send("order-created", event);
    }
}

// æ¶ˆè´¹è€…
@Service
@Slf4j
public class NotificationService {
    
    @KafkaListener(topics = "order-created", groupId = "notification-group")
    public void handleOrderCreated(OrderCreatedEvent event) {
        log.info("æ”¶åˆ°è®¢å•åˆ›å»ºæ¶ˆæ¯: orderNo={}", event.getOrderNo());
        
        // å‘é€é€šçŸ¥
        sendNotification(event.getUserId(), 
                        "æ‚¨çš„è®¢å•" + event.getOrderNo() + "å·²åˆ›å»ºæˆåŠŸ");
    }
}
```

**2. æ¶ˆæ¯å¯é æ€§ä¿è¯**ï¼š

```java
// ç”Ÿäº§è€…é…ç½®
@Configuration
public class KafkaProducerConfig {
    
    @Bean
    public ProducerFactory<String, Object> producerFactory() {
        Map<String, Object> configs = new HashMap<>();
        configs.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        configs.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        configs.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, JsonSerializer.class);
        
        // æ¶ˆæ¯å¯é æ€§é…ç½®
        configs.put(ProducerConfig.ACKS_CONFIG, "all");  // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
        configs.put(ProducerConfig.RETRIES_CONFIG, 3);   // é‡è¯•3æ¬¡
        configs.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true);  // å¹‚ç­‰æ€§
        
        return new DefaultKafkaProducerFactory<>(configs);
    }
}

// å‘é€ç¡®è®¤
@Service
public class OrderService {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    public void createOrder(OrderRequest request) {
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // å‘é€æ¶ˆæ¯å¹¶å¤„ç†ç»“æœ
        ListenableFuture<SendResult<String, Object>> future = 
            kafkaTemplate.send("order-created", event);
        
        future.addCallback(new ListenableFutureCallback<SendResult<String, Object>>() {
            @Override
            public void onSuccess(SendResult<String, Object> result) {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸ: offset={}", result.getRecordMetadata().offset());
            }
            
            @Override
            public void onFailure(Throwable ex) {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥", ex);
                // å¯ä»¥é‡è¯•æˆ–è®°å½•åˆ°æ•°æ®åº“
            }
        });
    }
}
```

**3. æ¶ˆè´¹è€…å¹‚ç­‰æ€§**ï¼š

```java
@Service
public class NotificationService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @KafkaListener(topics = "order-created", groupId = "notification-group")
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å¹‚ç­‰æ€§æ£€æŸ¥ï¼ˆä½¿ç”¨Redisè®°å½•å·²å¤„ç†çš„æ¶ˆæ¯ï¼‰
        String idempotentKey = "kafka:consumed:" + event.getOrderNo();
        
        // å°è¯•è®¾ç½®ï¼ˆsetIfAbsentï¼‰
        Boolean success = redisTemplate.opsForValue()
            .setIfAbsent(idempotentKey, "1", 7, TimeUnit.DAYS);
        
        if (Boolean.FALSE.equals(success)) {
            log.warn("é‡å¤æ¶ˆæ¯ï¼Œè·³è¿‡å¤„ç†: orderNo={}", event.getOrderNo());
            return;
        }
        
        // å¤„ç†æ¶ˆæ¯
        sendNotification(event.getUserId(), 
                        "æ‚¨çš„è®¢å•" + event.getOrderNo() + "å·²åˆ›å»ºæˆåŠŸ");
    }
}
```

**4. æ­»ä¿¡é˜Ÿåˆ—**ï¼š

```java
@Configuration
public class KafkaConsumerConfig {
    
    @Bean
    public ConcurrentKafkaListenerContainerFactory<String, Object> kafkaListenerContainerFactory() {
        ConcurrentKafkaListenerContainerFactory<String, Object> factory = 
            new ConcurrentKafkaListenerContainerFactory<>();
        
        factory.setConsumerFactory(consumerFactory());
        
        // é…ç½®é”™è¯¯å¤„ç†å™¨
        factory.setErrorHandler(new SeekToCurrentErrorHandler(
            new DeadLetterPublishingRecoverer(kafkaTemplate()),  // æ­»ä¿¡é˜Ÿåˆ—
            new FixedBackOff(1000L, 3L)  // é‡è¯•3æ¬¡ï¼Œé—´éš”1ç§’
        ));
        
        return factory;
    }
}
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæ•°æ®åº“ç›¸å…³

### 6.1 SQLä¼˜åŒ–å®æˆ˜æ¡ˆä¾‹

**é—®é¢˜**ï¼šè®¢å•åˆ—è¡¨æŸ¥è¯¢æ…¢ï¼Œå“åº”æ—¶é—´3ç§’

**åŸå§‹SQL**ï¼š
```sql
SELECT * FROM t_order 
WHERE user_id = 1001 
  AND status = 'PENDING'
  AND YEAR(create_time) = 2025
ORDER BY create_time DESC
LIMIT 10;
```

**é—®é¢˜åˆ†æ**ï¼š
```sql
EXPLAIN SELECT * FROM t_order 
WHERE user_id = 1001 
  AND status = 'PENDING'
  AND YEAR(create_time) = 2025
ORDER BY create_time DESC
LIMIT 10;

ç»“æœï¼š
type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰
rows: 1000000ï¼ˆæ‰«æ100ä¸‡è¡Œï¼‰
Extra: Using filesortï¼ˆéœ€è¦æ’åºï¼‰
```

**é—®é¢˜ç‚¹**ï¼š
1. `YEAR(create_time)`å¯¼è‡´ç´¢å¼•å¤±æ•ˆ
2. `SELECT *`æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
3. æ²¡æœ‰åˆé€‚çš„ç´¢å¼•

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

```sql
-- 1. æ”¹å†™SQLï¼Œé¿å…å‡½æ•°
SELECT id, order_no, product_name, total_amount, status, create_time
FROM t_order 
WHERE user_id = 1001 
  AND status = 'PENDING'
  AND create_time >= '2025-01-01'
  AND create_time < '2026-01-01'
ORDER BY create_time DESC
LIMIT 10;

-- 2. åˆ›å»ºå¤åˆç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€åŸåˆ™ï¼‰
CREATE INDEX idx_user_status_time 
ON t_order(user_id, status, create_time);

-- 3. å†æ¬¡EXPLAIN
type: refï¼ˆç´¢å¼•æŸ¥è¯¢ï¼‰
rows: 50ï¼ˆåªæ‰«æ50è¡Œï¼‰
Extra: Using index conditionï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰

-- æ•ˆæœï¼šå“åº”æ—¶é—´ä»3ç§’é™åˆ°50ms
```

---

### 6.2 æ•°æ®åº“è¿æ¥æ± é…ç½®

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬ä½¿ç”¨HikariCPè¿æ¥æ± ï¼ˆSpring Booté»˜è®¤ï¼‰ã€‚

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/order_db
    username: admin
    password: Admin@123
    driver-class-name: org.postgresql.Driver
    
    hikari:
      # æœ€å°ç©ºé—²è¿æ¥æ•°
      minimum-idle: 10
      
      # æœ€å¤§è¿æ¥æ•°
      maximum-pool-size: 50
      
      # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      connection-timeout: 30000
      
      # ç©ºé—²è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œ10åˆ†é’Ÿï¼‰
      idle-timeout: 600000
      
      # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆæ¯«ç§’ï¼Œ30åˆ†é’Ÿï¼‰
      max-lifetime: 1800000
      
      # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      connection-test-query: SELECT 1
      
      # è¿æ¥æ± åç§°
      pool-name: OrderServiceHikariCP
```

**å‚æ•°è¯´æ˜**ï¼š

```
minimum-idle: 10
- æœ€å°ç©ºé—²è¿æ¥æ•°
- ä¿è¯å§‹ç»ˆæœ‰10ä¸ªè¿æ¥å¯ç”¨
- é¿å…é¢‘ç¹åˆ›å»ºè¿æ¥

maximum-pool-size: 50
- æœ€å¤§è¿æ¥æ•°
- æ ¹æ®å¹¶å‘é‡è®¾ç½®
- è®¡ç®—å…¬å¼ï¼šæ ¸å¿ƒæ•° Ã— 2 + æœ‰æ•ˆç£ç›˜æ•°

connection-timeout: 30000
- è·å–è¿æ¥è¶…æ—¶æ—¶é—´
- 30ç§’è¶…æ—¶
- é¿å…é•¿æ—¶é—´ç­‰å¾…

idle-timeout: 600000
- ç©ºé—²è¿æ¥è¶…æ—¶
- 10åˆ†é’Ÿå…³é—­ç©ºé—²è¿æ¥
- é‡Šæ”¾æ•°æ®åº“èµ„æº

max-lifetime: 1800000
- è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´
- 30åˆ†é’Ÿå¼ºåˆ¶å…³é—­
- é¿å…é•¿è¿æ¥é—®é¢˜
```

**ç›‘æ§è¿æ¥æ± **ï¼š

```java
@RestController
@RequestMapping("/actuator/hikari")
public class HikariMetricsController {
    
    @Autowired
    private HikariDataSource hikariDataSource;
    
    @GetMapping("/metrics")
    public Map<String, Object> getMetrics() {
        HikariPoolMXBean poolMXBean = hikariDataSource.getHikariPoolMXBean();
        
        Map<String, Object> metrics = new HashMap<>();
        metrics.put("active", poolMXBean.getActiveConnections());
        metrics.put("idle", poolMXBean.getIdleConnections());
        metrics.put("total", poolMXBean.getTotalConnections());
        metrics.put("waiting", poolMXBean.getThreadsAwaitingConnection());
        
        return metrics;
    }
}
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–

### 7.1 JVMè°ƒä¼˜å®æˆ˜

**é—®é¢˜**ï¼šè®¢å•æœåŠ¡é¢‘ç¹Full GCï¼Œæ¯æ¬¡åœé¡¿1-2ç§’

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹GCæ—¥å¿—
tail -f /var/log/order-service/gc.log

# å‘ç°ï¼š
# [Full GC] 1024M->980M(1024M), 1.5 secs
# æ¯æ¬¡Full GCå›æ”¶å¾ˆå°‘ï¼Œè¯´æ˜è€å¹´ä»£å ç”¨ç‡é«˜

# 2. æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨
jmap -heap <pid>

# ç»“æœï¼š
# Old Generation: 980MB / 1024MB (95.7%)  # è€å¹´ä»£å ç”¨ç‡95%+

# 3. ç”Ÿæˆå †è½¬å‚¨
jmap -dump:live,format=b,file=heapdump.hprof <pid>

# 4. ä½¿ç”¨MATåˆ†æ
# å‘ç°ï¼šæœ¬åœ°ç¼“å­˜å ç”¨800MBï¼ˆæ²¡æœ‰é™åˆ¶å¤§å°ï¼‰
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// é—®é¢˜ä»£ç ï¼š
@Service
public class OrderService {
    
    // æ— é™åˆ¶çš„æœ¬åœ°ç¼“å­˜
    private static final Map<Long, Order> CACHE = new ConcurrentHashMap<>();
    
    public Order getOrderById(Long orderId) {
        Order order = CACHE.get(orderId);
        if (order == null) {
            order = orderRepository.findById(orderId).orElseThrow();
            CACHE.put(orderId, order);  // ä¸€ç›´å¾€ç¼“å­˜åŠ ï¼Œä»ä¸åˆ é™¤
        }
        return order;
    }
}

// ä¼˜åŒ–åï¼šä½¿ç”¨Caffeineé™åˆ¶ç¼“å­˜å¤§å°
@Configuration
public class CacheConfig {
    
    @Bean
    public Cache<Long, Order> orderCache() {
        return Caffeine.newBuilder()
            .maximumSize(10000)  // é™åˆ¶10000æ¡
            .expireAfterWrite(10, TimeUnit.MINUTES)  // 10åˆ†é’Ÿè¿‡æœŸ
            .build();
    }
}

@Service
public class OrderService {
    
    @Autowired
    private Cache<Long, Order> orderCache;
    
    public Order getOrderById(Long orderId) {
        return orderCache.get(orderId, id -> 
            orderRepository.findById(id).orElseThrow()
        );
    }
}
```

**æ•ˆæœ**ï¼š
- Full GCé¢‘ç‡ï¼šä»æ¯åˆ†é’Ÿ1æ¬¡é™åˆ°æ¯å°æ—¶1æ¬¡
- åœé¡¿æ—¶é—´ï¼šä»1-2ç§’é™åˆ°100msä»¥å†…
- è€å¹´ä»£å ç”¨ç‡ï¼šä»95%é™åˆ°50%

---

### 7.2 æ¥å£æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**ï¼šè®¢å•è¯¦æƒ…æ¥å£å“åº”æ…¢ï¼Œå¹³å‡500ms

**ä¼˜åŒ–å‰ä»£ç **ï¼š

```java
@GetMapping("/orders/{orderId}")
public OrderVO getOrderDetail(@PathVariable Long orderId) {
    // 1. æŸ¥è¯¢è®¢å•ï¼ˆ100msï¼‰
    Order order = orderService.getOrderById(orderId);
    
    // 2. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆ100msï¼‰
    User user = userService.getUserById(order.getUserId());
    
    // 3. æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼ˆ100msï¼‰
    Product product = productService.getProductById(order.getProductId());
    
    // 4. æŸ¥è¯¢ç‰©æµä¿¡æ¯ï¼ˆ200msï¼‰
    Logistics logistics = logisticsService.getByOrderId(orderId);
    
    // æ€»è€—æ—¶ï¼š500msï¼ˆä¸²è¡Œï¼‰
    return buildOrderVO(order, user, product, logistics);
}
```

**ä¼˜åŒ–æ–¹æ¡ˆï¼šå¹¶è¡ŒæŸ¥è¯¢**

```java
@GetMapping("/orders/{orderId}")
public OrderVO getOrderDetail(@PathVariable Long orderId) {
    // 1. æŸ¥è¯¢è®¢å•
    Order order = orderService.getOrderById(orderId);
    
    // 2. å¹¶è¡ŒæŸ¥è¯¢ï¼ˆä½¿ç”¨CompletableFutureï¼‰
    CompletableFuture<User> userFuture = CompletableFuture.supplyAsync(
        () -> userService.getUserById(order.getUserId())
    );
    
    CompletableFuture<Product> productFuture = CompletableFuture.supplyAsync(
        () -> productService.getProductById(order.getProductId())
    );
    
    CompletableFuture<Logistics> logisticsFuture = CompletableFuture.supplyAsync(
        () -> logisticsService.getByOrderId(orderId)
    );
    
    // 3. ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    CompletableFuture.allOf(userFuture, productFuture, logisticsFuture).join();
    
    // 4. è·å–ç»“æœ
    User user = userFuture.join();
    Product product = productFuture.join();
    Logistics logistics = logisticsFuture.join();
    
    // æ€»è€—æ—¶ï¼š200msï¼ˆå¹¶è¡Œï¼Œå–æœ€æ…¢çš„ï¼‰
    return buildOrderVO(order, user, product, logistics);
}
```

**æ•ˆæœ**ï¼šå“åº”æ—¶é—´ä»500msé™åˆ°200msï¼Œæå‡60%

---

## ç¬¬å…«éƒ¨åˆ†ï¼šäº‘åŸç”ŸæŠ€æœ¯

### 8.1 Kuberneteséƒ¨ç½²ç›¸å…³

**é¢è¯•é¢˜**ï¼šå¦‚ä½•åœ¨K8sä¸­éƒ¨ç½²ä½ çš„å¾®æœåŠ¡ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬ä½¿ç”¨Helmæ‰“åŒ…å¾®æœåŠ¡ï¼Œéƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ã€‚

**Deploymenté…ç½®**ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: apps
spec:
  replicas: 3  # 3ä¸ªå‰¯æœ¬
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      containers:
      - name: order-service
        image: order-service:1.0.0
        ports:
        - containerPort: 8081
        
        # èµ„æºé™åˆ¶
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: JAVA_OPTS
          value: "-Xms256m -Xmx512m -XX:+UseG1GC"
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 10
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 5
```

**HPAé…ç½®ï¼ˆè‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰**ï¼š

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: order-service
  namespace: apps
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: order-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

**æ•ˆæœ**ï¼š
- CPUè¶…è¿‡80%è‡ªåŠ¨æ‰©å®¹
- CPUä½äº50%è‡ªåŠ¨ç¼©å®¹
- æœ€å°‘3ä¸ªPodï¼Œæœ€å¤š10ä¸ªPod

---

### 8.2 Dockeré•œåƒä¼˜åŒ–

**é—®é¢˜**ï¼šDockeré•œåƒ800MBï¼Œæ„å»ºæ…¢ï¼Œæ‹‰å–æ…¢

**ä¼˜åŒ–å‰**ï¼š

```dockerfile
FROM openjdk:8-jdk
COPY target/order-service-1.0.0.jar /app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]

# é•œåƒå¤§å°ï¼š800MB
```

**ä¼˜åŒ–å**ï¼š

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM maven:3.6-jdk-8 AS build
WORKDIR /app
COPY pom.xml .
COPY src ./src
RUN mvn clean package -DskipTests

FROM openjdk:8-jdk-alpine
COPY --from=build /app/target/order-service-1.0.0.jar /app.jar
ENTRYPOINT ["java", "-jar", "/app.jar"]

# é•œåƒå¤§å°ï¼š150MBï¼ˆå‡å°‘80%ï¼‰
```

**è¿›ä¸€æ­¥ä¼˜åŒ–**ï¼š

```dockerfile
FROM openjdk:8-jdk-alpine

# åˆ†å±‚å¤åˆ¶jarï¼ˆåˆ©ç”¨Dockerç¼“å­˜ï¼‰
WORKDIR /app
COPY target/order-service-1.0.0.jar app.jar

# è§£å‹jar
RUN jar -xf app.jar && rm app.jar

# åˆ†å±‚å¯åŠ¨
ENTRYPOINT ["java", "-cp", "/app", "org.springframework.boot.loader.JarLauncher"]

# æ•ˆæœï¼š
# - ä»£ç å˜æ›´æ—¶ï¼Œåªé‡æ–°æ„å»ºBOOT-INF/classeså±‚
# - ä¾èµ–ä¸å˜æ—¶ï¼Œå¤ç”¨ç¼“å­˜
# - æ„å»ºé€Ÿåº¦æå‡5å€+
```

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šä¸šåŠ¡åœºæ™¯é¢˜

### 9.1 å¦‚ä½•é˜²æ­¢è¶…å–ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä»¬ä½¿ç”¨å¤šç§æ–¹æ¡ˆé˜²æ­¢è¶…å–ï¼š

**æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“ä¹è§‚é”ï¼ˆæ¨èï¼‰**

```java
@Entity
@Table(name = "t_inventory")
public class Inventory {
    @Id
    private Long id;
    
    private Long productId;
    
    private Integer stock;
    
    @Version  // ä¹è§‚é”
    private Integer version;
}

@Service
public class InventoryService {
    
    @Transactional(rollbackFor = Exception.class)
    public void deductStock(Long productId, Integer quantity) {
        // 1. æŸ¥è¯¢åº“å­˜
        Inventory inventory = inventoryRepository.findByProductId(productId)
            .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨"));
        
        // 2. æ£€æŸ¥åº“å­˜
        if (inventory.getStock() < quantity) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        // 3. æ‰£å‡åº“å­˜ï¼ˆè‡ªåŠ¨æ£€æŸ¥versionï¼‰
        inventory.setStock(inventory.getStock() - quantity);
        inventoryRepository.save(inventory);
        
        // SQL: UPDATE t_inventory 
        //      SET stock = ?, version = version + 1 
        //      WHERE id = ? AND version = ?
        
        // å¹¶å‘æ—¶ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚æˆåŠŸï¼Œå…¶ä»–è¯·æ±‚versionä¸åŒ¹é…ï¼Œæ›´æ–°å¤±è´¥
    }
}
```

**æ–¹æ¡ˆäºŒï¼šRedisåˆ†å¸ƒå¼é”**

```java
@Service
public class InventoryService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void deductStock(Long productId, Integer quantity) {
        String lockKey = "inventory:lock:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            if (lock.tryLock(3, 10, TimeUnit.SECONDS)) {
                // 1. æŸ¥è¯¢åº“å­˜
                Integer stock = getStock(productId);
                
                // 2. æ£€æŸ¥åº“å­˜
                if (stock < quantity) {
                    throw new InsufficientStockException("åº“å­˜ä¸è¶³");
                }
                
                // 3. æ‰£å‡åº“å­˜
                updateStock(productId, stock - quantity);
            }
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

**æ–¹æ¡ˆä¸‰ï¼šRedisé¢„æ‰£å‡ + æ•°æ®åº“æœ€ç»ˆæ‰£å‡**

```java
@Service
public class InventoryService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void deductStockOptimized(Long productId, Integer quantity) {
        String stockKey = "inventory:stock:" + productId;
        
        // 1. Redisé¢„æ‰£å‡ï¼ˆä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
        String script = 
            "local stock = redis.call('get', KEYS[1])\n" +
            "if tonumber(stock) >= tonumber(ARGV[1]) then\n" +
            "    redis.call('decrby', KEYS[1], ARGV[1])\n" +
            "    return 1\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(stockKey),
            quantity.toString()
        );
        
        if (result == 0) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
        
        // 2. å¼‚æ­¥æ‰£å‡æ•°æ®åº“ï¼ˆä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼‰
        asyncDeductDatabase(productId, quantity);
    }
}
```

---

### 9.2 å¦‚ä½•å¤„ç†é«˜å¹¶å‘ä¸‹å•ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

é«˜å¹¶å‘ä¸‹å•éœ€è¦ä»å¤šä¸ªå±‚é¢ä¼˜åŒ–ï¼š

**1. å‰ç«¯é™æµ**

```javascript
// é˜²æ­¢é‡å¤æäº¤
let submitting = false;

function submitOrder() {
    if (submitting) {
        alert('è®¢å•æäº¤ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤');
        return;
    }
    
    submitting = true;
    
    axios.post('/api/orders', data)
        .then(response => {
            alert('è®¢å•æäº¤æˆåŠŸ');
        })
        .finally(() => {
            submitting = false;
        });
}
```

**2. ç½‘å…³é™æµ**

```yaml
# Gatewayé…ç½®
spring:
  cloud:
    gateway:
      routes:
      - id: order-service
        uri: lb://order-service
        predicates:
        - Path=/api/orders/**
        filters:
        - name: RequestRateLimiter
          args:
            # æ¯ç§’æœ€å¤š100ä¸ªè¯·æ±‚
            redis-rate-limiter.replenishRate: 100
            # çªå‘æµé‡æœ€å¤š200ä¸ªè¯·æ±‚
            redis-rate-limiter.burstCapacity: 200
```

**3. Sentinelé™æµ**

```java
@PostMapping("/orders")
@SentinelResource(value = "createOrder",
                 blockHandler = "createOrderBlockHandler")
public ApiResponse<OrderResponse> createOrder(@RequestBody OrderRequest request) {
    return ApiResponse.success(orderService.createOrder(request));
}

public ApiResponse<OrderResponse> createOrderBlockHandler(
        OrderRequest request, BlockException ex) {
    return ApiResponse.error(ErrorCode.SYSTEM_BUSY, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
}
```

**4. æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°**

```java
@PostMapping("/orders")
public ApiResponse<String> createOrderAsync(@RequestBody OrderRequest request) {
    // 1. ç”Ÿæˆè®¢å•å·
    String orderNo = generateOrderNo();
    
    // 2. å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
    OrderMessage message = new OrderMessage();
    message.setOrderNo(orderNo);
    message.setRequest(request);
    kafkaTemplate.send("order-create", message);
    
    // 3. ç«‹å³è¿”å›
    return ApiResponse.success("è®¢å•æäº¤æˆåŠŸï¼Œè®¢å•å·ï¼š" + orderNo);
}

// æ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†
@KafkaListener(topics = "order-create")
public void handleOrderCreate(OrderMessage message) {
    orderService.createOrder(message.getRequest());
}
```

**5. Redisåº“å­˜é¢„åŠ è½½**

```java
@Service
public class InventoryService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½åº“å­˜åˆ°Redis
    @PostConstruct
    public void init() {
        List<Inventory> inventoryList = inventoryRepository.findAll();
        
        for (Inventory inventory : inventoryList) {
            String key = "inventory:stock:" + inventory.getProductId();
            redisTemplate.opsForValue().set(key, inventory.getStock());
        }
    }
    
    // ä»Redisæ‰£å‡åº“å­˜ï¼ˆå¿«ï¼‰
    public void deductStock(Long productId, Integer quantity) {
        String key = "inventory:stock:" + productId;
        
        // Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String script = 
            "local stock = redis.call('get', KEYS[1])\n" +
            "if tonumber(stock) >= tonumber(ARGV[1]) then\n" +
            "    redis.call('decrby', KEYS[1], ARGV[1])\n" +
            "    return 1\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            quantity.toString()
        );
        
        if (result == 0) {
            throw new InsufficientStockException("åº“å­˜ä¸è¶³");
        }
    }
}
```

**ç»¼åˆæ–¹æ¡ˆ**ï¼š

```
ç”¨æˆ·è¯·æ±‚ï¼ˆ10000 QPSï¼‰
    â†“
å‰ç«¯é™æµï¼ˆé˜²é‡å¤æäº¤ï¼‰
    â†“
ç½‘å…³é™æµï¼ˆé™åˆ¶åˆ°1000 QPSï¼‰
    â†“
Sentinelé™æµï¼ˆä¿æŠ¤æœåŠ¡ï¼Œé™åˆ¶åˆ°500 QPSï¼‰
    â†“
æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    â†“
Redisæ‰£å‡åº“å­˜ï¼ˆå¿«é€Ÿå“åº”ï¼‰
    â†“
æ•°æ®åº“æœ€ç»ˆæ‰£å‡ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
```

---

## ç¬¬åéƒ¨åˆ†ï¼šç»¼åˆé—®é¢˜

### 10.1 ä½ åœ¨é¡¹ç›®ä¸­é‡åˆ°çš„æœ€å¤§æŒ‘æˆ˜æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³çš„ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æœ€å¤§çš„æŒ‘æˆ˜æ˜¯**åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜**ã€‚

**åœºæ™¯**ï¼š
åˆ›å»ºè®¢å•éœ€è¦åŒæ—¶æ“ä½œè®¢å•è¡¨å’Œåº“å­˜è¡¨ï¼Œä¸¤ä¸ªè¡¨åœ¨ä¸åŒçš„æœåŠ¡ä¸­ã€‚

**é—®é¢˜**ï¼š
1. è®¢å•åˆ›å»ºæˆåŠŸï¼Œåº“å­˜æ‰£å‡å¤±è´¥ â†’ æ•°æ®ä¸ä¸€è‡´
2. åº“å­˜æ‰£å‡æˆåŠŸï¼Œè®¢å•åˆ›å»ºå¤±è´¥ â†’ æ•°æ®ä¸ä¸€è‡´
3. ä¸¤ä¸ªæ“ä½œéƒ½æˆåŠŸï¼Œä½†ä¸­é—´ç½‘ç»œæ•…éšœ â†’ ä¸ç¡®å®šçŠ¶æ€

**è§£å†³æ–¹æ¡ˆ**ï¼š

ä½¿ç”¨Seata ATæ¨¡å¼å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼š

```java
@Service
public class OrderService {
    
    @GlobalTransactional(rollbackFor = Exception.class)
    public void createOrder(OrderRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        inventoryClient.deductStock(request.getProductId(), request.getQuantity());
        
        // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼ŒSeataè‡ªåŠ¨å›æ»šä¸¤ä¸ªæ“ä½œ
    }
}
```

**æ•ˆæœ**ï¼š
- ä¿è¯äº†å¼ºä¸€è‡´æ€§
- æ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç 
- æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼ˆTPS 1000+ï¼‰

**é‡åˆ°çš„é—®é¢˜**ï¼š
1. SeataæœåŠ¡å™¨æŒ‚äº†æ€ä¹ˆåŠï¼Ÿ
   - éƒ¨ç½²Seataé›†ç¾¤ï¼ˆ3èŠ‚ç‚¹ï¼‰
   - ä½¿ç”¨Nacoså­˜å‚¨é…ç½®
   
2. é•¿äº‹åŠ¡å¯¼è‡´é”å®šæ—¶é—´è¿‡é•¿ï¼Ÿ
   - è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ30ç§’ï¼‰
   - æ‹†åˆ†å¤§äº‹åŠ¡ä¸ºå°äº‹åŠ¡
   
3. æ€§èƒ½å¼€é”€ï¼Ÿ
   - ä½¿ç”¨ATæ¨¡å¼ï¼ˆæ€§èƒ½æœ€å¥½ï¼‰
   - åªå¯¹æ ¸å¿ƒä¸šåŠ¡ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡
   - éæ ¸å¿ƒä¸šåŠ¡ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§

---

### 10.2 å¦‚æœè®©ä½ é‡æ–°è®¾è®¡è¿™ä¸ªé¡¹ç›®ï¼Œä½ ä¼šåšå“ªäº›æ”¹è¿›ï¼Ÿ

**æ ‡å‡†å›ç­”**ï¼š

æˆ‘ä¼šä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ”¹è¿›ï¼š

**1. å¼•å…¥é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰**

```
ç°çŠ¶ï¼šè´«è¡€æ¨¡å‹ï¼ŒServiceä¸­åŒ…å«å¤§é‡ä¸šåŠ¡é€»è¾‘

æ”¹è¿›ï¼šå……è¡€æ¨¡å‹ï¼Œä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®ä½“ä¸­

// ç°çŠ¶
@Service
public class OrderService {
    public void payOrder(Long orderId) {
        Order order = getOrderById(orderId);
        if (order.getStatus() != OrderStatus.PENDING) {
            throw new RuntimeException("çŠ¶æ€ä¸å¯¹");
        }
        order.setStatus(OrderStatus.PAID);
        orderRepository.save(order);
    }
}

// æ”¹è¿›å
@Entity
public class Order {
    // ä¸šåŠ¡é€»è¾‘æ”¾åˆ°å®ä½“ä¸­
    public void pay() {
        if (!this.status.canPay()) {
            throw new OrderStatusException("å½“å‰çŠ¶æ€ä¸å…è®¸æ”¯ä»˜");
        }
        this.status = OrderStatus.PAID;
        this.addDomainEvent(new OrderPaidEvent(this));
    }
}

@Service
public class OrderService {
    public void payOrder(Long orderId) {
        Order order = getOrderById(orderId);
        order.pay();  // è°ƒç”¨å®ä½“æ–¹æ³•
        orderRepository.save(order);
    }
}
```

**2. ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„**

```
ç°çŠ¶ï¼šæœåŠ¡é—´ç›´æ¥è°ƒç”¨ï¼ˆè€¦åˆï¼‰

æ”¹è¿›ï¼šé€šè¿‡äº‹ä»¶è§£è€¦

// è®¢å•æœåŠ¡
@Service
public class OrderService {
    public void createOrder(OrderRequest request) {
        Order order = buildOrder(request);
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶ï¼ˆè€Œä¸æ˜¯ç›´æ¥è°ƒç”¨ï¼‰
        eventPublisher.publish(new OrderCreatedEvent(order));
    }
}

// åº“å­˜æœåŠ¡
@EventListener
public void handleOrderCreated(OrderCreatedEvent event) {
    // è‡ªåŠ¨æ‰£å‡åº“å­˜
    inventoryService.deduct(event.getProductId(), event.getQuantity());
}

// é€šçŸ¥æœåŠ¡
@EventListener
public void handleOrderCreated(OrderCreatedEvent event) {
    // è‡ªåŠ¨å‘é€é€šçŸ¥
    notificationService.send(event.getUserId(), "è®¢å•åˆ›å»ºæˆåŠŸ");
}
```

**3. å®Œå–„ç›‘æ§ä½“ç³»**

```
ç°çŠ¶ï¼šåªæœ‰åŸºç¡€ç›‘æ§

æ”¹è¿›ï¼š
- è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡ï¼ˆè®¢å•é‡ã€åº“å­˜é¢„è­¦ç­‰ï¼‰
- å…¨é“¾è·¯è¿½è¸ªï¼ˆSkyWalking/Zipkinï¼‰
- å®æ—¶å‘Šè­¦ï¼ˆé’‰é’‰/é‚®ä»¶/çŸ­ä¿¡ï¼‰
- APMæ€§èƒ½åˆ†æ
```

**4. å¼•å…¥CQRSæ¨¡å¼**

```
ç°çŠ¶ï¼šæŸ¥è¯¢å’Œå†™å…¥ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®åº“

æ”¹è¿›ï¼šè¯»å†™åˆ†ç¦»
- å†™å…¥ï¼šPostgreSQLï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
- æŸ¥è¯¢ï¼šElasticsearchï¼ˆé«˜æ€§èƒ½ï¼‰
- é€šè¿‡CDCåŒæ­¥æ•°æ®

æ•ˆæœï¼š
- æŸ¥è¯¢æ€§èƒ½æå‡10å€+
- æ”¯æŒå¤æ‚æŸ¥è¯¢ï¼ˆå…¨æ–‡æœç´¢ã€èšåˆåˆ†æï¼‰
```

**5. ä½¿ç”¨GraphQL**

```
ç°çŠ¶ï¼šREST APIï¼Œå®¢æˆ·ç«¯éœ€è¦å¤šæ¬¡è¯·æ±‚

æ”¹è¿›ï¼šGraphQLï¼Œä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰æ•°æ®

// æŸ¥è¯¢è®¢å•è¯¦æƒ…ï¼ˆåŒ…å«ç”¨æˆ·ã€å•†å“ã€ç‰©æµï¼‰
query {
  order(id: "123") {
    orderNo
    totalAmount
    user {
      name
      phone
    }
    product {
      name
      price
    }
    logistics {
      status
      currentCity
    }
  }
}

æ•ˆæœï¼š
- å‡å°‘ç½‘ç»œè¯·æ±‚
- å®¢æˆ·ç«¯æŒ‰éœ€è·å–æ•°æ®
- æå‡ç”¨æˆ·ä½“éªŒ
```

---

## ğŸ¯ é¢è¯•æŠ€å·§æ€»ç»“

### å›ç­”é—®é¢˜çš„STARæ³•åˆ™

**S (Situation)**ï¼šåœºæ™¯/èƒŒæ™¯
- é¡¹ç›®èƒŒæ™¯
- é‡åˆ°çš„é—®é¢˜

**T (Task)**ï¼šä»»åŠ¡
- ä½ çš„èŒè´£
- è¦è§£å†³ä»€ä¹ˆ

**A (Action)**ï¼šè¡ŒåŠ¨
- ä½ åšäº†ä»€ä¹ˆ
- æŠ€æœ¯é€‰å‹
- å®ç°æ–¹æ¡ˆ

**R (Result)**ï¼šç»“æœ
- æ•ˆæœå¦‚ä½•
- æ•°æ®æŒ‡æ ‡
- æ”¶è·ç»éªŒ

### ç¤ºä¾‹å›ç­”

**é—®é¢˜**ï¼šä½ åœ¨é¡¹ç›®ä¸­æ˜¯å¦‚ä½•ä¼˜åŒ–æ€§èƒ½çš„ï¼Ÿ

**å›ç­”**ï¼š

**S**: æˆ‘ä»¬çš„è®¢å•æœåŠ¡åœ¨é«˜å³°æœŸå“åº”æ…¢ï¼Œå¹³å‡500msï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

**T**: æˆ‘è´Ÿè´£å¯¹è®¢å•æœåŠ¡è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œç›®æ ‡æ˜¯å°†å“åº”æ—¶é—´é™åˆ°100msä»¥å†…ã€‚

**A**: æˆ‘é‡‡å–äº†ä»¥ä¸‹æªæ–½ï¼š
1. ä½¿ç”¨CompletableFutureå¹¶è¡ŒæŸ¥è¯¢ï¼Œå°†ä¸²è¡Œæ”¹ä¸ºå¹¶è¡Œ
2. å¼•å…¥Redisç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
3. ä¼˜åŒ–SQLï¼Œæ·»åŠ åˆé€‚çš„ç´¢å¼•
4. ä½¿ç”¨Caffeineæœ¬åœ°ç¼“å­˜ï¼Œå®ç°å¤šçº§ç¼“å­˜

**R**: ä¼˜åŒ–åå“åº”æ—¶é—´é™åˆ°80msï¼Œæå‡äº†83%ï¼Œç”¨æˆ·ä½“éªŒæ˜æ˜¾æ”¹å–„ï¼Œè½¬åŒ–ç‡æå‡15%ã€‚

---

## ğŸ é™„å½•ï¼šé«˜é¢‘é—®é¢˜å¿«é€Ÿç´¢å¼•

### JavaåŸºç¡€
- HashMapåŸç† â†’ 2.1
- ConcurrentHashMapåŸç† â†’ 2.2
- JVMå†…å­˜æ¨¡å‹å’ŒGC â†’ 2.3

### Springæ¡†æ¶
- Beanç”Ÿå‘½å‘¨æœŸ â†’ 3.1
- äº‹åŠ¡ä¼ æ’­æœºåˆ¶ â†’ 3.2
- AOPåŸç† â†’ 3.3

### å¾®æœåŠ¡
- Nacosæ³¨å†Œä¸­å¿ƒ â†’ 4.1
- Sentinelé™æµ â†’ 4.2
- æ¥å£å¹‚ç­‰æ€§ â†’ 4.3

### ä¸­é—´ä»¶
- Redisåº”ç”¨ â†’ 5.1
- Kafkaåº”ç”¨ â†’ 5.2

### æ•°æ®åº“
- SQLä¼˜åŒ– â†’ 6.1
- è¿æ¥æ± é…ç½® â†’ 6.2

### æ€§èƒ½ä¼˜åŒ–
- JVMè°ƒä¼˜ â†’ 7.1
- æ¥å£ä¼˜åŒ– â†’ 7.2

### äº‘åŸç”Ÿ
- K8séƒ¨ç½² â†’ 8.1
- Dockerä¼˜åŒ– â†’ 8.2

### ä¸šåŠ¡åœºæ™¯
- é˜²æ­¢è¶…å– â†’ 9.1
- é«˜å¹¶å‘ä¸‹å• â†’ 9.2

### ç»¼åˆé—®é¢˜
- æœ€å¤§æŒ‘æˆ˜ â†’ 10.1
- é¡¹ç›®æ”¹è¿› â†’ 10.2

---

**ç¥ä½ é¢è¯•æˆåŠŸï¼Œæ‹¿åˆ°æ»¡æ„çš„offerï¼åŠ æ²¹ï¼ğŸ’ªğŸš€**



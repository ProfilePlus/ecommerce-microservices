# Javaå¾®æœåŠ¡äº‘åŸç”Ÿé«˜çº§ç‰ˆéƒ¨ç½²æŒ‡å—

## ğŸ“‹ é«˜çº§ç‰ˆæ¦‚è¿°

æœ¬é«˜çº§ç‰ˆæ–‡æ¡£æ˜¯åœ¨**åŸºç¡€ç‰ˆ**å’Œ**å‡çº§ç‰ˆ**ä¹‹ä¸Šçš„è¿›ä¸€æ­¥æå‡ï¼Œèšç„¦äºäº‘åŸç”Ÿã€æ€§èƒ½è°ƒä¼˜ã€é«˜å¯ç”¨æ¶æ„ç­‰ä¼ä¸šçº§æ ¸å¿ƒèƒ½åŠ›ã€‚

### ğŸ¯ ç‰ˆæœ¬å®šä½

| ç‰ˆæœ¬ | æŠ€æœ¯å±‚çº§ | ç›®æ ‡å²—ä½ | è–ªèµ„èŒƒå›´ |
|------|---------|---------|---------|
| **åŸºç¡€ç‰ˆ** | å…¥é—¨çº§ | åˆçº§å¼€å‘ | 8K-15K |
| **å‡çº§ç‰ˆ** | ä¸­çº§ | ä¸­çº§å¼€å‘ | 15K-25K |
| **é«˜çº§ç‰ˆ** | é«˜çº§ | é«˜çº§/æ¶æ„å¸ˆ | 25K-45K |

### ğŸ”¥ é«˜çº§ç‰ˆæ ¸å¿ƒèƒ½åŠ›

**äº‘åŸç”Ÿæ¶æ„**ï¼š
- âœ… Kubernetes å®Œæ•´ç”Ÿäº§éƒ¨ç½²
- âœ… Helm åº”ç”¨æ‰“åŒ…ä¸ç®¡ç†
- âœ… HPA è‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… Istio æœåŠ¡ç½‘æ ¼
- âœ… ç°åº¦å‘å¸ƒä¸é‡‘ä¸é›€éƒ¨ç½²

**æ€§èƒ½è°ƒä¼˜**ï¼š
- âœ… JVM æ·±åº¦è°ƒä¼˜
- âœ… GC æ—¥å¿—åˆ†æ
- âœ… Arthas åœ¨çº¿è¯Šæ–­
- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- âœ… æ…¢æŸ¥è¯¢ä¼˜åŒ–

**é«˜å¯ç”¨æ¶æ„**ï¼š
- âœ… å¤šæœºæˆ¿å®¹ç¾
- âœ… å¼‚åœ°å¤šæ´»
- âœ… è‡ªåŠ¨æ•…éšœåˆ‡æ¢
- âœ… å®Œæ•´ç›‘æ§å‘Šè­¦ä½“ç³»

**ä¸šåŠ¡æ·±åº¦**ï¼š
- âœ… æ”¯ä»˜ç³»ç»Ÿè®¾è®¡
- âœ… å¯¹è´¦ç³»ç»Ÿ
- âœ… å¹‚ç­‰æ€§ä¿è¯

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šKubernetes ç”Ÿäº§çº§éƒ¨ç½²

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ Kubernetesï¼Ÿ

**å‡çº§ç‰ˆé—®é¢˜**ï¼š
- Docker Compose åªèƒ½å•æœºéƒ¨ç½²
- æ— æ³•è‡ªåŠ¨æ‰©ç¼©å®¹
- æ— æ³•è‡ªåŠ¨æ•…éšœæ¢å¤
- ç¼ºå°‘æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡

**é«˜çº§ç‰ˆæ–¹æ¡ˆ**ï¼šä½¿ç”¨ Kubernetes å®ç°å®¹å™¨ç¼–æ’ï¼Œæ”¯æŒè‡ªåŠ¨æ‰©ç¼©å®¹ã€æ•…éšœè‡ªæ„ˆã€æ»šåŠ¨æ›´æ–°ã€‚

### 1.2 æ­å»º Kubernetes é›†ç¾¤

#### 1.2.1 ä½¿ç”¨ K3sï¼ˆè½»é‡çº§ K8sï¼Œé€‚åˆå­¦ä¹ ï¼‰

```bash
# åœ¨ä¸»èŠ‚ç‚¹å®‰è£… K3s
curl -sfL https://get.k3s.io | sh -

# æŸ¥çœ‹èŠ‚ç‚¹
sudo k3s kubectl get nodes

# é…ç½® kubectlï¼ˆå¯é€‰ï¼‰
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $USER ~/.kube/config

# éªŒè¯
kubectl get nodes
kubectl get pods -A
```

#### 1.2.2 å®‰è£… Helmï¼ˆKubernetes åŒ…ç®¡ç†å™¨ï¼‰

```bash
# ä¸‹è½½ Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# éªŒè¯
helm version

# æ·»åŠ å¸¸ç”¨ Chart ä»“åº“
helm repo add stable https://charts.helm.sh/stable
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update
```

### 1.3 éƒ¨ç½²ä¸­é—´ä»¶åˆ° Kubernetes

#### 1.3.1 éƒ¨ç½² PostgreSQLï¼ˆä½¿ç”¨ Helmï¼‰

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace middleware

# ä½¿ç”¨ Helm éƒ¨ç½² PostgreSQL
helm install postgres bitnami/postgresql \
  --namespace middleware \
  --set auth.username=admin \
  --set auth.password=Admin@123 \
  --set auth.database=order_db \
  --set primary.persistence.size=10Gi

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n middleware
kubectl get svc -n middleware

# è·å–è¿æ¥ä¿¡æ¯
export POSTGRES_PASSWORD=$(kubectl get secret --namespace middleware postgres-postgresql -o jsonpath="{.data.postgres-password}" | base64 -d)
echo "PostgreSQL å¯†ç : $POSTGRES_PASSWORD"

# ç«¯å£è½¬å‘ï¼ˆæœ¬åœ°è®¿é—®ï¼‰
kubectl port-forward --namespace middleware svc/postgres-postgresql 5432:5432 &
```

#### 1.3.2 éƒ¨ç½² Redisï¼ˆä½¿ç”¨ Helmï¼‰

```bash
helm install redis bitnami/redis \
  --namespace middleware \
  --set auth.password=redis \
  --set master.persistence.size=5Gi

# æŸ¥çœ‹å¯†ç 
export REDIS_PASSWORD=$(kubectl get secret --namespace middleware redis -o jsonpath="{.data.redis-password}" | base64 -d)
echo "Redis å¯†ç : $REDIS_PASSWORD"

# ç«¯å£è½¬å‘
kubectl port-forward --namespace middleware svc/redis-master 6379:6379 &
```

#### 1.3.3 éƒ¨ç½² Kafkaï¼ˆä½¿ç”¨ Helmï¼‰

```bash
helm install kafka bitnami/kafka \
  --namespace middleware \
  --set persistence.size=10Gi \
  --set replicaCount=3

# æŸ¥çœ‹ Kafka Pods
kubectl get pods -n middleware | grep kafka
```

#### 1.3.4 éƒ¨ç½² Nacosï¼ˆä½¿ç”¨ YAMLï¼‰

åˆ›å»º `nacos-deployment.yaml`ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nacos
  namespace: middleware
spec:
  selector:
    app: nacos
  ports:
  - name: http
    port: 8848
    targetPort: 8848
  - name: grpc
    port: 9848
    targetPort: 9848
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nacos
  namespace: middleware
spec:
  serviceName: nacos
  replicas: 1
  selector:
    matchLabels:
      app: nacos
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
      - name: nacos
        image: nacos/nacos-server:v2.2.3
        ports:
        - containerPort: 8848
          name: http
        - containerPort: 9848
          name: grpc
        env:
        - name: MODE
          value: "standalone"
        - name: NACOS_AUTH_ENABLE
          value: "true"
        volumeMounts:
        - name: nacos-data
          mountPath: /home/nacos/data
  volumeClaimTemplates:
  - metadata:
      name: nacos-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 5Gi
```

éƒ¨ç½²ï¼š

```bash
kubectl apply -f nacos-deployment.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n middleware | grep nacos
kubectl get svc -n middleware | grep nacos
```

### 1.4 ä½¿ç”¨ Helm æ‰“åŒ…å¾®æœåŠ¡

#### 1.4.1 åˆ›å»º Helm Chart

```bash
# ä¸ºè®¢å•æœåŠ¡åˆ›å»º Helm Chart
helm create order-service

cd order-service/

# ç›®å½•ç»“æ„
# order-service/
# â”œâ”€â”€ Chart.yaml          # Chart å…ƒæ•°æ®
# â”œâ”€â”€ values.yaml         # é»˜è®¤é…ç½®å€¼
# â””â”€â”€ templates/          # K8s èµ„æºæ¨¡æ¿
#     â”œâ”€â”€ deployment.yaml
#     â”œâ”€â”€ service.yaml
#     â””â”€â”€ ingress.yaml
```

#### 1.4.2 é…ç½® Chart.yaml

```yaml
apiVersion: v2
name: order-service
description: è®¢å•æœåŠ¡ Helm Chart
type: application
version: 1.0.0
appVersion: "1.0.0"
```

#### 1.4.3 é…ç½® values.yaml

```yaml
replicaCount: 2

image:
  repository: order-service
  pullPolicy: IfNotPresent
  tag: "1.0.0"

service:
  type: ClusterIP
  port: 8081

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

env:
  - name: SPRING_PROFILES_ACTIVE
    value: "k8s"
  - name: JAVA_OPTS
    value: "-Xms512m -Xmx1g -XX:+UseG1GC"

# Nacos é…ç½®
nacos:
  serverAddr: "nacos.middleware:8848"
  namespace: "public"

# PostgreSQL é…ç½®
postgres:
  host: "postgres-postgresql.middleware"
  port: 5432
  database: "order_db"
  username: "admin"
  password: "Admin@123"

# Redis é…ç½®
redis:
  host: "redis-master.middleware"
  port: 6379
  password: "redis"

# Kafka é…ç½®
kafka:
  bootstrapServers: "kafka.middleware:9092"
```

#### 1.4.4 é…ç½® Deployment æ¨¡æ¿

ç¼–è¾‘ `templates/deployment.yaml`ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "order-service.fullname" . }}
  labels:
    {{- include "order-service.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "order-service.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "order-service.selectorLabels" . | nindent 8 }}
    spec:
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: 8081
          protocol: TCP
        env:
        {{- range .Values.env }}
        - name: {{ .name }}
          value: {{ .value | quote }}
        {{- end }}
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:postgresql://{{ .Values.postgres.host }}:{{ .Values.postgres.port }}/{{ .Values.postgres.database }}"
        - name: SPRING_DATASOURCE_USERNAME
          value: {{ .Values.postgres.username }}
        - name: SPRING_DATASOURCE_PASSWORD
          value: {{ .Values.postgres.password }}
        - name: SPRING_REDIS_HOST
          value: {{ .Values.redis.host }}
        - name: SPRING_REDIS_PORT
          value: {{ .Values.redis.port | quote }}
        - name: SPRING_REDIS_PASSWORD
          value: {{ .Values.redis.password }}
        - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
          value: {{ .Values.kafka.bootstrapServers }}
        - name: SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR
          value: {{ .Values.nacos.serverAddr }}
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: http
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
```

#### 1.4.5 éƒ¨ç½²åº”ç”¨

```bash
# æ„å»º Docker é•œåƒ
cd ~/ecommerce-microservices
docker build -t order-service:1.0.0 ./order-service

# éƒ¨ç½²åˆ° K8s
helm install order-service ./order-service-chart \
  --namespace apps \
  --create-namespace

# æŸ¥çœ‹éƒ¨ç½²
kubectl get pods -n apps
kubectl get svc -n apps

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f -n apps -l app=order-service

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe pod -n apps -l app=order-service
```

### 1.5 é…ç½® HPAï¼ˆæ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰

#### 1.5.1 å®‰è£… Metrics Server

```bash
# K3s å·²å†…ç½® Metrics Serverï¼Œæ— éœ€å®‰è£…
# å¦‚æœä½¿ç”¨æ ‡å‡† K8sï¼Œæ‰§è¡Œï¼š
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# éªŒè¯
kubectl top nodes
kubectl top pods -n apps
```

#### 1.5.2 åˆ›å»º HPA

ç¼–è¾‘ `templates/hpa.yaml`ï¼š

```yaml
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "order-service.fullname" . }}
  labels:
    {{- include "order-service.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "order-service.fullname" . }}
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
  {{- if .Values.autoscaling.targetCPUUtilizationPercentage }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetCPUUtilizationPercentage }}
  {{- end }}
  {{- if .Values.autoscaling.targetMemoryUtilizationPercentage }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetMemoryUtilizationPercentage }}
  {{- end }}
{{- end }}
```

#### 1.5.3 æµ‹è¯•è‡ªåŠ¨æ‰©å®¹

```bash
# æŸ¥çœ‹ HPA çŠ¶æ€
kubectl get hpa -n apps

# å‹æµ‹è§¦å‘æ‰©å®¹
kubectl run -it --rm load-generator --image=busybox /bin/sh
# åœ¨å®¹å™¨å†…æ‰§è¡Œ
while true; do wget -q -O- http://order-service.apps:8081/api/orders/health; done

# è§‚å¯Ÿ HPAï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰
kubectl get hpa -n apps -w

# æŸ¥çœ‹ Pod æ•°é‡å˜åŒ–
kubectl get pods -n apps -w
```

### 1.6 é…ç½® Ingressï¼ˆç»Ÿä¸€å…¥å£ï¼‰

#### 1.6.1 å®‰è£… Ingress Controllerï¼ˆNginxï¼‰

```bash
# K3s å·²å†…ç½® Traefikï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
# å¦‚æœæƒ³ç”¨ Nginx Ingressï¼š
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

helm install nginx-ingress ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace
```

#### 1.6.2 åˆ›å»º Ingress è§„åˆ™

ç¼–è¾‘ `templates/ingress.yaml`ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "order-service.fullname" . }}
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: api.ecommerce.com
    http:
      paths:
      - path: /api/orders
        pathType: Prefix
        backend:
          service:
            name: {{ include "order-service.fullname" . }}
            port:
              number: 8081
```

éƒ¨ç½²åè®¿é—®ï¼š

```bash
# é…ç½®æœ¬åœ° hosts
echo "192.168.xxx.xxx api.ecommerce.com" | sudo tee -a /etc/hosts

# æµ‹è¯•
curl http://api.ecommerce.com/api/orders/health
```

### 1.7 ConfigMap å’Œ Secret ç®¡ç†é…ç½®

#### 1.7.1 ä½¿ç”¨ ConfigMap ç®¡ç†é…ç½®

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: order-service-config
  namespace: apps
data:
  application.yml: |
    server:
      port: 8081
    spring:
      application:
        name: order-service
    management:
      endpoints:
        web:
          exposure:
            include: '*'
```

#### 1.7.2 ä½¿ç”¨ Secret ç®¡ç†æ•æ„Ÿä¿¡æ¯

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: order-service-secret
  namespace: apps
type: Opaque
stringData:
  postgres-password: Admin@123
  redis-password: redis
  kafka-password: ""
```

åœ¨ Deployment ä¸­å¼•ç”¨ï¼š

```yaml
env:
- name: POSTGRES_PASSWORD
  valueFrom:
    secretKeyRef:
      name: order-service-secret
      key: postgres-password
- name: REDIS_PASSWORD
  valueFrom:
    secretKeyRef:
      name: order-service-secret
      key: redis-password
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šIstio æœåŠ¡ç½‘æ ¼

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ Istioï¼Ÿ

**Kubernetes çš„å±€é™**ï¼š
- ç¼ºå°‘æœåŠ¡é—´åŠ å¯†
- æµé‡ç®¡ç†èƒ½åŠ›å¼±
- æ— æ³•ç»†ç²’åº¦æ§åˆ¶æµé‡
- ç¼ºå°‘æœåŠ¡é—´å¯è§‚æµ‹æ€§

**Istio çš„ä¼˜åŠ¿**ï¼š
- æµé‡ç®¡ç†ï¼ˆç°åº¦å‘å¸ƒã€é‡‘ä¸é›€éƒ¨ç½²ã€A/B æµ‹è¯•ï¼‰
- æœåŠ¡é—´ mTLS åŠ å¯†
- æµé‡ç›‘æ§å’Œè¿½è¸ª
- ç†”æ–­ã€é‡è¯•ã€è¶…æ—¶

### 2.2 å®‰è£… Istio

```bash
# ä¸‹è½½ Istio
curl -L https://istio.io/downloadIstio | sh -
cd istio-1.20.0

# æ·»åŠ åˆ° PATH
export PATH=$PWD/bin:$PATH

# å®‰è£… Istioï¼ˆä½¿ç”¨ demo profileï¼‰
istioctl install --set profile=demo -y

# éªŒè¯å®‰è£…
kubectl get pods -n istio-system

# å¯ç”¨ Sidecar è‡ªåŠ¨æ³¨å…¥
kubectl label namespace apps istio-injection=enabled

# é‡æ–°éƒ¨ç½²åº”ç”¨ï¼ˆæ³¨å…¥ Sidecarï¼‰
kubectl rollout restart deployment -n apps
```

### 2.3 æµé‡ç®¡ç†

#### 2.3.1 ç°åº¦å‘å¸ƒï¼ˆé‡‘ä¸é›€éƒ¨ç½²ï¼‰

å‡è®¾æˆ‘ä»¬è¦å°†è®¢å•æœåŠ¡ä» v1 ç°åº¦å‡çº§åˆ° v2ï¼š

**æ­¥éª¤1ï¼šéƒ¨ç½²ä¸¤ä¸ªç‰ˆæœ¬**

```yaml
# v1 ç‰ˆæœ¬ï¼ˆå·²éƒ¨ç½²ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service-v1
  namespace: apps
spec:
  replicas: 3
  selector:
    matchLabels:
      app: order-service
      version: v1
  template:
    metadata:
      labels:
        app: order-service
        version: v1
    spec:
      containers:
      - name: order-service
        image: order-service:1.0.0
        ports:
        - containerPort: 8081
---
# v2 ç‰ˆæœ¬ï¼ˆæ–°ç‰ˆæœ¬ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service-v2
  namespace: apps
spec:
  replicas: 1
  selector:
    matchLabels:
      app: order-service
      version: v2
  template:
    metadata:
      labels:
        app: order-service
        version: v2
    spec:
      containers:
      - name: order-service
        image: order-service:2.0.0
        ports:
        - containerPort: 8081
```

**æ­¥éª¤2ï¼šåˆ›å»º VirtualServiceï¼ˆæµé‡è·¯ç”±ï¼‰**

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service
  namespace: apps
spec:
  hosts:
  - order-service
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: order-service
        subset: v2
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
    - destination:
        host: order-service
        subset: v2
      weight: 10
```

**æ­¥éª¤3ï¼šåˆ›å»º DestinationRuleï¼ˆå­é›†å®šä¹‰ï¼‰**

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service
  namespace: apps
spec:
  host: order-service
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
```

éƒ¨ç½²ï¼š

```bash
kubectl apply -f order-service-v1.yaml
kubectl apply -f order-service-v2.yaml
kubectl apply -f virtualservice.yaml
kubectl apply -f destinationrule.yaml

# æµ‹è¯•ç°åº¦å‘å¸ƒ
# 90% æµé‡åˆ° v1ï¼Œ10% æµé‡åˆ° v2
for i in {1..20}; do
  curl http://order-service.apps:8081/api/orders/health
done

# å¸¦ canary header çš„è¯·æ±‚å…¨éƒ¨åˆ° v2
curl -H "canary: true" http://order-service.apps:8081/api/orders/health
```

**æ­¥éª¤4ï¼šé€æ­¥è°ƒæ•´æµé‡æ¯”ä¾‹**

```yaml
# è°ƒæ•´ä¸º 50:50
http:
- route:
  - destination:
      host: order-service
      subset: v1
    weight: 50
  - destination:
      host: order-service
      subset: v2
    weight: 50
```

```bash
kubectl apply -f virtualservice.yaml
```

**æ­¥éª¤5ï¼šå®Œå…¨åˆ‡æ¢åˆ° v2**

```yaml
# 100% æµé‡åˆ° v2
http:
- route:
  - destination:
      host: order-service
      subset: v2
    weight: 100
```

**æ­¥éª¤6ï¼šä¸‹çº¿ v1**

```bash
kubectl delete deployment order-service-v1 -n apps
```

#### 2.3.2 A/B æµ‹è¯•ï¼ˆåŸºäºè¯·æ±‚å¤´ï¼‰

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service-ab
  namespace: apps
spec:
  hosts:
  - order-service
  http:
  # iOS ç”¨æˆ·ä½¿ç”¨ v2
  - match:
    - headers:
        user-agent:
          regex: ".*iPhone.*"
    route:
    - destination:
        host: order-service
        subset: v2
  # Android ç”¨æˆ·ä½¿ç”¨ v1
  - match:
    - headers:
        user-agent:
          regex: ".*Android.*"
    route:
    - destination:
        host: order-service
        subset: v1
  # å…¶ä»–ç”¨æˆ·éšæœº
  - route:
    - destination:
        host: order-service
        subset: v1
      weight: 50
    - destination:
        host: order-service
        subset: v2
      weight: 50
```

#### 2.3.3 è“ç»¿éƒ¨ç½²

```yaml
# åˆå§‹çŠ¶æ€ï¼šå…¨éƒ¨æµé‡åˆ°è“è‰²ï¼ˆv1ï¼‰
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service-bluegreen
  namespace: apps
spec:
  hosts:
  - order-service
  http:
  - route:
    - destination:
        host: order-service
        subset: blue
      weight: 100
    - destination:
        host: order-service
        subset: green
      weight: 0
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service-bluegreen
  namespace: apps
spec:
  host: order-service
  subsets:
  - name: blue
    labels:
      version: v1
  - name: green
    labels:
      version: v2
```

åˆ‡æ¢åˆ°ç»¿è‰²ç¯å¢ƒï¼š

```yaml
# ä¸€é”®åˆ‡æ¢ï¼šå…¨éƒ¨æµé‡åˆ°ç»¿è‰²ï¼ˆv2ï¼‰
http:
- route:
  - destination:
      host: order-service
      subset: blue
    weight: 0
  - destination:
      host: order-service
      subset: green
    weight: 100
```

### 2.4 ç†”æ–­å’Œé‡è¯•

```yaml
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: order-service-circuit-breaker
  namespace: apps
spec:
  host: order-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        http2MaxRequests: 100
        maxRequestsPerConnection: 2
    outlierDetection:
      consecutiveErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
      minHealthPercent: 40
```

### 2.5 æœåŠ¡é—´ mTLS åŠ å¯†

```yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: apps
spec:
  mtls:
    mode: STRICT
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šJVM æ€§èƒ½è°ƒä¼˜

### 3.1 JVM å‚æ•°é…ç½®

#### 3.1.1 åŸºç¡€å‚æ•°

åœ¨ Kubernetes Deployment ä¸­é…ç½® JVM å‚æ•°ï¼š

```yaml
env:
- name: JAVA_OPTS
  value: >-
    -Xms1g
    -Xmx2g
    -XX:+UseG1GC
    -XX:MaxGCPauseMillis=200
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:HeapDumpPath=/tmp/heapdump.hprof
    -XX:+PrintGCDetails
    -XX:+PrintGCDateStamps
    -Xloggc:/tmp/gc.log
    -XX:+UseGCLogFileRotation
    -XX:NumberOfGCLogFiles=5
    -XX:GCLogFileSize=20M
```

å‚æ•°è¯´æ˜ï¼š

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|------|------|--------|
| `-Xms` | åˆå§‹å †å¤§å° | ä¸ Xmx ç›¸åŒ |
| `-Xmx` | æœ€å¤§å †å¤§å° | å®¹å™¨å†…å­˜çš„ 70% |
| `-XX:+UseG1GC` | ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨ | æ¨èï¼ˆé€‚åˆå¤§å †ï¼‰ |
| `-XX:MaxGCPauseMillis` | æœ€å¤§ GC åœé¡¿æ—¶é—´ | 200ms |
| `-XX:+HeapDumpOnOutOfMemoryError` | OOM æ—¶ç”Ÿæˆå †è½¬å‚¨ | å¿…é¡»å¼€å¯ |
| `-XX:+PrintGCDetails` | æ‰“å° GC è¯¦æƒ… | ç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯ |

#### 3.1.2 ä¸åŒåœºæ™¯çš„ JVM å‚æ•°

**é«˜åååœºæ™¯**ï¼ˆé€‚åˆè®¢å•æœåŠ¡ï¼‰ï¼š

```bash
JAVA_OPTS="
  -Xms2g -Xmx2g
  -XX:+UseG1GC
  -XX:MaxGCPauseMillis=200
  -XX:G1ReservePercent=10
  -XX:InitiatingHeapOccupancyPercent=45
"
```

**ä½å»¶è¿Ÿåœºæ™¯**ï¼ˆé€‚åˆæ”¯ä»˜æœåŠ¡ï¼‰ï¼š

```bash
JAVA_OPTS="
  -Xms2g -Xmx2g
  -XX:+UseShenandoahGC
  -XX:ShenandoahGCHeuristics=compact
"
```

**å¤§å†…å­˜åœºæ™¯**ï¼ˆé€‚åˆæœç´¢æœåŠ¡ï¼‰ï¼š

```bash
JAVA_OPTS="
  -Xms8g -Xmx8g
  -XX:+UseG1GC
  -XX:G1HeapRegionSize=16m
  -XX:MaxGCPauseMillis=100
"
```

### 3.2 GC æ—¥å¿—åˆ†æ

#### 3.2.1 æ”¶é›† GC æ—¥å¿—

```bash
# ä» Pod ä¸­å¤åˆ¶ GC æ—¥å¿—
kubectl cp apps/order-service-xxx:/tmp/gc.log ./gc.log

# æˆ–è€…ç›´æ¥æŸ¥çœ‹
kubectl exec -it -n apps order-service-xxx -- cat /tmp/gc.log
```

#### 3.2.2 ä½¿ç”¨ GCViewer åˆ†æ

```bash
# ä¸‹è½½ GCViewer
wget https://github.com/chewiebug/GCViewer/releases/download/1.37/gcviewer-1.37.jar

# åˆ†æ GC æ—¥å¿—
java -jar gcviewer-1.37.jar gc.log
```

#### 3.2.3 å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | æ­£å¸¸å€¼ |
|------|------|--------|
| **Young GC é¢‘ç‡** | å¹´è½»ä»£ GC é¢‘ç‡ | < 1æ¬¡/ç§’ |
| **Young GC æ—¶é—´** | å•æ¬¡ YGC è€—æ—¶ | < 50ms |
| **Full GC é¢‘ç‡** | è€å¹´ä»£ GC é¢‘ç‡ | < 1æ¬¡/å°æ—¶ |
| **Full GC æ—¶é—´** | å•æ¬¡ FGC è€—æ—¶ | < 1ç§’ |
| **å †å†…å­˜ä½¿ç”¨ç‡** | å¹³å‡å †ä½¿ç”¨ç‡ | < 80% |
| **GC æ€»æ—¶é—´å æ¯”** | GC æ—¶é—´/è¿è¡Œæ—¶é—´ | < 5% |

### 3.3 ä½¿ç”¨ Arthas åœ¨çº¿è¯Šæ–­

#### 3.3.1 å®‰è£… Arthas

åœ¨ Dockerfile ä¸­æ·»åŠ  Arthasï¼š

```dockerfile
FROM openjdk:8-jdk-alpine

# ä¸‹è½½ Arthas
RUN wget https://arthas.aliyun.com/arthas-boot.jar -O /opt/arthas-boot.jar

# å¤åˆ¶åº”ç”¨
COPY target/order-service-1.0.0.jar /app.jar

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

#### 3.3.2 å¯åŠ¨ Arthas

```bash
# è¿›å…¥ Pod
kubectl exec -it -n apps order-service-xxx -- /bin/sh

# å¯åŠ¨ Arthas
java -jar /opt/arthas-boot.jar

# é€‰æ‹©è¦è¯Šæ–­çš„ Java è¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯ 1ï¼‰
```

#### 3.3.3 å¸¸ç”¨è¯Šæ–­å‘½ä»¤

**1. æŸ¥çœ‹ JVM ä¿¡æ¯**

```bash
# JVM åŸºæœ¬ä¿¡æ¯
dashboard

# å†…å­˜ä½¿ç”¨æƒ…å†µ
memory

# çº¿ç¨‹ä¿¡æ¯
thread

# æŸ¥çœ‹æ­»é”
thread -b

# æŸ¥çœ‹ CPU å ç”¨æœ€é«˜çš„çº¿ç¨‹
thread -n 3
```

**2. ç›‘æ§æ–¹æ³•è°ƒç”¨**

```bash
# ç›‘æ§æ–¹æ³•æ‰§è¡Œæ—¶é—´
monitor -c 5 com.demo.order.service.OrderService createOrder

# æŸ¥çœ‹æ–¹æ³•è°ƒç”¨å‚æ•°å’Œè¿”å›å€¼
watch com.demo.order.service.OrderService createOrder "{params,returnObj}" -x 2

# è¿½è¸ªæ–¹æ³•è°ƒç”¨é“¾è·¯
trace com.demo.order.service.OrderService createOrder

# ç»Ÿè®¡æ–¹æ³•è°ƒç”¨è€—æ—¶
trace com.demo.order.service.OrderService createOrder '#cost > 100'
```

**3. çƒ­æ›´æ–°ä»£ç **

```bash
# åç¼–è¯‘ç±»
jad com.demo.order.service.OrderService

# ä¿®æ”¹ä»£ç åé‡æ–°ç¼–è¯‘
# ä½¿ç”¨ redefine çƒ­æ›´æ–°ï¼ˆæ— éœ€é‡å¯ï¼‰
redefine /tmp/OrderService.class
```

**4. ç«ç„°å›¾åˆ†æ**

```bash
# ç”Ÿæˆç«ç„°å›¾ï¼ˆåˆ†æ CPU çƒ­ç‚¹ï¼‰
profiler start

# ç­‰å¾…ä¸€æ®µæ—¶é—´...

# ç”Ÿæˆç»“æœ
profiler stop --format html --file /tmp/flamegraph.html

# å¤åˆ¶åˆ°æœ¬åœ°æŸ¥çœ‹
kubectl cp apps/order-service-xxx:/tmp/flamegraph.html ./flamegraph.html
```

### 3.4 å†…å­˜æ³„æ¼æ’æŸ¥

#### 3.4.1 è§¦å‘å †è½¬å‚¨

```bash
# æ–¹å¼1ï¼šç­‰å¾… OOM è‡ªåŠ¨ç”Ÿæˆï¼ˆå·²é…ç½® -XX:+HeapDumpOnOutOfMemoryErrorï¼‰

# æ–¹å¼2ï¼šæ‰‹åŠ¨ç”Ÿæˆ
kubectl exec -n apps order-service-xxx -- jmap -dump:live,format=b,file=/tmp/heapdump.hprof 1

# å¤åˆ¶åˆ°æœ¬åœ°
kubectl cp apps/order-service-xxx:/tmp/heapdump.hprof ./heapdump.hprof
```

#### 3.4.2 ä½¿ç”¨ MAT åˆ†æ

```bash
# ä¸‹è½½ Eclipse MAT
# https://www.eclipse.org/mat/downloads.php

# æ‰“å¼€ heapdump.hprof

# å…³é”®åˆ†æï¼š
# 1. Leak Suspectsï¼ˆå†…å­˜æ³„æ¼ç–‘ç‚¹ï¼‰
# 2. Dominator Treeï¼ˆæ”¯é…æ ‘ï¼Œæ‰¾å‡ºæœ€å¤§å¯¹è±¡ï¼‰
# 3. Histogramï¼ˆç›´æ–¹å›¾ï¼ŒæŸ¥çœ‹å¯¹è±¡æ•°é‡ï¼‰
# 4. Top Consumersï¼ˆæ‰¾å‡ºå ç”¨æœ€å¤šå†…å­˜çš„å¯¹è±¡ï¼‰
```

#### 3.4.3 å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯

**åœºæ™¯1ï¼šThreadLocal æœªæ¸…ç†**

```java
// é—®é¢˜ä»£ç 
public class OrderService {
    private static ThreadLocal<Order> currentOrder = new ThreadLocal<>();
    
    public void processOrder(Order order) {
        currentOrder.set(order);
        // ... ä¸šåŠ¡é€»è¾‘
        // å¿˜è®°æ¸…ç†ï¼
    }
}

// æ­£ç¡®ä»£ç 
public void processOrder(Order order) {
    try {
        currentOrder.set(order);
        // ... ä¸šåŠ¡é€»è¾‘
    } finally {
        currentOrder.remove(); // å¿…é¡»æ¸…ç†
    }
}
```

**åœºæ™¯2ï¼šé›†åˆç±»æŒç»­å¢é•¿**

```java
// é—®é¢˜ä»£ç 
public class OrderCache {
    private static Map<String, Order> cache = new HashMap<>();
    
    public void addOrder(Order order) {
        cache.put(order.getOrderNo(), order);
        // æ²¡æœ‰æ¸…ç†æœºåˆ¶ï¼
    }
}

// æ­£ç¡®ä»£ç 
public class OrderCache {
    // ä½¿ç”¨ Guava Cache æˆ– Caffeineï¼Œè‡ªåŠ¨è¿‡æœŸ
    private static Cache<String, Order> cache = Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(30, TimeUnit.MINUTES)
            .build();
}
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šæ•°æ®åº“æ·±åº¦ä¼˜åŒ–

### 4.1 ç´¢å¼•ä¼˜åŒ–

#### 4.1.1 æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’

```sql
-- æŸ¥çœ‹æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM t_order 
WHERE user_id = 1001 
  AND status = 'PENDING' 
  AND create_time > '2025-01-01';
```

#### 4.1.2 åˆ›å»ºåˆé€‚çš„ç´¢å¼•

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_user_id ON t_order(user_id);

-- å¤åˆç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€åŸåˆ™ï¼‰
CREATE INDEX idx_user_status_time ON t_order(user_id, status, create_time);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•ç¬¦åˆæ¡ä»¶çš„è¡Œï¼‰
CREATE INDEX idx_pending_orders ON t_order(user_id, create_time)
WHERE status = 'PENDING';

-- åŒ…å«ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_order_with_amount ON t_order(user_id) 
INCLUDE (total_amount, product_name);
```

#### 4.1.3 ç´¢å¼•ä½¿ç”¨åŸåˆ™

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **æœ€å·¦å‰ç¼€** | å¤åˆç´¢å¼•å¿…é¡»ä»æœ€å·¦åˆ—å¼€å§‹åŒ¹é… | `(a,b,c)` å¯ç”¨äº `a`, `a,b`, `a,b,c` |
| **é¿å…ç´¢å¼•å¤±æ•ˆ** | ä¸è¦åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•° | âŒ `WHERE YEAR(create_time)=2025`<br>âœ… `WHERE create_time >= '2025-01-01'` |
| **é€‰æ‹©æ€§é«˜çš„åˆ—** | ç´¢å¼•åˆ—çš„å”¯ä¸€å€¼è¦å¤š | âœ… `order_no`<br>âŒ `sex`(åªæœ‰2ä¸ªå€¼) |
| **è¦†ç›–ç´¢å¼•** | æŸ¥è¯¢çš„åˆ—éƒ½åœ¨ç´¢å¼•ä¸­ | `SELECT user_id, status FROM t_order WHERE user_id=1` |

### 4.2 æ…¢æŸ¥è¯¢ä¼˜åŒ–

#### 4.2.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—

```sql
-- è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆ1ç§’ï¼‰
ALTER SYSTEM SET log_min_duration_statement = 1000;

-- é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

#### 4.2.2 å¸¸è§æ…¢æŸ¥è¯¢ä¼˜åŒ–

**ä¼˜åŒ–1ï¼šé¿å… SELECT ***

```sql
-- æ…¢
SELECT * FROM t_order WHERE user_id = 1001;

-- å¿«ï¼ˆåªæŸ¥è¯¢éœ€è¦çš„åˆ—ï¼‰
SELECT order_no, total_amount, status FROM t_order WHERE user_id = 1001;
```

**ä¼˜åŒ–2ï¼šåˆ†é¡µä¼˜åŒ–**

```sql
-- æ…¢ï¼ˆOFFSET å¾ˆå¤§æ—¶å¾ˆæ…¢ï¼‰
SELECT * FROM t_order 
ORDER BY create_time DESC 
LIMIT 10 OFFSET 10000;

-- å¿«ï¼ˆä½¿ç”¨æ¸¸æ ‡ï¼‰
SELECT * FROM t_order 
WHERE id > 10000
ORDER BY id 
LIMIT 10;
```

**ä¼˜åŒ–3ï¼šIN æ”¹ä¸º EXISTS**

```sql
-- æ…¢
SELECT * FROM t_order 
WHERE product_id IN (
    SELECT product_id FROM t_inventory WHERE stock > 0
);

-- å¿«
SELECT * FROM t_order o
WHERE EXISTS (
    SELECT 1 FROM t_inventory i 
    WHERE i.product_id = o.product_id AND i.stock > 0
);
```

**ä¼˜åŒ–4ï¼šJOIN ä¼˜åŒ–**

```sql
-- æ…¢ï¼ˆå­æŸ¥è¯¢ï¼‰
SELECT o.*, 
       (SELECT product_name FROM t_inventory WHERE product_id = o.product_id) as name
FROM t_order o;

-- å¿«ï¼ˆJOINï¼‰
SELECT o.*, i.product_name
FROM t_order o
LEFT JOIN t_inventory i ON i.product_id = o.product_id;
```

### 4.3 è¯»å†™åˆ†ç¦»

#### 4.3.1 é…ç½® PostgreSQL ä¸»ä»å¤åˆ¶

**ä¸»åº“é…ç½®** (`postgresql.conf`)ï¼š

```ini
wal_level = replica
max_wal_senders = 3
wal_keep_size = 64
```

åˆ›å»ºå¤åˆ¶ç”¨æˆ·ï¼š

```sql
CREATE ROLE replicator WITH REPLICATION LOGIN PASSWORD 'repl123';
```

**ä»åº“é…ç½®**ï¼š

```bash
# åœæ­¢ä»åº“
pg_ctl stop

# åŸºç¡€å¤‡ä»½
pg_basebackup -h ä¸»åº“IP -U replicator -D /var/lib/postgresql/data -Fp -Xs -P -R

# å¯åŠ¨ä»åº“
pg_ctl start
```

éªŒè¯å¤åˆ¶ï¼š

```sql
-- ä¸»åº“æŸ¥çœ‹
SELECT * FROM pg_stat_replication;

-- ä»åº“æŸ¥çœ‹
SELECT pg_is_in_recovery(); -- true è¡¨ç¤ºä»åº“
```

#### 4.3.2 åº”ç”¨å±‚è¯»å†™åˆ†ç¦»

ä½¿ç”¨ Spring Boot çš„ `@Transactional(readOnly = true)` é…ç½®ï¼š

```java
@Configuration
public class DataSourceConfig {
    
    @Bean
    @ConfigurationProperties("spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource routingDataSource() {
        Map<Object, Object> dataSourceMap = new HashMap<>();
        dataSourceMap.put("master", masterDataSource());
        dataSourceMap.put("slave", slaveDataSource());
        
        DynamicRoutingDataSource dataSource = new DynamicRoutingDataSource();
        dataSource.setDefaultTargetDataSource(masterDataSource());
        dataSource.setTargetDataSources(dataSourceMap);
        return dataSource;
    }
}

public class DynamicRoutingDataSource extends AbstractRoutingDataSource {
    @Override
    protected Object determineCurrentLookupKey() {
        return TransactionSynchronizationManager.isCurrentTransactionReadOnly() ? "slave" : "master";
    }
}
```

ä½¿ç”¨ï¼š

```java
@Service
public class OrderService {
    
    // å†™æ“ä½œï¼Œä½¿ç”¨ä¸»åº“
    @Transactional
    public void createOrder(Order order) {
        orderRepository.save(order);
    }
    
    // è¯»æ“ä½œï¼Œä½¿ç”¨ä»åº“
    @Transactional(readOnly = true)
    public List<Order> getUserOrders(Long userId) {
        return orderRepository.findByUserId(userId);
    }
}
```

### 4.4 è¿æ¥æ± ä¼˜åŒ–

#### 4.4.1 HikariCP å‚æ•°è°ƒä¼˜

```yaml
spring:
  datasource:
    hikari:
      # æœ€å°ç©ºé—²è¿æ¥æ•°
      minimum-idle: 10
      # æœ€å¤§è¿æ¥æ•°
      maximum-pool-size: 50
      # è¿æ¥è¶…æ—¶æ—¶é—´
      connection-timeout: 30000
      # ç©ºé—²è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´
      idle-timeout: 600000
      # è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´
      max-lifetime: 1800000
      # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      connection-test-query: SELECT 1
```

#### 4.4.2 ç›‘æ§è¿æ¥æ± 

```java
@Component
public class HikariPoolMonitor {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @Scheduled(fixedRate = 60000)
    public void logPoolStats() {
        HikariPoolMXBean poolMXBean = dataSource.getHikariPoolMXBean();
        
        log.info("=== HikariCP è¿æ¥æ± çŠ¶æ€ ===");
        log.info("Active: {}", poolMXBean.getActiveConnections());
        log.info("Idle: {}", poolMXBean.getIdleConnections());
        log.info("Total: {}", poolMXBean.getTotalConnections());
        log.info("Waiting: {}", poolMXBean.getThreadsAwaitingConnection());
    }
}
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®Œæ•´ç›‘æ§å‘Šè­¦ä½“ç³»

### 5.1 Prometheus æŒ‡æ ‡ç›‘æ§

#### 5.1.1 è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡

```java
@Component
public class OrderMetrics {
    
    private final Counter orderCreatedCounter;
    private final Counter orderFailedCounter;
    private final Histogram orderAmountHistogram;
    private final Gauge orderProcessingGauge;
    
    public OrderMetrics(MeterRegistry registry) {
        this.orderCreatedCounter = Counter.builder("order.created")
                .description("è®¢å•åˆ›å»ºæ€»æ•°")
                .tag("service", "order-service")
                .register(registry);
        
        this.orderFailedCounter = Counter.builder("order.failed")
                .description("è®¢å•å¤±è´¥æ€»æ•°")
                .tag("service", "order-service")
                .register(registry);
        
        this.orderAmountHistogram = Histogram.builder("order.amount")
                .description("è®¢å•é‡‘é¢åˆ†å¸ƒ")
                .buckets(100, 500, 1000, 5000, 10000)
                .register(registry);
        
        this.orderProcessingGauge = Gauge.builder("order.processing", this, OrderMetrics::getProcessingCount)
                .description("æ­£åœ¨å¤„ç†çš„è®¢å•æ•°")
                .register(registry);
    }
    
    public void recordOrderCreated() {
        orderCreatedCounter.increment();
    }
    
    public void recordOrderFailed() {
        orderFailedCounter.increment();
    }
    
    public void recordOrderAmount(BigDecimal amount) {
        orderAmountHistogram.observe(amount.doubleValue());
    }
    
    private double getProcessingCount() {
        // å®é™…ä¸šåŠ¡é€»è¾‘
        return 0;
    }
}
```

ä½¿ç”¨ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderMetrics orderMetrics;
    
    public OrderResponse createOrder(OrderRequest request) {
        try {
            // ä¸šåŠ¡é€»è¾‘...
            orderMetrics.recordOrderCreated();
            orderMetrics.recordOrderAmount(request.getTotalAmount());
            return response;
        } catch (Exception e) {
            orderMetrics.recordOrderFailed();
            throw e;
        }
    }
}
```

#### 5.1.2 é…ç½® Prometheus é‡‡é›†

```yaml
scrape_configs:
  - job_name: 'order-service'
    kubernetes_sd_configs:
    - role: pod
      namespaces:
        names:
        - apps
    relabel_configs:
    - source_labels: [__meta_kubernetes_pod_label_app]
      regex: order-service
      action: keep
    - source_labels: [__meta_kubernetes_pod_ip]
      target_label: __address__
      replacement: ${1}:8081
    - source_labels: [__meta_kubernetes_namespace]
      target_label: namespace
    - source_labels: [__meta_kubernetes_pod_name]
      target_label: pod
    metrics_path: '/actuator/prometheus'
```

### 5.2 Grafana å‘Šè­¦é…ç½®

#### 5.2.1 åˆ›å»ºå‘Šè­¦è§„åˆ™

ç™»å½• Grafana â†’ Alerting â†’ Alert rules â†’ New alert rule

**å‘Šè­¦1ï¼šCPU ä½¿ç”¨ç‡è¿‡é«˜**

```promql
# æ¡ä»¶
avg(rate(process_cpu_usage[5m])) by (pod) > 0.8

# æŒç»­æ—¶é—´ï¼š5 åˆ†é’Ÿ
# ä¸¥é‡çº§åˆ«ï¼šWarning
```

**å‘Šè­¦2ï¼šå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜**

```promql
# æ¡ä»¶
(jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) > 0.9

# æŒç»­æ—¶é—´ï¼š5 åˆ†é’Ÿ
# ä¸¥é‡çº§åˆ«ï¼šCritical
```

**å‘Šè­¦3ï¼šæ¥å£å“åº”æ—¶é—´è¿‡é•¿**

```promql
# æ¡ä»¶
histogram_quantile(0.99, 
  rate(http_server_requests_seconds_bucket{uri="/api/orders"}[5m])
) > 1

# æŒç»­æ—¶é—´ï¼š5 åˆ†é’Ÿ
# ä¸¥é‡çº§åˆ«ï¼šWarning
```

**å‘Šè­¦4ï¼šè®¢å•å¤±è´¥ç‡è¿‡é«˜**

```promql
# æ¡ä»¶
(
  rate(order_failed_total[5m]) / 
  rate(order_created_total[5m])
) > 0.05

# æŒç»­æ—¶é—´ï¼š5 åˆ†é’Ÿ
# ä¸¥é‡çº§åˆ«ï¼šCritical
```

#### 5.2.2 é…ç½®é€šçŸ¥æ¸ é“

**ä¼ä¸šå¾®ä¿¡é€šçŸ¥**ï¼š

```yaml
apiVersion: 1

contactPoints:
  - name: wechat
    receivers:
    - uid: wechat-alert
      type: webhook
      settings:
        url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
        httpMethod: POST
```

**é’‰é’‰é€šçŸ¥**ï¼š

```yaml
contactPoints:
  - name: dingtalk
    receivers:
    - uid: dingtalk-alert
      type: webhook
      settings:
        url: https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN
        httpMethod: POST
```

### 5.3 æ—¥å¿—èšåˆï¼ˆELKä¼˜åŒ–ï¼‰

#### 5.3.1 ç»“æ„åŒ–æ—¥å¿—

ä½¿ç”¨ Logback è¾“å‡º JSON æ ¼å¼æ—¥å¿—ï¼š

```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <customFields>{"service":"order-service"}</customFields>
            <includeMdc>true</includeMdc>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="JSON"/>
    </root>
</configuration>
```

#### 5.3.2 æ—¥å¿—å…³è” TraceId

```java
@Component
public class TraceIdFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain filterChain) throws ServletException, IOException {
        
        String traceId = request.getHeader("X-Trace-Id");
        if (traceId == null) {
            traceId = UUID.randomUUID().toString();
        }
        
        MDC.put("traceId", traceId);
        response.setHeader("X-Trace-Id", traceId);
        
        try {
            filterChain.doFilter(request, response);
        } finally {
            MDC.remove("traceId");
        }
    }
}
```

æ—¥å¿—è¾“å‡ºï¼š

```json
{
  "timestamp": "2025-01-17T10:30:45.123Z",
  "level": "INFO",
  "service": "order-service",
  "traceId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "message": "è®¢å•åˆ›å»ºæˆåŠŸ",
  "userId": 1001,
  "orderNo": "ORD202501171030"
}
```

#### 5.3.3 Kibana æŸ¥è¯¢ä¼˜åŒ–

**æŒ‰ TraceId æŸ¥è¯¢å®Œæ•´é“¾è·¯**ï¼š

```
traceId:"a1b2c3d4-e5f6-7890-abcd-ef1234567890"
```

**æŸ¥è¯¢é”™è¯¯æ—¥å¿—**ï¼š

```
level:ERROR AND service:order-service
```

**æŸ¥è¯¢æ…¢æ¥å£**ï¼š

```
message:"æ¥å£è€—æ—¶" AND duration:>1000
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šæ”¯ä»˜ç³»ç»Ÿè®¾è®¡

### 6.1 æ”¯ä»˜æµç¨‹è®¾è®¡

```
ç”¨æˆ·ä¸‹å•
  â†“
åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆçŠ¶æ€ï¼šå¾…æ”¯ä»˜ï¼‰
  â†“
è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼ˆæ”¯ä»˜å®/å¾®ä¿¡ï¼‰
  â†“
è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
  â†“
ç”¨æˆ·å®Œæˆæ”¯ä»˜
  â†“
ç¬¬ä¸‰æ–¹æ”¯ä»˜å›è°ƒ
  â†“
éªŒè¯ç­¾å
  â†“
æ›´æ–°æ”¯ä»˜è®¢å•ï¼ˆçŠ¶æ€ï¼šå·²æ”¯ä»˜ï¼‰
  â†“
æ›´æ–°ä¸šåŠ¡è®¢å•ï¼ˆçŠ¶æ€ï¼šå·²æ”¯ä»˜ï¼‰
  â†“
å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
```

### 6.2 æ”¯ä»˜æœåŠ¡å®ç°

#### 6.2.1 åˆ›å»ºæ”¯ä»˜è®¢å•

```java
@Service
@RequiredArgsConstructor
public class PaymentService {
    
    private final PaymentOrderRepository paymentOrderRepository;
    private final RedissonClient redissonClient;
    
    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆå¹‚ç­‰æ€§ä¿è¯ï¼‰
     */
    @Transactional
    public PaymentOrder createPaymentOrder(String orderNo, BigDecimal amount) {
        String lockKey = "payment:lock:" + orderNo;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // åŠ é”é˜²æ­¢é‡å¤åˆ›å»º
            boolean locked = lock.tryLock(5, 10, TimeUnit.SECONDS);
            if (!locked) {
                throw new RuntimeException("è·å–é”å¤±è´¥");
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ”¯ä»˜è®¢å•
            Optional<PaymentOrder> existing = paymentOrderRepository.findByOrderNo(orderNo);
            if (existing.isPresent()) {
                log.warn("æ”¯ä»˜è®¢å•å·²å­˜åœ¨: {}", orderNo);
                return existing.get();
            }
            
            // åˆ›å»ºæ”¯ä»˜è®¢å•
            PaymentOrder paymentOrder = new PaymentOrder();
            paymentOrder.setPaymentNo(generatePaymentNo());
            paymentOrder.setOrderNo(orderNo);
            paymentOrder.setAmount(amount);
            paymentOrder.setStatus("PENDING");
            paymentOrder.setCreateTime(LocalDateTime.now());
            
            return paymentOrderRepository.save(paymentOrder);
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥", e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
     */
    public String invokePay(String paymentNo, String payType) {
        PaymentOrder order = paymentOrderRepository.findByPaymentNo(paymentNo)
                .orElseThrow(() -> new RuntimeException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨"));
        
        if ("alipay".equals(payType)) {
            return invokeAlipay(order);
        } else if ("wechat".equals(payType)) {
            return invokeWechatPay(order);
        } else {
            throw new RuntimeException("ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼");
        }
    }
    
    /**
     * å¤„ç†æ”¯ä»˜å›è°ƒ
     */
    @Transactional
    public void handlePayCallback(Map<String, String> params) {
        // 1. éªŒè¯ç­¾å
        if (!verifySign(params)) {
            throw new RuntimeException("ç­¾åéªŒè¯å¤±è´¥");
        }
        
        String paymentNo = params.get("paymentNo");
        String tradeNo = params.get("tradeNo"); // ç¬¬ä¸‰æ–¹äº¤æ˜“å·
        
        // 2. å¹‚ç­‰æ€§æ£€æŸ¥
        PaymentOrder order = paymentOrderRepository.findByPaymentNo(paymentNo)
                .orElseThrow(() -> new RuntimeException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨"));
        
        if ("SUCCESS".equals(order.getStatus())) {
            log.warn("æ”¯ä»˜è®¢å•å·²å¤„ç†: {}", paymentNo);
            return;
        }
        
        // 3. æ›´æ–°æ”¯ä»˜è®¢å•
        order.setStatus("SUCCESS");
        order.setTradeNo(tradeNo);
        order.setPayTime(LocalDateTime.now());
        paymentOrderRepository.save(order);
        
        // 4. å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
        kafkaTemplate.send("payment-success", paymentNo, order);
        
        log.info("æ”¯ä»˜æˆåŠŸ: paymentNo={}, tradeNo={}", paymentNo, tradeNo);
    }
    
    private String generatePaymentNo() {
        return "PAY" + System.currentTimeMillis() + UUID.randomUUID().toString().substring(0, 8);
    }
}
```

#### 6.2.2 å¯¹è´¦ç³»ç»Ÿ

```java
@Service
@Slf4j
public class ReconciliationService {
    
    @Autowired
    private PaymentOrderRepository paymentOrderRepository;
    
    @Autowired
    private AlipayClient alipayClient;
    
    /**
     * æ¯å¤©å‡Œæ™¨å¯¹è´¦
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void dailyReconciliation() {
        log.info("å¼€å§‹å¯¹è´¦...");
        
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        // 1. è·å–æœ¬åœ°æ”¯ä»˜è®¢å•
        List<PaymentOrder> localOrders = paymentOrderRepository
                .findByPayTimeBetween(
                        yesterday.atStartOfDay(),
                        yesterday.plusDays(1).atStartOfDay()
                );
        
        // 2. è·å–æ”¯ä»˜å®è´¦å•
        List<AlipayBill> alipayBills = alipayClient.downloadBill(yesterday);
        
        // 3. å¯¹è´¦
        List<ReconciliationResult> results = new ArrayList<>();
        
        for (PaymentOrder local : localOrders) {
            AlipayBill remote = findByTradeNo(alipayBills, local.getTradeNo());
            
            if (remote == null) {
                // æœ¬åœ°æœ‰ï¼Œæ”¯ä»˜å®æ²¡æœ‰
                results.add(new ReconciliationResult(local, null, "MISSING_IN_REMOTE"));
            } else if (!local.getAmount().equals(remote.getAmount())) {
                // é‡‘é¢ä¸ä¸€è‡´
                results.add(new ReconciliationResult(local, remote, "AMOUNT_MISMATCH"));
            } else {
                // ä¸€è‡´
                results.add(new ReconciliationResult(local, remote, "MATCH"));
            }
        }
        
        // 4. å¤„ç†å·®å¼‚
        for (ReconciliationResult result : results) {
            if (!"MATCH".equals(result.getStatus())) {
                log.error("å¯¹è´¦å·®å¼‚: {}", result);
                // å‘é€å‘Šè­¦
                sendAlert(result);
            }
        }
        
        log.info("å¯¹è´¦å®Œæˆï¼Œæ€»è®¢å•: {}, å·®å¼‚: {}", 
                localOrders.size(), 
                results.stream().filter(r -> !"MATCH".equals(r.getStatus())).count());
    }
}
```

### 6.3 é€€æ¬¾æµç¨‹

```java
@Service
public class RefundService {
    
    /**
     * ç”³è¯·é€€æ¬¾
     */
    @Transactional
    public RefundOrder createRefund(String orderNo, BigDecimal amount, String reason) {
        // 1. æ£€æŸ¥è®¢å•çŠ¶æ€
        PaymentOrder payment = paymentOrderRepository.findByOrderNo(orderNo)
                .orElseThrow(() -> new RuntimeException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨"));
        
        if (!"SUCCESS".equals(payment.getStatus())) {
            throw new RuntimeException("è®¢å•æœªæ”¯ä»˜ï¼Œæ— æ³•é€€æ¬¾");
        }
        
        // 2. åˆ›å»ºé€€æ¬¾è®¢å•
        RefundOrder refund = new RefundOrder();
        refund.setRefundNo(generateRefundNo());
        refund.setPaymentNo(payment.getPaymentNo());
        refund.setOrderNo(orderNo);
        refund.setAmount(amount);
        refund.setReason(reason);
        refund.setStatus("PENDING");
        refund.setCreateTime(LocalDateTime.now());
        
        return refundOrderRepository.save(refund);
    }
    
    /**
     * å¤„ç†é€€æ¬¾
     */
    @Async
    public void processRefund(String refundNo) {
        RefundOrder refund = refundOrderRepository.findByRefundNo(refundNo)
                .orElseThrow(() -> new RuntimeException("é€€æ¬¾è®¢å•ä¸å­˜åœ¨"));
        
        try {
            // è°ƒç”¨ç¬¬ä¸‰æ–¹é€€æ¬¾
            String result = alipayClient.refund(
                    refund.getPaymentNo(),
                    refund.getAmount(),
                    refund.getReason()
            );
            
            // æ›´æ–°é€€æ¬¾çŠ¶æ€
            refund.setStatus("SUCCESS");
            refund.setRefundTime(LocalDateTime.now());
            refundOrderRepository.save(refund);
            
            // å‘é€é€€æ¬¾æˆåŠŸæ¶ˆæ¯
            kafkaTemplate.send("refund-success", refundNo, refund);
            
        } catch (Exception e) {
            log.error("é€€æ¬¾å¤±è´¥: {}", refundNo, e);
            refund.setStatus("FAILED");
            refund.setErrorMsg(e.getMessage());
            refundOrderRepository.save(refund);
        }
    }
}
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå¤šæœºæˆ¿å®¹ç¾

### 7.1 æ¶æ„è®¾è®¡

```
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   DNSæ™ºèƒ½   â”‚
       â”‚   è§£æ      â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœºæˆ¿A(ä¸»)  â”‚ â”‚  æœºæˆ¿B(å¤‡)  â”‚
â”‚             â”‚ â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚åº”ç”¨é›†ç¾¤ â”‚ â”‚ â”‚ â”‚åº”ç”¨é›†ç¾¤ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚ â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚PostgreSQLâ”‚â—„â”¼â”€â”¼â”€â–ºPostgreSQLâ”‚ â”‚
â”‚ â”‚  (ä¸»)   â”‚ â”‚ â”‚ â”‚  (ä»)   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚ â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Redis  â”‚â—„â”¼â”€â”¼â”€â–º  Redis  â”‚ â”‚
â”‚ â”‚ Cluster â”‚ â”‚ â”‚ â”‚ Cluster â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚   Kafka     â”‚
         â”‚   é›†ç¾¤      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ•°æ®åŒæ­¥æ–¹æ¡ˆ

#### 7.2.1 ä½¿ç”¨ Canal ç›‘å¬ Binlog

```bash
# éƒ¨ç½² Canal
docker run -d \
  --name canal \
  -p 11111:11111 \
  -e canal.instance.master.address=ä¸»åº“IP:3306 \
  -e canal.instance.dbUsername=canal \
  -e canal.instance.dbPassword=canal \
  -e canal.instance.connectionCharset=UTF-8 \
  -e canal.instance.tsdb.enable=true \
  canal/canal-server:latest
```

æ¶ˆè´¹ Canal æ•°æ®ï¼š

```java
@Service
public class CanalConsumer {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    public void consumeCanal() {
        CanalConnector connector = CanalConnectors.newSingleConnector(
                new InetSocketAddress("localhost", 11111),
                "example", "", ""
        );
        
        try {
            connector.connect();
            connector.subscribe("order_db.*");
            connector.rollback();
            
            while (true) {
                Message message = connector.getWithoutAck(1000);
                long batchId = message.getId();
                
                if (batchId != -1 && message.getEntries().size() > 0) {
                    for (Entry entry : message.getEntries()) {
                        if (entry.getEntryType() == EntryType.ROWDATA) {
                            RowChange rowChange = RowChange.parseFrom(entry.getStoreValue());
                            
                            for (RowData rowData : rowChange.getRowDatasList()) {
                                // å‘é€åˆ° Kafkaï¼ŒåŒæ­¥åˆ°å¤‡æœºæˆ¿
                                kafkaTemplate.send("db-sync", entry.getHeader().getTableName(), rowData);
                            }
                        }
                    }
                    connector.ack(batchId);
                }
            }
        } finally {
            connector.disconnect();
        }
    }
}
```

### 7.3 æ•…éšœåˆ‡æ¢

#### 7.3.1 å¥åº·æ£€æŸ¥

```java
@Component
public class DataCenterHealthCheck {
    
    @Autowired
    private DataSource dataSource;
    
    @Scheduled(fixedRate = 5000)
    public void checkHealth() {
        try (Connection conn = dataSource.getConnection()) {
            boolean isHealthy = conn.isValid(3);
            
            if (!isHealthy) {
                log.error("æ•°æ®åº“ä¸å¥åº·ï¼Œè§¦å‘æ•…éšœåˆ‡æ¢");
                triggerFailover();
            }
        } catch (Exception e) {
            log.error("å¥åº·æ£€æŸ¥å¤±è´¥", e);
            triggerFailover();
        }
    }
    
    private void triggerFailover() {
        // 1. æ›´æ–° DNS è®°å½•
        // 2. é€šçŸ¥æ‰€æœ‰åº”ç”¨åˆ‡æ¢æ•°æ®æº
        // 3. å‘é€å‘Šè­¦
    }
}
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–æ€»ç»“

### 8.1 ä¼˜åŒ–æ¸…å•

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|--------|--------|--------|----------|
| **æ¥å£å“åº”æ—¶é—´** | 500ms | 50ms | 90% â†“ |
| **QPS** | 1000 | 10000 | 10å€ â†‘ |
| **æ•°æ®åº“è¿æ¥æ•°** | 100 | 20 | 80% â†“ |
| **å†…å­˜ä½¿ç”¨** | 2GB | 1GB | 50% â†“ |
| **GC åœé¡¿æ—¶é—´** | 500ms | 50ms | 90% â†“ |

### 8.2 å‹æµ‹æŠ¥å‘Š

ä½¿ç”¨ JMeter å‹æµ‹ç»“æœï¼š

```
æµ‹è¯•åœºæ™¯ï¼šåˆ›å»ºè®¢å•æ¥å£
å¹¶å‘ç”¨æˆ·ï¼š1000
æŒç»­æ—¶é—´ï¼š10åˆ†é’Ÿ

ä¼˜åŒ–å‰ï¼š
- ååé‡ï¼š800 TPS
- å¹³å‡å“åº”æ—¶é—´ï¼š450ms
- P99 å“åº”æ—¶é—´ï¼š2000ms
- é”™è¯¯ç‡ï¼š5%

ä¼˜åŒ–åï¼š
- ååé‡ï¼š5000 TPS
- å¹³å‡å“åº”æ—¶é—´ï¼š50ms
- P99 å“åº”æ—¶é—´ï¼š200ms
- é”™è¯¯ç‡ï¼š0.1%
```

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šé¢è¯•å‡†å¤‡

### 9.1 æ ¸å¿ƒé—®é¢˜ä¸ç­”æ¡ˆ

#### Q1: ä½ ä»¬é¡¹ç›®æ˜¯å¦‚ä½•éƒ¨ç½²çš„ï¼Ÿ

**å›ç­”**ï¼š
æˆ‘ä»¬é¡¹ç›®ä½¿ç”¨ Kubernetes è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œéƒ¨ç½²åœ¨ç§æœ‰äº‘ä¸Šã€‚

**è¯¦ç»†è¯´æ˜**ï¼š
1. ä½¿ç”¨ Helm æ‰“åŒ…å¾®æœåŠ¡ï¼Œæ–¹ä¾¿ç‰ˆæœ¬ç®¡ç†å’Œå›æ»š
2. é…ç½® HPA è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ŒCPU è¶…è¿‡ 80% è‡ªåŠ¨æ‰©å®¹ï¼Œæœ€å¤š 10 ä¸ª Pod
3. ä½¿ç”¨ Istio æœåŠ¡ç½‘æ ¼ï¼Œå®ç°æœåŠ¡é—´ mTLS åŠ å¯†å’Œæµé‡ç®¡ç†
4. é€šè¿‡ Ingress æš´éœ²æœåŠ¡ï¼Œé…ç½®åŸŸåå’Œ HTTPS
5. ä½¿ç”¨ ConfigMap å’Œ Secret ç®¡ç†é…ç½®ï¼Œæ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨

**åŠ åˆ†ç‚¹**ï¼š
- æåˆ°ç°åº¦å‘å¸ƒï¼šæ–°ç‰ˆæœ¬å…ˆåˆ‡ 10% æµé‡ï¼Œè§‚å¯Ÿæ— é—®é¢˜åé€æ­¥æ”¾é‡
- æåˆ°è“ç»¿éƒ¨ç½²ï¼šä¿ç•™ä¸¤å¥—ç¯å¢ƒï¼Œä¸€é”®åˆ‡æ¢
- æåˆ°å¤šæœºæˆ¿å®¹ç¾ï¼šä¸»å¤‡æœºæˆ¿ï¼Œè‡ªåŠ¨æ•…éšœåˆ‡æ¢

---

#### Q2: å¦‚ä½•ä¿è¯ç³»ç»Ÿé«˜å¯ç”¨ï¼Ÿ

**å›ç­”**ï¼š
æˆ‘ä»¬ä»å¤šä¸ªç»´åº¦ä¿è¯ç³»ç»Ÿé«˜å¯ç”¨ï¼š

1. **åº”ç”¨å±‚**ï¼š
   - K8s å¤šå‰¯æœ¬éƒ¨ç½²ï¼ˆè‡³å°‘ 2 ä¸ª Podï¼‰
   - HPA è‡ªåŠ¨æ‰©ç¼©å®¹
   - å¥åº·æ£€æŸ¥ï¼ˆLiveness å’Œ Readiness Probeï¼‰
   - æ»šåŠ¨æ›´æ–°ï¼Œé›¶åœæœºéƒ¨ç½²

2. **æ•°æ®å±‚**ï¼š
   - PostgreSQL ä¸»ä»å¤åˆ¶ï¼Œè¯»å†™åˆ†ç¦»
   - Redis Cluster é›†ç¾¤æ¨¡å¼
   - æ•°æ®åº“å®šæ—¶å¤‡ä»½ï¼Œæ”¯æŒæ—¶é—´ç‚¹æ¢å¤

3. **ä¸­é—´ä»¶**ï¼š
   - Kafka 3 èŠ‚ç‚¹é›†ç¾¤ï¼Œå‰¯æœ¬å› å­ä¸º 2
   - Nacos é›†ç¾¤éƒ¨ç½²

4. **å®¹ç¾**ï¼š
   - å¤šæœºæˆ¿éƒ¨ç½²ï¼Œä¸»å¤‡åˆ‡æ¢
   - é™æµé™çº§ï¼ˆSentinelï¼‰
   - ç†”æ–­æœºåˆ¶ï¼ˆIstioï¼‰

5. **ç›‘æ§å‘Šè­¦**ï¼š
   - Prometheus ç›‘æ§
   - Grafana å¯è§†åŒ–
   - å‘Šè­¦åŠæ—¶é€šçŸ¥

**ç›®æ ‡**ï¼š
- å¯ç”¨æ€§ï¼š99.9%ï¼ˆå¹´åœæœºæ—¶é—´ < 8.76 å°æ—¶ï¼‰
- RTOï¼ˆæ¢å¤æ—¶é—´ç›®æ ‡ï¼‰ï¼š< 5 åˆ†é’Ÿ
- RPOï¼ˆæ¢å¤ç‚¹ç›®æ ‡ï¼‰ï¼š< 1 åˆ†é’Ÿ

---

#### Q3: é‡åˆ°è¿‡ä»€ä¹ˆæ€§èƒ½é—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³çš„ï¼Ÿ

**å›ç­”**ï¼š
é‡åˆ°è¿‡ä¸€æ¬¡ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ï¼šè®¢å•æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ä» 100ms çªç„¶å˜æˆ 3 ç§’ã€‚

**æ’æŸ¥è¿‡ç¨‹**ï¼š
1. æŸ¥çœ‹ç›‘æ§ï¼Œå‘ç°æ•°æ®åº“ CPU 100%
2. æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå‘ç°å¤§é‡å…¨è¡¨æ‰«æ
3. ä½¿ç”¨ EXPLAIN åˆ†ææ‰§è¡Œè®¡åˆ’ï¼Œå‘ç°ç´¢å¼•å¤±æ•ˆ

**æ ¹æœ¬åŸå› **ï¼š
æŸ¥è¯¢æ¡ä»¶ç”¨äº†å‡½æ•° `WHERE YEAR(create_time) = 2025`ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç«‹å³ä¿®æ”¹ SQLï¼š`WHERE create_time >= '2025-01-01' AND create_time < '2026-01-01'`
2. æ·»åŠ å¤åˆç´¢å¼•ï¼š`CREATE INDEX idx_create_time ON t_order(create_time)`
3. ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
4. é…ç½®æ…¢æŸ¥è¯¢å‘Šè­¦ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

**æ•ˆæœ**ï¼š
- å“åº”æ—¶é—´é™åˆ° 50ms
- æ•°æ®åº“ CPU é™åˆ° 20%
- QPS ä» 500 æå‡åˆ° 5000

**ç»éªŒæ€»ç»“**ï¼š
- é¿å…åœ¨ç´¢å¼•åˆ—ä¸Šä½¿ç”¨å‡½æ•°
- å®šæœŸ review æ…¢æŸ¥è¯¢
- åšå¥½ç›‘æ§å‘Šè­¦

---

#### Q4: å¦‚ä½•åšç°åº¦å‘å¸ƒï¼Ÿ

**å›ç­”**ï¼š
æˆ‘ä»¬ä½¿ç”¨ Istio å®ç°ç°åº¦å‘å¸ƒï¼ˆé‡‘ä¸é›€éƒ¨ç½²ï¼‰ã€‚

**æ­¥éª¤**ï¼š
1. éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆv2ï¼‰ï¼Œåˆå§‹åªéƒ¨ç½² 1 ä¸ª Pod
2. é…ç½® VirtualServiceï¼Œ10% æµé‡åˆ° v2
   ```yaml
   route:
   - destination:
       host: order-service
       subset: v1
     weight: 90
   - destination:
       host: order-service
       subset: v2
     weight: 10
   ```
3. è§‚å¯Ÿ v2 çš„ç›‘æ§æŒ‡æ ‡ï¼ˆé”™è¯¯ç‡ã€å“åº”æ—¶é—´ï¼‰
4. å¦‚æœæ­£å¸¸ï¼Œé€æ­¥è°ƒæ•´æµé‡æ¯”ä¾‹ï¼š30% â†’ 50% â†’ 100%
5. å®Œå…¨åˆ‡æ¢åï¼Œä¸‹çº¿ v1

**é«˜çº§ç©æ³•**ï¼š
- åŸºäºè¯·æ±‚å¤´ç°åº¦ï¼šç‰¹å®šç”¨æˆ·å…ˆä½“éªŒæ–°åŠŸèƒ½
- åŸºäºåœ°åŸŸç°åº¦ï¼šå…ˆåœ¨æŸä¸ªåŸå¸‚ä¸Šçº¿
- è‡ªåŠ¨åŒ–ï¼šæ ¹æ®é”™è¯¯ç‡è‡ªåŠ¨å›æ»š

**å›æ»šç­–ç•¥**ï¼š
- å¦‚æœé”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ï¼Œç«‹å³å›æ»š
- ä¸€é”®åˆ‡æ¢æµé‡åˆ° v1
- ä¿ç•™ v1 ç¯å¢ƒè‡³å°‘ 1 å¤©

---

#### Q5: JVM è°ƒä¼˜åšè¿‡å“ªäº›ï¼Ÿ

**å›ç­”**ï¼š
æˆ‘åšè¿‡å¤šæ¬¡ JVM è°ƒä¼˜ï¼Œä¸¾ä¸€ä¸ªå°è±¡æ·±åˆ»çš„ä¾‹å­ï¼š

**é—®é¢˜**ï¼š
åº”ç”¨é¢‘ç¹ Full GCï¼Œæ¯æ¬¡åœé¡¿ 2-3 ç§’ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚

**æ’æŸ¥**ï¼š
1. ä¸‹è½½ GC æ—¥å¿—ï¼Œç”¨ GCViewer åˆ†æ
2. å‘ç° Full GC é¢‘ç‡ï¼šæ¯ 5 åˆ†é’Ÿä¸€æ¬¡
3. å‘ç°è€å¹´ä»£å ç”¨ç‡ä¸€ç›´åœ¨ 90% ä»¥ä¸Š
4. ä½¿ç”¨ jmap ç”Ÿæˆå †è½¬å‚¨ï¼Œç”¨ MAT åˆ†æ
5. å‘ç° Caffeine æœ¬åœ°ç¼“å­˜å ç”¨ 1.5GBï¼Œç¼“å­˜äº†å¤§é‡å¯¹è±¡

**è§£å†³**ï¼š
1. è°ƒæ•´ç¼“å­˜å¤§å°ï¼šä»æ— é™åˆ¶æ”¹ä¸º 10000 æ¡
2. è°ƒæ•´ JVM å‚æ•°ï¼š
   ```bash
   -Xms2g -Xmx2g          # å †å†…å­˜ 2GB
   -XX:+UseG1GC           # ä½¿ç”¨ G1 æ”¶é›†å™¨
   -XX:MaxGCPauseMillis=200  # æœ€å¤§åœé¡¿ 200ms
   ```
3. è°ƒæ•´ G1 å‚æ•°ï¼š
   ```bash
   -XX:G1HeapRegionSize=8m
   -XX:InitiatingHeapOccupancyPercent=45
   ```

**æ•ˆæœ**ï¼š
- Full GC é¢‘ç‡ï¼šä» 5 åˆ†é’Ÿä¸€æ¬¡é™åˆ° 1 å¤©ä¸€æ¬¡
- GC åœé¡¿æ—¶é—´ï¼šä» 2-3 ç§’é™åˆ° 100ms
- è€å¹´ä»£å ç”¨ç‡ï¼šä» 90% é™åˆ° 40%

**ç»éªŒ**ï¼š
- å †å†…å­˜ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œè¦æ ¹æ®ä¸šåŠ¡åˆç†é…ç½®
- ä½¿ç”¨ G1 æ”¶é›†å™¨ï¼Œé€‚åˆå¤§å †
- å®šæœŸåˆ†æ GC æ—¥å¿—ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

---

### 9.2 é¡¹ç›®äº®ç‚¹æ€»ç»“

**æŠ€æœ¯äº®ç‚¹**ï¼š
1. âœ… Kubernetes ç”Ÿäº§çº§éƒ¨ç½²ï¼ŒHPA è‡ªåŠ¨æ‰©ç¼©å®¹
2. âœ… Istio æœåŠ¡ç½‘æ ¼ï¼Œç°åº¦å‘å¸ƒã€è“ç»¿éƒ¨ç½²
3. âœ… JVM æ·±åº¦è°ƒä¼˜ï¼ŒGC åœé¡¿æ—¶é—´ < 100ms
4. âœ… æ•°æ®åº“è¯»å†™åˆ†ç¦»ï¼Œåˆ†åº“åˆ†è¡¨æ”¯æŒäº¿çº§æ•°æ®
5. âœ… å®Œæ•´ç›‘æ§å‘Šè­¦ä½“ç³»ï¼Œå¯è§‚æµ‹æ€§å¼º
6. âœ… å¤šæœºæˆ¿å®¹ç¾ï¼Œè‡ªåŠ¨æ•…éšœåˆ‡æ¢

**ä¸šåŠ¡äº®ç‚¹**ï¼š
1. âœ… æ”¯ä»˜ç³»ç»Ÿï¼Œå¹‚ç­‰æ€§ä¿è¯ï¼Œå¯¹è´¦ç³»ç»Ÿ
2. âœ… é«˜å¹¶å‘ä¸‹åº“å­˜å‡†ç¡®ï¼Œåˆ†å¸ƒå¼é”é˜²è¶…å–
3. âœ… åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§

**æ€§èƒ½æ•°æ®**ï¼š
- QPSï¼šä» 1000 æå‡åˆ° 10000ï¼ˆ10å€ï¼‰
- å“åº”æ—¶é—´ï¼šä» 500ms é™åˆ° 50msï¼ˆ90%â†“ï¼‰
- å¯ç”¨æ€§ï¼š99.9%

---

## é™„å½•ï¼šå¿«é€Ÿéƒ¨ç½²è„šæœ¬

### deploy-all-k8s.sh

```bash
#!/bin/bash

echo "=== éƒ¨ç½²äº‘åŸç”Ÿå¾®æœåŠ¡ç³»ç»Ÿ ==="

# 1. åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace middleware
kubectl create namespace apps

# 2. éƒ¨ç½²ä¸­é—´ä»¶
echo "éƒ¨ç½²ä¸­é—´ä»¶..."
helm install postgres bitnami/postgresql --namespace middleware --wait
helm install redis bitnami/redis --namespace middleware --wait
helm install kafka bitnami/kafka --namespace middleware --wait
kubectl apply -f nacos-deployment.yaml

# 3. ç­‰å¾…ä¸­é—´ä»¶å°±ç»ª
echo "ç­‰å¾…ä¸­é—´ä»¶å°±ç»ª..."
kubectl wait --for=condition=ready pod -l app=postgres -n middleware --timeout=300s
kubectl wait --for=condition=ready pod -l app=redis -n middleware --timeout=300s

# 4. éƒ¨ç½²å¾®æœåŠ¡
echo "éƒ¨ç½²å¾®æœåŠ¡..."
helm install order-service ./charts/order-service --namespace apps
helm install inventory-service ./charts/inventory-service --namespace apps
helm install notification-service ./charts/notification-service --namespace apps
helm install gateway-service ./charts/gateway-service --namespace apps

# 5. æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
echo "æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€..."
kubectl get pods -n middleware
kubectl get pods -n apps

echo "=== éƒ¨ç½²å®Œæˆ ==="
echo "è®¿é—®åœ°å€: http://$(kubectl get svc -n apps gateway-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
```

---

## æ€»ç»“

å®Œæˆæœ¬é«˜çº§ç‰ˆåï¼Œä½ å°†å…·å¤‡ï¼š

### äº‘åŸç”Ÿèƒ½åŠ›
- âœ… Kubernetes ç”Ÿäº§éƒ¨ç½²ç»éªŒ
- âœ… Helm åº”ç”¨æ‰“åŒ…ç®¡ç†
- âœ… Istio æœåŠ¡ç½‘æ ¼å®æˆ˜
- âœ… ç°åº¦å‘å¸ƒã€è“ç»¿éƒ¨ç½²

### æ€§èƒ½è°ƒä¼˜èƒ½åŠ›
- âœ… JVM æ·±åº¦è°ƒä¼˜
- âœ… GC æ—¥å¿—åˆ†æ
- âœ… Arthas åœ¨çº¿è¯Šæ–­
- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

### æ¶æ„è®¾è®¡èƒ½åŠ›
- âœ… é«˜å¯ç”¨æ¶æ„
- âœ… å¤šæœºæˆ¿å®¹ç¾
- âœ… å®Œæ•´ç›‘æ§ä½“ç³»
- âœ… æ”¯ä»˜ç³»ç»Ÿè®¾è®¡

### è–ªèµ„æ°´å¹³
- ğŸ’° 25K - 45Kï¼ˆé«˜çº§/æ¶æ„å¸ˆï¼‰

---

**æ­å–œä½ å®Œæˆäº‘åŸç”Ÿé«˜çº§ç‰ˆå­¦ä¹ ï¼ä½ å·²ç»å…·å¤‡äº†é«˜çº§å·¥ç¨‹å¸ˆ/æ¶æ„å¸ˆçš„æ ¸å¿ƒèƒ½åŠ›ï¼ğŸ‰**

**ä¸‹ä¸€æ­¥**ï¼š
1. æ•´ç†æ¶æ„å›¾å’ŒæŠ€æœ¯æ–¹æ¡ˆ
2. å‡†å¤‡é¢è¯•é—®é¢˜ç­”æ¡ˆ
3. å½•åˆ¶é¡¹ç›®æ¼”ç¤ºè§†é¢‘
4. æ›´æ–°ç®€å†ï¼Œå¼€å§‹é¢è¯•

**ç¥ä½ é¢è¯•æˆåŠŸï¼Œæ‹¿åˆ°æ»¡æ„çš„ offerï¼åŠ æ²¹ï¼ğŸš€**


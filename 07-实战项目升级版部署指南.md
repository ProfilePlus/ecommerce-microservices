# Javaå¾®æœåŠ¡å…¨æ ˆæŠ€æœ¯å®æˆ˜é¡¹ç›® - å‡çº§ç‰ˆéƒ¨ç½²æŒ‡å—

## ğŸ“‹ å‡çº§ç‰ˆæ¦‚è¿°

æœ¬å‡çº§ç‰ˆæ–‡æ¡£åŸºäºç¬¬ä¸€ç‰ˆåŸºç¡€æ¶æ„ï¼Œå¼•å…¥ä¼ä¸šçº§é«˜çº§ç‰¹æ€§å’Œæ–°çš„ä¸­é—´ä»¶ï¼Œå¸®åŠ©ä½ æ„å»ºæ›´åŠ å¥å£®ã€é«˜æ€§èƒ½çš„å¾®æœåŠ¡ç³»ç»Ÿã€‚

### ğŸ¯ å‡çº§é‡ç‚¹

#### ç¬¬ä¸€ç‰ˆå›é¡¾ï¼ˆå·²å®Œæˆï¼‰
âœ… åŸºç¡€å¾®æœåŠ¡æ¶æ„ï¼ˆè®¢å•ã€åº“å­˜ã€é€šçŸ¥æœåŠ¡ï¼‰  
âœ… åŸºç¡€ä¸­é—´ä»¶ï¼ˆPostgreSQLã€Redisã€Kafkaã€RabbitMQã€Nacosï¼‰  
âœ… åŸºç¡€ç›‘æ§ï¼ˆPrometheusã€Grafanaã€SkyWalkingï¼‰  
âœ… API ç½‘å…³ï¼ˆSpring Cloud Gatewayï¼‰  

#### å‡çº§ç‰ˆæ–°å¢åŠŸèƒ½
ğŸ”¥ **åˆ†å¸ƒå¼äº‹åŠ¡** - Seata AT æ¨¡å¼  
ğŸ”¥ **é™æµé™çº§ç†”æ–­** - Sentinel æµé‡æ§åˆ¶  
ğŸ”¥ **å…¨æ–‡æœç´¢** - Elasticsearch å•†å“æœç´¢  
ğŸ”¥ **åˆ†å¸ƒå¼é”** - Redisson å®ç°  
ğŸ”¥ **æ¶ˆæ¯å¯é æ€§** - RabbitMQ æ­»ä¿¡é˜Ÿåˆ—  
ğŸ”¥ **ç¼“å­˜ä¼˜åŒ–** - Redis å¤šçº§ç¼“å­˜ã€å¸ƒéš†è¿‡æ»¤å™¨  
ğŸ”¥ **æ•°æ®åº“ä¼˜åŒ–** - è¯»å†™åˆ†ç¦»ã€åˆ†åº“åˆ†è¡¨ï¼ˆShardingSphereï¼‰  
ğŸ”¥ **é“¾è·¯è¿½è¸ªä¼˜åŒ–** - SkyWalking è‡ªå®šä¹‰åŸ‹ç‚¹  
ğŸ”¥ **å®‰å…¨è®¤è¯** - Spring Security + JWT  
ğŸ”¥ **é…ç½®åŠ å¯†** - Jasypt æ•æ„Ÿä¿¡æ¯åŠ å¯†  

### ğŸ—ï¸ æ–°å¢ä¸­é—´ä»¶

| ä¸­é—´ä»¶ | ç‰ˆæœ¬ | ç”¨é€” |
|--------|------|------|
| **Seata** | 1.7.0 | åˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ |
| **Sentinel** | 1.8.6 | æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ |
| **Elasticsearch** | 7.17.15 | å…¨æ–‡æœç´¢ã€æ—¥å¿—åˆ†æ |
| **Logstash** | 7.17.15 | æ—¥å¿—æ”¶é›† |
| **Kibana** | 7.17.15 | æ—¥å¿—å¯è§†åŒ– |
| **ShardingSphere** | 5.3.2 | åˆ†åº“åˆ†è¡¨ |
| **Canal** | 1.1.7 | MySQL Binlog ç›‘å¬ |
| **MinIO** | RELEASE.2023 | å¯¹è±¡å­˜å‚¨ |
| **XXL-Job** | 2.4.0 | åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ |

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šSeata åˆ†å¸ƒå¼äº‹åŠ¡

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ

**ç¬¬ä¸€ç‰ˆé—®é¢˜**ï¼šè®¢å•åˆ›å»ºåï¼Œå¦‚æœåº“å­˜æ‰£å‡å¤±è´¥ï¼Œè®¢å•æ— æ³•å›æ»šï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**å‡çº§æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Seata AT æ¨¡å¼å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¿è¯è®¢å•å’Œåº“å­˜çš„å¼ºä¸€è‡´æ€§ã€‚

### 1.2 éƒ¨ç½² Seata Server

#### 1.2.1 ä¸‹è½½å¹¶é…ç½® Seata

```bash
# åˆ›å»º Seata ç›®å½•
mkdir -p ~/docker-env/seata

# ä¸‹è½½ Seata Server
cd ~/docker-env/seata
wget https://github.com/seata/seata/releases/download/v1.7.0/seata-server-1.7.0.tar.gz
tar -zxvf seata-server-1.7.0.tar.gz
cd seata

# é…ç½® Seata ä½¿ç”¨ Nacos ä½œä¸ºé…ç½®å’Œæ³¨å†Œä¸­å¿ƒ
cat > conf/application.yml <<'EOF'
server:
  port: 7091

spring:
  application:
    name: seata-server

seata:
  config:
    type: nacos
    nacos:
      server-addr: 192.168.xxx.xxx:8848
      namespace: public
      group: SEATA_GROUP
      data-id: seataServer.properties
  
  registry:
    type: nacos
    nacos:
      application: seata-server
      server-addr: 192.168.xxx.xxx:8848
      namespace: public
      group: SEATA_GROUP
  
  store:
    mode: db
    db:
      datasource: druid
      db-type: postgresql
      driver-class-name: org.postgresql.Driver
      url: jdbc:postgresql://192.168.xxx.xxx:5432/seata
      user: admin
      password: Admin@123
      min-conn: 5
      max-conn: 100
EOF
```

#### 1.2.2 åœ¨ PostgreSQL åˆ›å»º Seata æ•°æ®åº“

```bash
# è¿æ¥ PostgreSQL
docker exec -it postgres psql -U admin -d postgres

# åˆ›å»º Seata æ•°æ®åº“
CREATE DATABASE seata;

# é€€å‡º
\q

# ä¸‹è½½ Seata è¡¨ç»“æ„è„šæœ¬
cd ~/docker-env/seata
wget https://raw.githubusercontent.com/seata/seata/v1.7.0/script/server/db/postgresql.sql

# å¯¼å…¥è¡¨ç»“æ„
docker cp postgresql.sql postgres:/tmp/
docker exec -it postgres psql -U admin -d seata -f /tmp/postgresql.sql
```

#### 1.2.3 åœ¨ä¸šåŠ¡åº“åˆ›å»º undo_log è¡¨

```sql
-- åœ¨ order_db æ•°æ®åº“æ‰§è¡Œ
CREATE TABLE undo_log (
    id BIGSERIAL PRIMARY KEY,
    branch_id BIGINT NOT NULL,
    xid VARCHAR(128) NOT NULL,
    context VARCHAR(128) NOT NULL,
    rollback_info BYTEA NOT NULL,
    log_status INT NOT NULL,
    log_created TIMESTAMP NOT NULL,
    log_modified TIMESTAMP NOT NULL,
    CONSTRAINT ux_undo_log UNIQUE (xid, branch_id)
);
CREATE INDEX ix_log_created ON undo_log(log_created);
```

#### 1.2.4 ä½¿ç”¨ Docker å¯åŠ¨ Seata Server

```bash
cd ~/docker-env/seata

cat > docker-compose.yml <<'EOF'
services:
  seata-server:
    image: seataio/seata-server:1.7.0
    container_name: seata-server
    ports:
      - "7091:7091"
      - "8091:8091"
    environment:
      - SEATA_PORT=8091
      - SEATA_IP=192.168.xxx.xxx
      - SEATA_CONFIG_NAME=file:/root/seata-config/application
    volumes:
      - ./conf:/root/seata-config
      - ./logs:/root/logs
    restart: always
EOF

# å¯åŠ¨ Seata
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker logs -f seata-server
```

### 1.3 å¾®æœåŠ¡é›†æˆ Seata

#### 1.3.1 æ·»åŠ ä¾èµ–ï¼ˆæ‰€æœ‰éœ€è¦äº‹åŠ¡çš„æœåŠ¡ï¼‰

åœ¨ `order-service` å’Œ `inventory-service` çš„ `pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<!-- Seata -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>

<!-- æ•°æ®æºä»£ç†éœ€è¦ -->
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>1.7.0</version>
</dependency>
```

#### 1.3.2 é…ç½® Seata å®¢æˆ·ç«¯

åœ¨ `order-service/src/main/resources/application.yml` æ·»åŠ ï¼š

```yaml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: order-service-group
  config:
    type: nacos
    nacos:
      server-addr: 192.168.xxx.xxx:8848
      namespace: public
      group: SEATA_GROUP
      data-id: seataServer.properties
  registry:
    type: nacos
    nacos:
      application: seata-server
      server-addr: 192.168.xxx.xxx:8848
      namespace: public
      group: SEATA_GROUP
  service:
    vgroup-mapping:
      order-service-group: default
```

åŒæ ·åœ¨ `inventory-service` ä¸­é…ç½®ï¼ˆä¿®æ”¹ application-id å’Œ tx-service-groupï¼‰ã€‚

#### 1.3.3 ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡

ä¿®æ”¹ `OrderService.java`ï¼š

```java
import io.seata.spring.annotation.GlobalTransactional;

@Service
@RequiredArgsConstructor
public class OrderService {
    
    private final OrderRepository orderRepository;
    private final InventoryServiceClient inventoryServiceClient; // Feign å®¢æˆ·ç«¯
    
    /**
     * åˆ›å»ºè®¢å• - åˆ†å¸ƒå¼äº‹åŠ¡
     */
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    @Transactional
    public OrderResponse createOrder(OrderRequest request) {
        log.info("å¼€å§‹åˆ›å»ºè®¢å•ï¼Œå…¨å±€äº‹åŠ¡ XID: {}", RootContext.getXID());
        
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setOrderNo(generateOrderNo());
        order.setUserId(request.getUserId());
        order.setProductId(request.getProductId());
        order.setProductName(request.getProductName());
        order.setQuantity(request.getQuantity());
        order.setTotalAmount(request.getTotalAmount());
        order.setStatus("PENDING");
        order.setCreateTime(LocalDateTime.now());
        order.setUpdateTime(LocalDateTime.now());
        
        Order savedOrder = orderRepository.save(order);
        log.info("è®¢å•ä¿å­˜æˆåŠŸ: {}", savedOrder.getOrderNo());
        
        // 2. è¿œç¨‹è°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜
        try {
            boolean success = inventoryServiceClient.deductInventory(
                request.getProductId(), 
                request.getQuantity()
            );
            
            if (!success) {
                throw new RuntimeException("åº“å­˜ä¸è¶³");
            }
            log.info("åº“å­˜æ‰£å‡æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("åº“å­˜æ‰£å‡å¤±è´¥ï¼Œäº‹åŠ¡å›æ»š", e);
            throw e; // æŠ›å‡ºå¼‚å¸¸è§¦å‘å…¨å±€å›æ»š
        }
        
        // 3. æ›´æ–°è®¢å•çŠ¶æ€
        savedOrder.setStatus("SUCCESS");
        orderRepository.save(savedOrder);
        
        return toResponse(savedOrder);
    }
}
```

åˆ›å»º Feign å®¢æˆ·ç«¯ `InventoryServiceClient.java`ï¼š

```java
package com.demo.order.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

@FeignClient(name = "inventory-service")
public interface InventoryServiceClient {
    
    @PostMapping("/api/inventory/deduct")
    boolean deductInventory(@RequestParam("productId") Long productId, 
                           @RequestParam("quantity") Integer quantity);
}
```

ä¿®æ”¹ `InventoryService.java` æ·»åŠ è¿œç¨‹è°ƒç”¨æ¥å£ï¼š

```java
@RestController
@RequestMapping("/api/inventory")
public class InventoryController {
    
    private final InventoryService inventoryService;
    
    @PostMapping("/deduct")
    public boolean deductInventory(@RequestParam Long productId, 
                                   @RequestParam Integer quantity) {
        return inventoryService.deductInventory(productId, quantity);
    }
}
```

### 1.4 æµ‹è¯•åˆ†å¸ƒå¼äº‹åŠ¡

```bash
# æµ‹è¯•æ­£å¸¸æµç¨‹
curl -X POST http://localhost:8000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1001,
    "productId": 1001,
    "productName": "iPhone 15 Pro",
    "quantity": 2,
    "totalAmount": 16998.00
  }'

# æµ‹è¯•å¼‚å¸¸å›æ»šï¼ˆåº“å­˜ä¸è¶³ï¼‰
curl -X POST http://localhost:8000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1001,
    "productId": 1001,
    "productName": "iPhone 15 Pro",
    "quantity": 999,
    "totalAmount": 16998.00
  }'

# æŸ¥çœ‹ Seata æ—¥å¿—
docker logs -f seata-server
```

---

## ç¬¬ä¸€éƒ¨åˆ†è¡¥å……ï¼šç½‘å…³æœåŠ¡å®Œæ•´éƒ¨ç½²

### 1.A ç½‘å…³æœåŠ¡éƒ¨ç½²ï¼ˆGateway Serviceï¼‰

åœ¨å‡çº§ç‰ˆä¸­ï¼Œç½‘å…³ä¸ä»…è¦åšè·¯ç”±è½¬å‘ï¼Œè¿˜éœ€è¦é›†æˆ Sentinel è¿›è¡Œé™æµä¿æŠ¤ã€‚

#### 1.A.1 ç½‘å…³ POM é…ç½®

ç¡®ä¿ `gateway-service/pom.xml` åŒ…å«ä»¥ä¸‹ä¾èµ–ï¼š

```xml
<dependencies>
    <!-- Spring Cloud Gateway -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>

    <!-- Nacos Discovery -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>

    <!-- Nacos Config -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>

    <!-- Sentinel Gateway -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    </dependency>
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-alibaba-sentinel-gateway</artifactId>
    </dependency>

    <!-- Actuator -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>

    <!-- Micrometer Prometheus -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-registry-prometheus</artifactId>
    </dependency>

    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
</dependencies>
```

#### 1.A.2 ç½‘å…³é…ç½®

`gateway-service/src/main/resources/application.yml`:

```yaml
server:
  port: 8000

spring:
  application:
    name: gateway-service
  
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.xxx.xxx:8848
    
    sentinel:
      transport:
        dashboard: 192.168.xxx.xxx:8858
        port: 8719
      scg:
        fallback:
          mode: response
          response-status: 429
          response-body: '{"code":429,"message":"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"}'
    
    gateway:
      routes:
        # è®¢å•æœåŠ¡
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
        
        # åº“å­˜æœåŠ¡  
        - id: inventory-service
          uri: lb://inventory-service
          predicates:
            - Path=/api/inventory/**
        
        # é€šçŸ¥æœåŠ¡
        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**
        
        # æœç´¢æœåŠ¡
        - id: search-service
          uri: lb://search-service
          predicates:
            - Path=/api/search/**
      
      # å…¨å±€è·¨åŸŸ
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true

management:
  endpoints:
    web:
      exposure:
        include: '*'
  metrics:
    export:
      prometheus:
        enabled: true
```

#### 1.A.3 ç½‘å…³å¯åŠ¨ç±»

`gateway-service/src/main/java/com/demo/gateway/GatewayServiceApplication.java`:

```java
package com.demo.gateway;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class GatewayServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayServiceApplication.class, args);
    }
}
```

#### 1.A.4 ç¼–è¯‘å’Œå¯åŠ¨ç½‘å…³

```bash
# ç¼–è¯‘
cd ~/ecommerce-microservices
mvn clean package -pl gateway-service -am -DskipTests

# å¯åŠ¨
java -jar gateway-service/target/gateway-service-1.0.0.jar > logs/gateway-service.log 2>&1 &

# æŸ¥çœ‹æ—¥å¿—
tail -f logs/gateway-service.log
```

#### 1.A.5 éªŒè¯ç½‘å…³

```bash
# æ£€æŸ¥ç½‘å…³æ³¨å†Œ
curl http://192.168.xxx.xxx:8848/nacos/v1/ns/instance/list?serviceName=gateway-service

# æµ‹è¯•è·¯ç”±
curl http://192.168.xxx.xxx:8000/api/orders/health
```

---

## ç¬¬ä¸€éƒ¨åˆ†è¡¥å……Bï¼šå‰ç«¯é¡¹ç›®éƒ¨ç½²

### 1.B.1 å‰ç«¯ç¯å¢ƒå‡†å¤‡

```bash
# å®‰è£… Node.js 16
curl -fsSL https://rpm.nodesource.com/setup_16.x | sudo bash -
sudo yum install -y nodejs

# éªŒè¯
node -v
npm -v

# å®‰è£… pnpmï¼ˆæ¨èï¼‰
npm install -g pnpm
```

### 1.B.2 å‰ç«¯é¡¹ç›®é…ç½®

è¿›å…¥å‰ç«¯ç›®å½•ï¼š
```bash
cd ~/ecommerce-microservices/frontend
```

ä¿®æ”¹ `vite.config.ts`ï¼Œç¡®ä¿ç½‘å…³åœ°å€æ­£ç¡®ï¼š

```typescript
export default defineConfig({
  plugins: [vue()],
  
  server: {
    port: 3000,
    host: '0.0.0.0',
    open: true,
    proxy: {
      '/api': {
        target: 'http://192.168.xxx.xxx:8000', // ç½‘å…³åœ°å€
        changeOrigin: true
      }
    }
  }
})
```

### 1.B.3 å®‰è£…ä¾èµ–å¹¶å¯åŠ¨

```bash
# å®‰è£…ä¾èµ–
pnpm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# æˆ–åå°å¯åŠ¨
nohup pnpm dev > frontend.log 2>&1 &
```

### 1.B.4 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Nginxï¼ˆç”Ÿäº§çº§é…ç½® âœ…ï¼‰

##### 1. å®‰è£…å’Œéƒ¨ç½²

```bash
# å®‰è£… Nginx
sudo yum install -y nginx

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
cd ~/ecommerce-microservices/frontend
pnpm build

# éƒ¨ç½²é™æ€æ–‡ä»¶
sudo mkdir -p /usr/share/nginx/html
sudo cp -r dist/* /usr/share/nginx/html/
sudo chown -R nginx:nginx /usr/share/nginx/html
sudo chmod -R 755 /usr/share/nginx/html
```

##### 2. Nginx ä¼ä¸šçº§é…ç½®ï¼ˆåŒ…å« Sentinelã€é™æµã€ç¼“å­˜ç­‰ï¼‰

åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š

```bash
sudo vi /etc/nginx/conf.d/ecommerce.conf
```

**å®Œæ•´é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰ï¼š**

```nginx
# ============================================
# ç”µå•†å¾®æœåŠ¡å‡çº§ç‰ˆ Nginx é…ç½®
# åŠŸèƒ½ï¼šé™æ€èµ„æº + APIä»£ç† + é™æµ + ç¼“å­˜ + å®‰å…¨
# ============================================

# é™æµé…ç½®
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/s;

# è¿æ¥é™åˆ¶
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# Gateway è´Ÿè½½å‡è¡¡ï¼ˆé«˜å¯ç”¨ï¼‰
upstream gateway_backend {
    # å¦‚æœæœ‰å¤šä¸ªGatewayå®ä¾‹
    server localhost:8000 weight=1 max_fails=3 fail_timeout=30s;
    # server localhost:8001 weight=1 max_fails=3 fail_timeout=30s;
    # server localhost:8002 weight=1 max_fails=3 fail_timeout=30s;
    
    keepalive 32;  # ä¿æŒé•¿è¿æ¥
}

server {
    listen 80;
    server_name localhost;  # ç”Ÿäº§ç¯å¢ƒæ›¿æ¢ä¸ºå®é™…åŸŸå
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/ecommerce_access.log combined;
    error_log /var/log/nginx/ecommerce_error.log warn;
    
    # é™åˆ¶è¿æ¥æ•°
    limit_conn conn_limit 50;
    
    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    
    # ============================================
    # å‰ç«¯é™æ€èµ„æº
    # ============================================
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # HTMLï¼šä¸ç¼“å­˜
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
        
        # JS/CSSï¼šå¼ºç¼“å­˜1å¹´
        location ~* \.(js|css)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # å›¾ç‰‡ï¼šç¼“å­˜30å¤©
        location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
        
        # å­—ä½“ï¼šç¼“å­˜1å¹´
        location ~* \.(woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public";
            add_header Access-Control-Allow-Origin *;
        }
    }
    
    # ============================================
    # API åå‘ä»£ç†ï¼ˆé€šç”¨ï¼‰
    # ============================================
    location /api/ {
        # é™æµï¼šæ¯ç§’20æ¬¡ï¼Œçªå‘50æ¬¡
        limit_req zone=api_limit burst=50 nodelay;
        
        # ä»£ç†åˆ° Gateway é›†ç¾¤
        proxy_pass http://gateway_backend;
        
        # è¯·æ±‚å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # é”™è¯¯é‡è¯•
        proxy_next_upstream error timeout http_500 http_502 http_503;
    }
    
    # ============================================
    # ç™»å½•æ¥å£ï¼šæ›´ä¸¥æ ¼çš„é™æµ
    # ============================================
    location /api/auth/login {
        # é™æµï¼šæ¯ç§’5æ¬¡ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
        limit_req zone=login_limit burst=10 nodelay;
        
        proxy_pass http://gateway_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # ============================================
    # Sentinel æ§åˆ¶å°ä»£ç†ï¼ˆå¯é€‰ï¼‰
    # ============================================
    location /sentinel/ {
        proxy_pass http://localhost:8858/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # ============================================
    # Seata æ§åˆ¶å°ä»£ç†ï¼ˆå¯é€‰ï¼‰
    # ============================================
    location /seata/ {
        proxy_pass http://localhost:7091/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # ============================================
    # Kibana ä»£ç†ï¼ˆå¯é€‰ï¼‰
    # ============================================
    location /kibana/ {
        proxy_pass http://localhost:5601/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Kibana éœ€è¦ç‰¹æ®Šé…ç½®
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }
    
    # ============================================
    # å¥åº·æ£€æŸ¥
    # ============================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # ============================================
    # ç›‘æ§ç«¯ç‚¹ï¼ˆNginxçŠ¶æ€ï¼‰
    # ============================================
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;  # åªå…è®¸æœ¬æœºè®¿é—®
        deny all;
    }
}
```

##### 3. å¯ç”¨ Gzip å’Œæ€§èƒ½ä¼˜åŒ–

ç¼–è¾‘ä¸»é…ç½®ï¼š

```bash
sudo vi /etc/nginx/nginx.conf
```

åœ¨ `http` å—ä¸­æ·»åŠ ï¼š

```nginx
http {
    # ... å…¶ä»–é…ç½® ...
    
    # ============================================
    # æ€§èƒ½ä¼˜åŒ–
    # ============================================
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # ============================================
    # Gzip å‹ç¼©ï¼ˆèŠ‚çœ74%å¸¦å®½ï¼‰
    # ============================================
    gzip on;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        font/truetype
        font/opentype
        image/svg+xml;
    gzip_disable "msie6";
    
    # ============================================
    # è¿æ¥å’Œç¼“å†²ä¼˜åŒ–
    # ============================================
    client_max_body_size 50m;  # æœ€å¤§ä¸Šä¼ æ–‡ä»¶å¤§å°
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    
    # ============================================
    # ç¼“å­˜é…ç½®ï¼ˆä»£ç†ç¼“å­˜ï¼‰
    # ============================================
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    # ... å…¶ä»–é…ç½® ...
}
```

##### 4. å¯åŠ¨å’ŒéªŒè¯

```bash
# åˆ›å»ºç¼“å­˜ç›®å½•
sudo mkdir -p /var/cache/nginx
sudo chown nginx:nginx /var/cache/nginx

# æµ‹è¯•é…ç½®
sudo nginx -t

# å¯åŠ¨ Nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# éªŒè¯ç›‘å¬ç«¯å£
sudo netstat -tlnp | grep nginx

# æµ‹è¯•è®¿é—®
curl -I http://localhost
curl http://localhost/api/orders
```

##### 5. ç›‘æ§ Nginx çŠ¶æ€

```bash
# æŸ¥çœ‹ Nginx çŠ¶æ€
curl http://localhost/nginx_status

# è¾“å‡ºç¤ºä¾‹ï¼š
# Active connections: 291
# server accepts handled requests
#  16630948 16630948 31070465
# Reading: 6 Writing: 179 Waiting: 106

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/ecommerce_access.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/ecommerce_error.log
```

##### 6. æ€§èƒ½æµ‹è¯•

```bash
# å®‰è£…æµ‹è¯•å·¥å…·
sudo yum install -y httpd-tools

# æµ‹è¯•é™æ€èµ„æºæ€§èƒ½
ab -n 10000 -c 100 http://localhost/

# æµ‹è¯• API ä»£ç†æ€§èƒ½
ab -n 1000 -c 50 http://localhost/api/orders

# é¢„æœŸç»“æœï¼š
# - é™æ€èµ„æº QPS: > 50,000
# - API ä»£ç† QPS: > 5,000
```

##### 7. ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| **é™æ€èµ„æºQPS** | 3,245 | 52,189 | **16å€** âœ… |
| **é¦–é¡µåŠ è½½æ—¶é—´** | 1.4s | 0.37s | **3.8å€** âœ… |
| **å¸¦å®½æ¶ˆè€—** | 1,404 KB | 365 KB | **èŠ‚çœ74%** âœ… |
| **å†…å­˜å ç”¨** | 450 MB | 15 MB | **èŠ‚çœ96.7%** âœ… |

#### æ–¹å¼äºŒï¼šä½¿ç”¨ Docker éƒ¨ç½²å‰ç«¯

åˆ›å»º `frontend/Dockerfile`:

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

åˆ›å»º `frontend/nginx.conf`:

```nginx
server {
    listen 80;
    server_name localhost;
    
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://gateway-service:8000;
    }
}
```

æ„å»ºå’Œè¿è¡Œï¼š

```bash
cd ~/ecommerce-microservices/frontend

# æ„å»ºé•œåƒ
docker build -t ecommerce-frontend:1.0.0 .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name ecommerce-frontend \
  -p 80:80 \
  --network host \
  ecommerce-frontend:1.0.0
```

### 1.B.5 è®¿é—®å‰ç«¯

```bash
# å¼€å‘ç¯å¢ƒ
http://192.168.xxx.xxx:3000

# ç”Ÿäº§ç¯å¢ƒï¼ˆNginxï¼‰
http://192.168.xxx.xxx
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šSentinel æµé‡æ§åˆ¶ä¸ç†”æ–­é™çº§

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ Sentinelï¼Ÿ

**ç¬¬ä¸€ç‰ˆé—®é¢˜**ï¼š
- çªç„¶çš„å¤§æµé‡å¯èƒ½å‹å®æœåŠ¡
- ä¸‹æ¸¸æœåŠ¡æ•…éšœä¼šçº§è”å½±å“ä¸Šæ¸¸æœåŠ¡
- æ²¡æœ‰é™æµå’Œç†”æ–­æœºåˆ¶

**å‡çº§æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Sentinel å®ç°æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ã€‚

### 2.2 éƒ¨ç½² Sentinel Dashboard

```bash
# ä¸‹è½½ Sentinel Dashboard
mkdir -p ~/docker-env/sentinel
cd ~/docker-env/sentinel

wget https://github.com/alibaba/Sentinel/releases/download/1.8.6/sentinel-dashboard-1.8.6.jar

# å¯åŠ¨ Sentinel Dashboard
nohup java -Dserver.port=8858 \
  -Dcsp.sentinel.dashboard.server=localhost:8858 \
  -Dproject.name=sentinel-dashboard \
  -jar sentinel-dashboard-1.8.6.jar > sentinel.log 2>&1 &

# æˆ–ä½¿ç”¨ Docker å¯åŠ¨
docker run -d --name sentinel-dashboard \
  -p 8858:8858 \
  bladex/sentinel-dashboard:1.8.6

# è®¿é—® Sentinel æ§åˆ¶å°
# URL: http://è™šæ‹ŸæœºIP:8858
# ç”¨æˆ·å/å¯†ç : sentinel/sentinel
```

### 2.3 å¾®æœåŠ¡é›†æˆ Sentinel

#### 2.3.1 æ·»åŠ ä¾èµ–

åœ¨ `order-service` çš„ `pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<!-- Sentinel -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>

<!-- Sentinel æ•°æ®æº Nacos -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

#### 2.3.2 é…ç½® Sentinel

åœ¨ `application.yml` ä¸­æ·»åŠ ï¼š

```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: 192.168.xxx.xxx:8858
        port: 8719
      datasource:
        # æµæ§è§„åˆ™
        flow:
          nacos:
            server-addr: 192.168.xxx.xxx:8848
            dataId: ${spring.application.name}-flow-rules
            groupId: SENTINEL_GROUP
            rule-type: flow
        # é™çº§è§„åˆ™
        degrade:
          nacos:
            server-addr: 192.168.xxx.xxx:8848
            dataId: ${spring.application.name}-degrade-rules
            groupId: SENTINEL_GROUP
            rule-type: degrade
```

#### 2.3.3 ä½¿ç”¨ Sentinel æ³¨è§£

ä¿®æ”¹ `OrderController.java`ï¼š

```java
import com.alibaba.csp.sentinel.annotation.SentinelResource;
import com.alibaba.csp.sentinel.slots.block.BlockException;

@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    private final OrderService orderService;
    
    /**
     * åˆ›å»ºè®¢å• - é™æµä¿æŠ¤
     */
    @PostMapping
    @SentinelResource(
        value = "createOrder",
        blockHandler = "createOrderBlockHandler",
        fallback = "createOrderFallback"
    )
    public OrderResponse createOrder(@RequestBody OrderRequest request) {
        return orderService.createOrder(request);
    }
    
    /**
     * é™æµæ—¶çš„é™çº§æ–¹æ³•
     */
    public OrderResponse createOrderBlockHandler(OrderRequest request, BlockException ex) {
        log.warn("è®¢å•åˆ›å»ºè¢«é™æµ: {}", ex.getMessage());
        OrderResponse response = new OrderResponse();
        response.setOrderNo("BLOCKED");
        response.setStatus("RATE_LIMITED");
        return response;
    }
    
    /**
     * å¼‚å¸¸é™çº§æ–¹æ³•
     */
    public OrderResponse createOrderFallback(OrderRequest request, Throwable ex) {
        log.error("è®¢å•åˆ›å»ºå¼‚å¸¸é™çº§: {}", ex.getMessage());
        OrderResponse response = new OrderResponse();
        response.setOrderNo("FALLBACK");
        response.setStatus("ERROR");
        return response;
    }
}
```

### 2.4 é…ç½®æµæ§è§„åˆ™

åœ¨ Nacos ä¸­åˆ›å»ºé…ç½®ï¼š

**Data ID**: `order-service-flow-rules`  
**Group**: `SENTINEL_GROUP`  
**å†…å®¹**:

```json
[
  {
    "resource": "createOrder",
    "limitApp": "default",
    "grade": 1,
    "count": 10,
    "strategy": 0,
    "controlBehavior": 0,
    "clusterMode": false
  }
]
```

å‚æ•°è¯´æ˜ï¼š
- `resource`: èµ„æºåç§°
- `grade`: é™æµé˜ˆå€¼ç±»å‹ï¼ˆ0-çº¿ç¨‹æ•°ï¼Œ1-QPSï¼‰
- `count`: é™æµé˜ˆå€¼ï¼ˆæ¯ç§’ 10 ä¸ªè¯·æ±‚ï¼‰
- `strategy`: æµæ§æ¨¡å¼ï¼ˆ0-ç›´æ¥ï¼Œ1-å…³è”ï¼Œ2-é“¾è·¯ï¼‰
- `controlBehavior`: æµæ§æ•ˆæœï¼ˆ0-å¿«é€Ÿå¤±è´¥ï¼Œ1-Warm Upï¼Œ2-æ’é˜Ÿç­‰å¾…ï¼‰

### 2.5 é…ç½®ç†”æ–­é™çº§è§„åˆ™

**Data ID**: `order-service-degrade-rules`  
**Group**: `SENTINEL_GROUP`  
**å†…å®¹**:

```json
[
  {
    "resource": "createOrder",
    "grade": 0,
    "count": 0.5,
    "timeWindow": 10,
    "minRequestAmount": 5,
    "statIntervalMs": 1000
  }
]
```

å‚æ•°è¯´æ˜ï¼š
- `grade`: ç†”æ–­ç­–ç•¥ï¼ˆ0-æ…¢è°ƒç”¨æ¯”ä¾‹ï¼Œ1-å¼‚å¸¸æ¯”ä¾‹ï¼Œ2-å¼‚å¸¸æ•°ï¼‰
- `count`: æ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼ï¼ˆ50%ï¼‰
- `timeWindow`: ç†”æ–­æ—¶é•¿ï¼ˆ10ç§’ï¼‰
- `minRequestAmount`: æœ€å°è¯·æ±‚æ•°

### 2.6 å‹æµ‹éªŒè¯

ä½¿ç”¨ JMeter æˆ– ab å·¥å…·å‹æµ‹ï¼š

```bash
# ä½¿ç”¨ ab å·¥å…·å‹æµ‹
ab -n 1000 -c 50 -p order.json -T application/json http://localhost:8000/api/orders
```

è§‚å¯Ÿ Sentinel Dashboardï¼š
1. å®æ—¶ç›‘æ§ QPSã€å“åº”æ—¶é—´
2. æµæ§è§„åˆ™è§¦å‘æƒ…å†µ
3. ç†”æ–­é™çº§çŠ¶æ€

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šElasticsearch å…¨æ–‡æœç´¢

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ Elasticsearchï¼Ÿ

**ç¬¬ä¸€ç‰ˆé—®é¢˜**ï¼š
- PostgreSQL æ¨¡ç³ŠæŸ¥è¯¢æ•ˆç‡ä½
- æ— æ³•å®ç°å¤æ‚çš„å•†å“æœç´¢ï¼ˆå¤šæ¡ä»¶ã€åˆ†è¯ã€é«˜äº®ï¼‰
- æ— æ³•å®ç°å®æ—¶æœç´¢å»ºè®®

**å‡çº§æ–¹æ¡ˆ**ï¼šä½¿ç”¨ Elasticsearch æ„å»ºå•†å“æœç´¢ç³»ç»Ÿã€‚

### 3.2 éƒ¨ç½² ELK æ ˆ

```bash
mkdir -p ~/docker-env/elk
cd ~/docker-env/elk

cat > docker-compose.yml <<'EOF'
services:
  elasticsearch:
    image: elasticsearch:7.17.15
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - xpack.security.enabled=false
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - ./es-data:/usr/share/elasticsearch/data
    restart: always
  
  kibana:
    image: kibana:7.17.15
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    restart: always
  
  logstash:
    image: logstash:7.17.15
    container_name: logstash
    ports:
      - "5044:5044"
      - "9600:9600"
    volumes:
      - ./logstash/config:/usr/share/logstash/config
      - ./logstash/pipeline:/usr/share/logstash/pipeline
    depends_on:
      - elasticsearch
    restart: always
EOF

# åˆ›å»º Logstash é…ç½®
mkdir -p logstash/config logstash/pipeline

cat > logstash/config/logstash.yml <<'EOF'
http.host: "0.0.0.0"
xpack.monitoring.elasticsearch.hosts: [ "http://elasticsearch:9200" ]
EOF

cat > logstash/pipeline/logstash.conf <<'EOF'
input {
  tcp {
    port => 5044
    codec => json_lines
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
}
EOF

# èµ‹æƒå¹¶å¯åŠ¨
chmod 777 -R es-data/
docker-compose up -d

# éªŒè¯ ES
curl http://localhost:9200

# è®¿é—® Kibana
# URL: http://è™šæ‹ŸæœºIP:5601
```

### 3.3 åˆ›å»ºå•†å“æœç´¢æœåŠ¡

#### 3.3.1 åˆ›å»ºæ–°æ¨¡å— `search-service`

åœ¨çˆ¶ POM ä¸­æ·»åŠ æ¨¡å—ï¼š

```xml
<modules>
    ...
    <module>search-service</module>
</modules>
```

`search-service/pom.xml`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
    <parent>
        <groupId>com.demo</groupId>
        <artifactId>ecommerce-microservices</artifactId>
        <version>1.0.0</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>
    <artifactId>search-service</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <!-- Elasticsearch -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-elasticsearch</artifactId>
        </dependency>
        
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
    </dependencies>
</project>
```

#### 3.3.2 é…ç½® Elasticsearch

`search-service/src/main/resources/application.yml`:

```yaml
server:
  port: 8084

spring:
  application:
    name: search-service
  
  elasticsearch:
    uris: http://192.168.xxx.xxx:9200
  
  cloud:
    nacos:
      discovery:
        server-addr: 192.168.xxx.xxx:8848
```

#### 3.3.3 åˆ›å»ºå•†å“æ–‡æ¡£å®ä½“

```java
package com.demo.search.entity;

import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.elasticsearch.annotations.Document;
import org.springframework.data.elasticsearch.annotations.Field;
import org.springframework.data.elasticsearch.annotations.FieldType;
import java.math.BigDecimal;

@Data
@Document(indexName = "products")
public class ProductDocument {
    
    @Id
    private Long id;
    
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String name;
    
    @Field(type = FieldType.Keyword)
    private String category;
    
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String description;
    
    @Field(type = FieldType.Double)
    private BigDecimal price;
    
    @Field(type = FieldType.Integer)
    private Integer stock;
    
    @Field(type = FieldType.Keyword)
    private String brand;
    
    @Field(type = FieldType.Date)
    private String createTime;
}
```

#### 3.3.4 åˆ›å»º Repository

```java
package com.demo.search.repository;

import com.demo.search.entity.ProductDocument;
import org.springframework.data.elasticsearch.repository.ElasticsearchRepository;

import java.util.List;

public interface ProductSearchRepository extends ElasticsearchRepository<ProductDocument, Long> {
    
    // æ ¹æ®åç§°æœç´¢
    List<ProductDocument> findByNameLike(String name);
    
    // æ ¹æ®åˆ†ç±»æœç´¢
    List<ProductDocument> findByCategory(String category);
    
    // ä»·æ ¼åŒºé—´æœç´¢
    List<ProductDocument> findByPriceBetween(BigDecimal minPrice, BigDecimal maxPrice);
}
```

#### 3.3.5 åˆ›å»ºæœç´¢æœåŠ¡

```java
package com.demo.search.service;

import com.demo.search.entity.ProductDocument;
import com.demo.search.repository.ProductSearchRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.elasticsearch.index.query.QueryBuilders;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.data.elasticsearch.core.SearchHit;
import org.springframework.data.elasticsearch.core.SearchHits;
import org.springframework.data.elasticsearch.core.query.NativeSearchQuery;
import org.springframework.data.elasticsearch.core.query.NativeSearchQueryBuilder;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class ProductSearchService {
    
    private final ProductSearchRepository productSearchRepository;
    private final ElasticsearchRestTemplate elasticsearchTemplate;
    
    /**
     * æ·»åŠ æˆ–æ›´æ–°å•†å“åˆ°ç´¢å¼•
     */
    public ProductDocument indexProduct(ProductDocument product) {
        return productSearchRepository.save(product);
    }
    
    /**
     * æ‰¹é‡ç´¢å¼•å•†å“
     */
    public void indexProducts(List<ProductDocument> products) {
        productSearchRepository.saveAll(products);
    }
    
    /**
     * å…¨æ–‡æœç´¢ï¼ˆæ”¯æŒåˆ†è¯ï¼‰
     */
    public List<ProductDocument> searchProducts(String keyword, int page, int size) {
        NativeSearchQuery query = new NativeSearchQueryBuilder()
                .withQuery(QueryBuilders.multiMatchQuery(keyword, "name", "description", "brand"))
                .withPageable(PageRequest.of(page, size))
                .build();
        
        SearchHits<ProductDocument> searchHits = elasticsearchTemplate.search(query, ProductDocument.class);
        
        return searchHits.stream()
                .map(SearchHit::getContent)
                .collect(Collectors.toList());
    }
    
    /**
     * ä»·æ ¼åŒºé—´æœç´¢
     */
    public List<ProductDocument> searchByPriceRange(BigDecimal minPrice, BigDecimal maxPrice) {
        return productSearchRepository.findByPriceBetween(minPrice, maxPrice);
    }
    
    /**
     * åˆ†ç±»æœç´¢
     */
    public List<ProductDocument> searchByCategory(String category) {
        return productSearchRepository.findByCategory(category);
    }
    
    /**
     * åˆ é™¤å•†å“
     */
    public void deleteProduct(Long productId) {
        productSearchRepository.deleteById(productId);
    }
}
```

#### 3.3.6 åˆ›å»ºæœç´¢æ§åˆ¶å™¨

```java
package com.demo.search.controller;

import com.demo.search.entity.ProductDocument;
import com.demo.search.service.ProductSearchService;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.math.BigDecimal;
import java.util.List;

@RestController
@RequestMapping("/api/search")
@RequiredArgsConstructor
public class SearchController {
    
    private final ProductSearchService searchService;
    
    /**
     * å…¨æ–‡æœç´¢
     */
    @GetMapping("/products")
    public List<ProductDocument> searchProducts(
            @RequestParam String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        return searchService.searchProducts(keyword, page, size);
    }
    
    /**
     * ä»·æ ¼åŒºé—´æœç´¢
     */
    @GetMapping("/products/price")
    public List<ProductDocument> searchByPrice(
            @RequestParam BigDecimal minPrice,
            @RequestParam BigDecimal maxPrice) {
        return searchService.searchByPriceRange(minPrice, maxPrice);
    }
    
    /**
     * åˆ†ç±»æœç´¢
     */
    @GetMapping("/products/category/{category}")
    public List<ProductDocument> searchByCategory(@PathVariable String category) {
        return searchService.searchByCategory(category);
    }
    
    /**
     * æ·»åŠ å•†å“åˆ°ç´¢å¼•
     */
    @PostMapping("/products")
    public ProductDocument indexProduct(@RequestBody ProductDocument product) {
        return searchService.indexProduct(product);
    }
}
```

### 3.4 æµ‹è¯•æœç´¢åŠŸèƒ½

```bash
# 1. æ·»åŠ æµ‹è¯•å•†å“åˆ° ES
curl -X POST http://localhost:8084/api/search/products \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1001,
    "name": "iPhone 15 Pro 256GB é»‘è‰²",
    "category": "æ‰‹æœº",
    "description": "Apple iPhone 15 Pro é’›é‡‘å±è®¾è®¡ A17 Pro èŠ¯ç‰‡",
    "price": 8999,
    "stock": 100,
    "brand": "Apple"
  }'

# 2. å…¨æ–‡æœç´¢
curl "http://localhost:8084/api/search/products?keyword=iPhone&page=0&size=10"

# 3. ä»·æ ¼åŒºé—´æœç´¢
curl "http://localhost:8084/api/search/products/price?minPrice=5000&maxPrice=10000"

# 4. åˆ†ç±»æœç´¢
curl "http://localhost:8084/api/search/products/category/æ‰‹æœº"
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šRedis é«˜çº§ç‰¹æ€§

### 4.1 Redisson åˆ†å¸ƒå¼é”

#### 4.1.1 æ·»åŠ  Redisson ä¾èµ–

åœ¨ `inventory-service/pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<!-- Redisson -->
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson-spring-boot-starter</artifactId>
    <version>3.23.4</version>
</dependency>
```

#### 4.1.2 é…ç½® Redisson

`application.yml`:

```yaml
spring:
  redis:
    redisson:
      config: |
        singleServerConfig:
          address: "redis://192.168.xxx.xxx:6379"
          password: redis
          database: 0
```

#### 4.1.3 ä½¿ç”¨åˆ†å¸ƒå¼é”

ä¿®æ”¹ `InventoryService.java`ï¼š

```java
import org.redisson.api.RLock;
import org.redisson.api.RedissonClient;

@Service
@RequiredArgsConstructor
public class InventoryService {
    
    private final InventoryRepository inventoryRepository;
    private final RedissonClient redissonClient;
    
    /**
     * æ‰£å‡åº“å­˜ - ä½¿ç”¨åˆ†å¸ƒå¼é”
     */
    @Transactional
    public boolean deductInventory(Long productId, Integer quantity) {
        String lockKey = "inventory:lock:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•åŠ é”ï¼Œæœ€å¤šç­‰å¾… 5 ç§’ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ 10 ç§’
            boolean isLocked = lock.tryLock(5, 10, TimeUnit.SECONDS);
            
            if (!isLocked) {
                log.warn("è·å–åˆ†å¸ƒå¼é”å¤±è´¥: {}", lockKey);
                return false;
            }
            
            log.info("è·å–åˆ†å¸ƒå¼é”æˆåŠŸ: {}", lockKey);
            
            // æŸ¥è¯¢åº“å­˜
            Inventory inventory = inventoryRepository.findByProductId(productId)
                    .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨"));
            
            // æ£€æŸ¥åº“å­˜
            if (inventory.getStock() < quantity) {
                log.warn("åº“å­˜ä¸è¶³: productId={}, å½“å‰åº“å­˜={}, éœ€è¦={}",
                        productId, inventory.getStock(), quantity);
                return false;
            }
            
            // æ‰£å‡åº“å­˜
            inventory.setStock(inventory.getStock() - quantity);
            inventory.setVersion(inventory.getVersion() + 1);
            inventoryRepository.save(inventory);
            
            // æ›´æ–° Redis ç¼“å­˜
            String cacheKey = "inventory:" + productId;
            redisTemplate.opsForValue().set(cacheKey, String.valueOf(inventory.getStock()));
            
            log.info("åº“å­˜æ‰£å‡æˆåŠŸ: productId={}, å‰©ä½™åº“å­˜={}", productId, inventory.getStock());
            return true;
            
        } catch (InterruptedException e) {
            log.error("è·å–é”è¢«ä¸­æ–­", e);
            Thread.currentThread().interrupt();
            return false;
        } finally {
            // é‡Šæ”¾é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
                log.info("é‡Šæ”¾åˆ†å¸ƒå¼é”: {}", lockKey);
            }
        }
    }
}
```

### 4.2 å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€

```java
import org.redisson.api.RBloomFilter;

@Configuration
public class RedissonConfig {
    
    @Bean
    public RBloomFilter<Long> productBloomFilter(RedissonClient redissonClient) {
        RBloomFilter<Long> bloomFilter = redissonClient.getBloomFilter("product:bloom:filter");
        
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼šé¢„æœŸå…ƒç´ æ•°é‡ 10000ï¼Œè¯¯åˆ¤ç‡ 0.01
        bloomFilter.tryInit(10000L, 0.01);
        
        return bloomFilter;
    }
}

@Service
@RequiredArgsConstructor
public class InventoryService {
    
    private final RBloomFilter<Long> productBloomFilter;
    
    /**
     * åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
     */
    @PostConstruct
    public void initBloomFilter() {
        List<Inventory> allProducts = inventoryRepository.findAll();
        for (Inventory product : allProducts) {
            productBloomFilter.add(product.getProductId());
        }
        log.info("å¸ƒéš†è¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆï¼Œå•†å“æ•°é‡: {}", allProducts.size());
    }
    
    /**
     * æŸ¥è¯¢åº“å­˜ - ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨
     */
    public Integer getStock(Long productId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!productBloomFilter.contains(productId)) {
            log.warn("å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å•†å“ä¸å­˜åœ¨: {}", productId);
            throw new RuntimeException("å•†å“ä¸å­˜åœ¨");
        }
        
        // 2. æŸ¥è¯¢ Redis ç¼“å­˜
        String cacheKey = "inventory:" + productId;
        String cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return Integer.valueOf(cached);
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        Inventory inventory = inventoryRepository.findByProductId(productId)
                .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨"));
        
        // 4. å†™å›ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, String.valueOf(inventory.getStock()), 30, TimeUnit.MINUTES);
        
        return inventory.getStock();
    }
}
```

### 4.3 å¤šçº§ç¼“å­˜æ¶æ„

```java
import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;

@Configuration
public class CacheConfig {
    
    /**
     * æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
     */
    @Bean
    public Cache<String, Object> localCache() {
        return Caffeine.newBuilder()
                .maximumSize(1000)
                .expireAfterWrite(5, TimeUnit.MINUTES)
                .recordStats()
                .build();
    }
}

@Service
@RequiredArgsConstructor
public class InventoryService {
    
    private final Cache<String, Object> localCache;
    private final StringRedisTemplate redisTemplate;
    private final InventoryRepository inventoryRepository;
    
    /**
     * ä¸‰çº§ç¼“å­˜æŸ¥è¯¢åº“å­˜
     */
    public Integer getStock(Long productId) {
        String cacheKey = "inventory:" + productId;
        
        // 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜ï¼ˆL1ï¼‰
        Object localCached = localCache.getIfPresent(cacheKey);
        if (localCached != null) {
            log.info("ä»æœ¬åœ°ç¼“å­˜è·å–: {}", cacheKey);
            return (Integer) localCached;
        }
        
        // 2. æŸ¥è¯¢ Redis ç¼“å­˜ï¼ˆL2ï¼‰
        String redisCached = redisTemplate.opsForValue().get(cacheKey);
        if (redisCached != null) {
            log.info("ä»Redisç¼“å­˜è·å–: {}", cacheKey);
            Integer stock = Integer.valueOf(redisCached);
            
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(cacheKey, stock);
            return stock;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“ï¼ˆL3ï¼‰
        Inventory inventory = inventoryRepository.findByProductId(productId)
                .orElseThrow(() -> new RuntimeException("å•†å“ä¸å­˜åœ¨"));
        
        Integer stock = inventory.getStock();
        log.info("ä»æ•°æ®åº“æŸ¥è¯¢: {}", cacheKey);
        
        // 4. å†™å› Redis å’Œæœ¬åœ°ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, String.valueOf(stock), 30, TimeUnit.MINUTES);
        localCache.put(cacheKey, stock);
        
        return stock;
    }
}
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šRabbitMQ é«˜çº§ç‰¹æ€§

### 5.1 æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥æ¶ˆæ¯

```java
@Configuration
public class RabbitMQConfig {
    
    /**
     * æ­£å¸¸é˜Ÿåˆ—
     */
    @Bean
    public Queue notificationQueue() {
        Map<String, Object> args = new HashMap<>();
        // è®¾ç½®æ­»ä¿¡äº¤æ¢æœº
        args.put("x-dead-letter-exchange", "dlx.exchange");
        args.put("x-dead-letter-routing-key", "dlx.notification");
        // æ¶ˆæ¯ TTL
        args.put("x-message-ttl", 60000); // 60ç§’
        
        return new Queue("notification.queue", true, false, false, args);
    }
    
    /**
     * æ­»ä¿¡é˜Ÿåˆ—
     */
    @Bean
    public Queue deadLetterQueue() {
        return new Queue("dlx.notification.queue", true);
    }
    
    /**
     * æ­»ä¿¡äº¤æ¢æœº
     */
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("dlx.exchange");
    }
    
    /**
     * æ­»ä¿¡é˜Ÿåˆ—ç»‘å®š
     */
    @Bean
    public Binding deadLetterBinding() {
        return BindingBuilder
                .bind(deadLetterQueue())
                .to(deadLetterExchange())
                .with("dlx.notification");
    }
    
    /**
     * æ™®é€šäº¤æ¢æœº
     */
    @Bean
    public TopicExchange orderExchange() {
        return new TopicExchange("order.exchange");
    }
    
    /**
     * æ™®é€šé˜Ÿåˆ—ç»‘å®š
     */
    @Bean
    public Binding notificationBinding() {
        return BindingBuilder
                .bind(notificationQueue())
                .to(orderExchange())
                .with("notification.#");
    }
}
```

å¤„ç†æ­»ä¿¡é˜Ÿåˆ—ï¼š

```java
@Service
@Slf4j
public class DeadLetterService {
    
    /**
     * ç›‘å¬æ­»ä¿¡é˜Ÿåˆ—
     */
    @RabbitListener(queues = "dlx.notification.queue")
    public void handleDeadLetter(Message message) {
        log.error("=== æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯ ===");
        log.error("æ¶ˆæ¯å†…å®¹: {}", new String(message.getBody()));
        log.error("æ­»å› : {}", message.getMessageProperties().getHeaders().get("x-first-death-reason"));
        log.error("æ­»äº¡æ—¶é—´: {}", message.getMessageProperties().getHeaders().get("x-first-death-queue"));
        
        // å¯ä»¥å°†å¤±è´¥æ¶ˆæ¯å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œäººå·¥å¤„ç†
        // æˆ–è€…å‘é€å‘Šè­¦é€šçŸ¥
    }
}
```

### 5.2 æ¶ˆæ¯ç¡®è®¤æœºåˆ¶

```yaml
spring:
  rabbitmq:
    publisher-confirm-type: correlated
    publisher-returns: true
    template:
      mandatory: true
    listener:
      simple:
        acknowledge-mode: manual
```

```java
@Configuration
public class RabbitMQCallbackConfig implements RabbitTemplate.ConfirmCallback, RabbitTemplate.ReturnsCallback {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @PostConstruct
    public void init() {
        rabbitTemplate.setConfirmCallback(this);
        rabbitTemplate.setReturnsCallback(this);
    }
    
    @Override
    public void confirm(CorrelationData correlationData, boolean ack, String cause) {
        if (ack) {
            log.info("æ¶ˆæ¯å‘é€æˆåŠŸ: {}", correlationData);
        } else {
            log.error("æ¶ˆæ¯å‘é€å¤±è´¥: {}, åŸå› : {}", correlationData, cause);
        }
    }
    
    @Override
    public void returnedMessage(ReturnedMessage returned) {
        log.error("æ¶ˆæ¯è¢«é€€å›: {}", returned);
    }
}
```

æ‰‹åŠ¨ ACKï¼š

```java
@Service
public class NotificationService {
    
    @RabbitListener(queues = "notification.queue")
    public void handleNotification(Message message, Channel channel) throws IOException {
        try {
            String content = new String(message.getBody());
            log.info("å¤„ç†é€šçŸ¥æ¶ˆæ¯: {}", content);
            
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            // ...
            
            // æ‰‹åŠ¨ ACK
            channel.basicAck(message.getMessageProperties().getDeliveryTag(), false);
            log.info("æ¶ˆæ¯ACKæˆåŠŸ");
            
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥", e);
            
            // æ¶ˆæ¯é‡æ–°å…¥é˜Ÿ
            channel.basicNack(message.getMessageProperties().getDeliveryTag(), false, true);
        }
    }
}
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šShardingSphere åˆ†åº“åˆ†è¡¨

### 6.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†åº“åˆ†è¡¨ï¼Ÿ

**ç¬¬ä¸€ç‰ˆé—®é¢˜**ï¼š
- å•è¡¨æ•°æ®é‡è¶…è¿‡ 1000 ä¸‡åæŸ¥è¯¢å˜æ…¢
- å•åº“å‹åŠ›è¿‡å¤§
- æ— æ³•æ°´å¹³æ‰©å±•

**å‡çº§æ–¹æ¡ˆ**ï¼šä½¿ç”¨ ShardingSphere å®ç°åˆ†åº“åˆ†è¡¨ã€‚

### 6.2 å¼•å…¥ ShardingSphere

`order-service/pom.xml`:

```xml
<!-- ShardingSphere -->
<dependency>
    <groupId>org.apache.shardingsphere</groupId>
    <artifactId>shardingsphere-jdbc-core</artifactId>
    <version>5.3.2</version>
</dependency>
```

### 6.3 é…ç½®åˆ†ç‰‡è§„åˆ™

`application.yml`:

```yaml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1
      
      # æ•°æ®æº 0
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: org.postgresql.Driver
        jdbc-url: jdbc:postgresql://192.168.xxx.xxx:5432/order_db_0
        username: admin
        password: Admin@123
      
      # æ•°æ®æº 1
      ds1:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: org.postgresql.Driver
        jdbc-url: jdbc:postgresql://192.168.xxx.xxx:5432/order_db_1
        username: admin
        password: Admin@123
    
    rules:
      sharding:
        tables:
          # è®¢å•è¡¨åˆ†ç‰‡è§„åˆ™
          t_order:
            actual-data-nodes: ds$->{0..1}.t_order_$->{0..3}
            # åˆ†åº“ç­–ç•¥ï¼šæŒ‰ user_id å–æ¨¡
            database-strategy:
              standard:
                sharding-column: user_id
                sharding-algorithm-name: order-db-inline
            # åˆ†è¡¨ç­–ç•¥ï¼šæŒ‰ order_no å–æ¨¡
            table-strategy:
              standard:
                sharding-column: order_no
                sharding-algorithm-name: order-table-inline
        
        sharding-algorithms:
          # åˆ†åº“ç®—æ³•
          order-db-inline:
            type: INLINE
            props:
              algorithm-expression: ds$->{user_id % 2}
          
          # åˆ†è¡¨ç®—æ³•
          order-table-inline:
            type: INLINE
            props:
              algorithm-expression: t_order_$->{order_no.hashCode().abs() % 4}
    
    props:
      sql-show: true
```

### 6.4 åˆ›å»ºåˆ†åº“åˆ†è¡¨

```sql
-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE order_db_0;
CREATE DATABASE order_db_1;

-- åœ¨æ¯ä¸ªæ•°æ®åº“ä¸­åˆ›å»º 4 å¼ åˆ†è¡¨
-- order_db_0
\c order_db_0;
CREATE TABLE t_order_0 (LIKE t_order INCLUDING ALL);
CREATE TABLE t_order_1 (LIKE t_order INCLUDING ALL);
CREATE TABLE t_order_2 (LIKE t_order INCLUDING ALL);
CREATE TABLE t_order_3 (LIKE t_order INCLUDING ALL);

-- order_db_1
\c order_db_1;
CREATE TABLE t_order_0 (LIKE t_order INCLUDING ALL);
CREATE TABLE t_order_1 (LIKE t_order INCLUDING ALL);
CREATE TABLE t_order_2 (LIKE t_order INCLUDING ALL);
CREATE TABLE t_order_3 (LIKE t_order INCLUDING ALL);
```

### 6.5 æµ‹è¯•åˆ†ç‰‡

```bash
# åˆ›å»ºè®¢å•ï¼ˆä¸åŒçš„ user_id ä¼šè·¯ç”±åˆ°ä¸åŒçš„åº“è¡¨ï¼‰
curl -X POST http://localhost:8000/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1001,
    "productId": 1001,
    "productName": "iPhone 15 Pro",
    "quantity": 1,
    "totalAmount": 8999.00
  }'

# è§‚å¯Ÿæ—¥å¿—ï¼ŒæŸ¥çœ‹ SQL è·¯ç”±åˆ°å“ªä¸ªåº“è¡¨
# Logic SQL: INSERT INTO t_order ...
# Actual SQL: ds0 ::: INSERT INTO t_order_2 ...
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šSpring Security + JWT è®¤è¯

### 7.1 æ·»åŠ ä¾èµ–

åˆ›å»ºæ–°æ¨¡å— `auth-service`ï¼š

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    
    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- JWT -->
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-api</artifactId>
        <version>0.11.5</version>
    </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-impl</artifactId>
        <version>0.11.5</version>
    </dependency>
    <dependency>
        <groupId>io.jsonwebtoken</groupId>
        <artifactId>jjwt-jackson</artifactId>
        <version>0.11.5</version>
    </dependency>
    
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
</dependencies>
```

### 7.2 JWT å·¥å…·ç±»

```java
package com.demo.auth.util;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import org.springframework.stereotype.Component;

import java.security.Key;
import java.util.Date;

@Component
public class JwtUtil {
    
    private static final String SECRET_KEY = "mySecretKeyForJWTTokenGenerationAndValidation123456";
    private static final long EXPIRATION_TIME = 86400000; // 24å°æ—¶
    
    private final Key key = Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
    
    /**
     * ç”Ÿæˆ Token
     */
    public String generateToken(String username) {
        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(key, SignatureAlgorithm.HS256)
                .compact();
    }
    
    /**
     * éªŒè¯ Token
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                    .setSigningKey(key)
                    .build()
                    .parseClaimsJws(token);
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            return false;
        }
    }
    
    /**
     * ä» Token è·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        Claims claims = Jwts.parserBuilder()
                .setSigningKey(key)
                .build()
                .parseClaimsJws(token)
                .getBody();
        return claims.getSubject();
    }
}
```

### 7.3 è®¤è¯æ§åˆ¶å™¨

```java
@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {
    
    private final AuthenticationManager authenticationManager;
    private final JwtUtil jwtUtil;
    
    @PostMapping("/login")
    public Map<String, String> login(@RequestBody LoginRequest request) {
        Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                        request.getUsername(),
                        request.getPassword()
                )
        );
        
        SecurityContextHolder.getContext().setAuthentication(authentication);
        String token = jwtUtil.generateToken(request.getUsername());
        
        return Map.of("token", token);
    }
    
    @PostMapping("/register")
    public String register(@RequestBody RegisterRequest request) {
        // æ³¨å†Œé€»è¾‘
        return "æ³¨å†ŒæˆåŠŸ";
    }
}
```

### 7.4 JWT è¿‡æ»¤å™¨

```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {
        
        String header = request.getHeader("Authorization");
        
        if (header != null && header.startsWith("Bearer ")) {
            String token = header.substring(7);
            
            if (jwtUtil.validateToken(token)) {
                String username = jwtUtil.getUsernameFromToken(token);
                
                UsernamePasswordAuthenticationToken authentication =
                        new UsernamePasswordAuthenticationToken(username, null, Collections.emptyList());
                
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

### 7.5 ç½‘å…³é›†æˆ JWT éªŒè¯

åœ¨ `gateway-service` ä¸­æ·»åŠ å…¨å±€è¿‡æ»¤å™¨ï¼š

```java
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String path = exchange.getRequest().getURI().getPath();
        
        // ç™½åå•è·¯å¾„
        if (path.startsWith("/api/auth/")) {
            return chain.filter(exchange);
        }
        
        // éªŒè¯ JWT
        String token = exchange.getRequest().getHeaders().getFirst("Authorization");
        
        if (token == null || !token.startsWith("Bearer ")) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        
        String jwtToken = token.substring(7);
        
        if (!jwtUtil.validateToken(jwtToken)) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();
        }
        
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return -100;
    }
}
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šXXL-Job åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

### 8.1 éƒ¨ç½² XXL-Job Admin

```bash
mkdir -p ~/docker-env/xxl-job
cd ~/docker-env/xxl-job

# åˆ›å»ºæ•°æ®åº“
docker exec -it postgres psql -U admin -d postgres -c "CREATE DATABASE xxl_job;"

# ä¸‹è½½å¹¶å¯¼å…¥è¡¨ç»“æ„
wget https://raw.githubusercontent.com/xuxueli/xxl-job/master/doc/db/tables_xxl_job.sql

# å¯¼å…¥è¡¨ç»“æ„ï¼ˆéœ€è¦è½¬æ¢ä¸º PostgreSQL è¯­æ³•ï¼‰
# æˆ–ä½¿ç”¨ MySQL ä½œä¸º XXL-Job çš„æ•°æ®åº“

# ä½¿ç”¨ Docker å¯åŠ¨ XXL-Job Admin
docker run -d \
  --name xxl-job-admin \
  -p 8099:8080 \
  -e PARAMS="--spring.datasource.url=jdbc:mysql://192.168.xxx.xxx:3306/xxl_job \
  --spring.datasource.username=root \
  --spring.datasource.password=root" \
  xuxueli/xxl-job-admin:2.4.0

# è®¿é—® XXL-Job æ§åˆ¶å°
# URL: http://è™šæ‹ŸæœºIP:8099/xxl-job-admin
# ç”¨æˆ·å/å¯†ç : admin/123456
```

### 8.2 å¾®æœåŠ¡é›†æˆ XXL-Job

`order-service/pom.xml`:

```xml
<!-- XXL-Job -->
<dependency>
    <groupId>com.xuxueli</groupId>
    <artifactId>xxl-job-core</artifactId>
    <version>2.4.0</version>
</dependency>
```

é…ç½®ï¼š

```yaml
xxl:
  job:
    admin:
      addresses: http://192.168.xxx.xxx:8099/xxl-job-admin
    executor:
      appname: order-service-executor
      port: 9999
      logpath: /data/applogs/xxl-job/jobhandler
      logretentiondays: 30
```

åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼š

```java
@Component
@Slf4j
public class OrderJobHandler {
    
    /**
     * æ¯å¤©å‡Œæ™¨æ¸…ç† 30 å¤©å‰çš„è®¢å•
     */
    @XxlJob("cleanOldOrders")
    public void cleanOldOrders() {
        log.info("å¼€å§‹æ¸…ç†æ—§è®¢å•");
        
        LocalDateTime thirtyDaysAgo = LocalDateTime.now().minusDays(30);
        
        // æ¸…ç†é€»è¾‘
        // orderRepository.deleteByCreateTimeBefore(thirtyDaysAgo);
        
        log.info("æ¸…ç†æ—§è®¢å•å®Œæˆ");
    }
    
    /**
     * æ¯å°æ—¶æ£€æŸ¥è¶…æ—¶æœªæ”¯ä»˜è®¢å•
     */
    @XxlJob("cancelTimeoutOrders")
    public void cancelTimeoutOrders() {
        log.info("å¼€å§‹æ£€æŸ¥è¶…æ—¶è®¢å•");
        
        LocalDateTime oneHourAgo = LocalDateTime.now().minusHours(1);
        
        // å–æ¶ˆè¶…æ—¶è®¢å•
        // List<Order> timeoutOrders = orderRepository.findByStatusAndCreateTimeBefore("PENDING", oneHourAgo);
        // timeoutOrders.forEach(order -> order.setStatus("CANCELLED"));
        // orderRepository.saveAll(timeoutOrders);
        
        log.info("æ£€æŸ¥è¶…æ—¶è®¢å•å®Œæˆ");
    }
}
```

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šMinIO å¯¹è±¡å­˜å‚¨

### 9.1 éƒ¨ç½² MinIO

```bash
mkdir -p ~/docker-env/minio/data

docker run -d \
  --name minio \
  -p 9000:9000 \
  -p 9001:9001 \
  -e MINIO_ROOT_USER=admin \
  -e MINIO_ROOT_PASSWORD=Admin@123 \
  -v ~/docker-env/minio/data:/data \
  --restart=always \
  minio/minio:latest \
  server /data --console-address ":9001"

# è®¿é—® MinIO æ§åˆ¶å°
# URL: http://è™šæ‹ŸæœºIP:9001
# ç”¨æˆ·å/å¯†ç : admin/Admin@123
```

### 9.2 é›†æˆ MinIO

```xml
<!-- MinIO -->
<dependency>
    <groupId>io.minio</groupId>
    <artifactId>minio</artifactId>
    <version>8.5.7</version>
</dependency>
```

é…ç½®ï¼š

```yaml
minio:
  endpoint: http://192.168.xxx.xxx:9000
  accessKey: admin
  secretKey: Admin@123
  bucket: ecommerce
```

MinIO æœåŠ¡ï¼š

```java
@Service
@RequiredArgsConstructor
public class MinIOService {
    
    private final MinioClient minioClient;
    
    /**
     * ä¸Šä¼ æ–‡ä»¶
     */
    public String uploadFile(MultipartFile file, String folder) throws Exception {
        String fileName = folder + "/" + UUID.randomUUID() + "-" + file.getOriginalFilename();
        
        minioClient.putObject(
                PutObjectArgs.builder()
                        .bucket("ecommerce")
                        .object(fileName)
                        .stream(file.getInputStream(), file.getSize(), -1)
                        .contentType(file.getContentType())
                        .build()
        );
        
        return fileName;
    }
    
    /**
     * è·å–æ–‡ä»¶è®¿é—® URL
     */
    public String getFileUrl(String fileName) throws Exception {
        return minioClient.getPresignedObjectUrl(
                GetPresignedObjectUrlArgs.builder()
                        .bucket("ecommerce")
                        .object(fileName)
                        .method(Method.GET)
                        .expiry(7, TimeUnit.DAYS)
                        .build()
        );
    }
}
```

---

## ç¬¬åéƒ¨åˆ†ï¼šé«˜çº§ç›‘æ§ä¸å‘Šè­¦

### 10.1 é…ç½® Grafana å‘Šè­¦

1. ç™»å½• Grafana (http://è™šæ‹ŸæœºIP:3000)
2. åˆ›å»ºå‘Šè­¦è§„åˆ™ï¼š
   - æ¡ä»¶ï¼šCPU ä½¿ç”¨ç‡ > 80%
   - æ¡ä»¶ï¼šå†…å­˜ä½¿ç”¨ç‡ > 90%
   - æ¡ä»¶ï¼šæ¥å£å“åº”æ—¶é—´ > 1s
3. é…ç½®é€šçŸ¥æ¸ é“ï¼ˆé‚®ä»¶ã€é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰

### 10.2 SkyWalking è‡ªå®šä¹‰åŸ‹ç‚¹

```java
import org.apache.skywalking.apm.toolkit.trace.ActiveSpan;
import org.apache.skywalking.apm.toolkit.trace.Trace;
import org.apache.skywalking.apm.toolkit.trace.TraceContext;

@Service
public class OrderService {
    
    @Trace
    @Tags({@Tag(key = "ä¸šåŠ¡ç±»å‹", value = "è®¢å•åˆ›å»º")})
    public OrderResponse createOrder(OrderRequest request) {
        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
        ActiveSpan.tag("userId", String.valueOf(request.getUserId()));
        ActiveSpan.tag("productId", String.valueOf(request.getProductId()));
        
        // è·å– TraceId
        String traceId = TraceContext.traceId();
        log.info("TraceId: {}", traceId);
        
        // ä¸šåŠ¡é€»è¾‘...
    }
}
```

### 10.3 é…ç½® Logstash æ—¥å¿—æ”¶é›†

åœ¨å¾®æœåŠ¡ä¸­æ·»åŠ  Logstash appenderï¼š

```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
        <destination>192.168.xxx.xxx:5044</destination>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder" />
    </appender>
    
    <root level="INFO">
        <appender-ref ref="LOGSTASH" />
    </root>
</configuration>
```

åœ¨ Kibana ä¸­åˆ›å»ºç´¢å¼•æ¨¡å¼ï¼ŒæŸ¥çœ‹å’Œåˆ†ææ—¥å¿—ã€‚

---

## ç¬¬åä¸€éƒ¨åˆ†ï¼šæ€§èƒ½ä¼˜åŒ–æ€»ç»“

### 11.1 æ•°æ®åº“ä¼˜åŒ–æ¸…å•

âœ… æ·»åŠ åˆé€‚çš„ç´¢å¼•  
âœ… ä½¿ç”¨è¿æ¥æ± ï¼ˆHikariCPï¼‰  
âœ… è¯»å†™åˆ†ç¦»ï¼ˆShardingSphereï¼‰  
âœ… åˆ†åº“åˆ†è¡¨ï¼ˆShardingSphereï¼‰  
âœ… æ…¢ SQL ç›‘æ§ï¼ˆDruidï¼‰  

### 11.2 ç¼“å­˜ä¼˜åŒ–æ¸…å•

âœ… å¤šçº§ç¼“å­˜ï¼ˆæœ¬åœ° + Redisï¼‰  
âœ… å¸ƒéš†è¿‡æ»¤å™¨é˜²æ­¢ç¼“å­˜ç©¿é€  
âœ… åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿  
âœ… ç¼“å­˜é¢„çƒ­  
âœ… ç¼“å­˜æ›´æ–°ç­–ç•¥ï¼ˆCanal + MQï¼‰  

### 11.3 æœåŠ¡æ²»ç†æ¸…å•

âœ… é™æµé™çº§ï¼ˆSentinelï¼‰  
âœ… ç†”æ–­æœºåˆ¶ï¼ˆSentinelï¼‰  
âœ… è¶…æ—¶æ§åˆ¶  
âœ… é‡è¯•æœºåˆ¶ï¼ˆSpring Retryï¼‰  
âœ… è´Ÿè½½å‡è¡¡  

### 11.4 æ¶ˆæ¯é˜Ÿåˆ—ä¼˜åŒ–æ¸…å•

âœ… æ¶ˆæ¯å¯é æ€§ï¼ˆç¡®è®¤æœºåˆ¶ï¼‰  
âœ… æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥æ¶ˆæ¯  
âœ… æ¶ˆæ¯å¹‚ç­‰æ€§  
âœ… æ¶ˆæ¯é¡ºåºæ€§  

---

## ç¬¬åäºŒéƒ¨åˆ†ï¼šé¡¹ç›®æ€»ç»“ä¸é¢è¯•è¦ç‚¹

### 12.1 å‡çº§ç‰ˆæŠ€æœ¯æ ˆ

| åˆ†ç±» | æŠ€æœ¯ | ä½œç”¨ |
|------|------|------|
| **äº‹åŠ¡** | Seata | åˆ†å¸ƒå¼äº‹åŠ¡ |
| **æµæ§** | Sentinel | é™æµã€ç†”æ–­ã€é™çº§ |
| **æœç´¢** | Elasticsearch | å…¨æ–‡æœç´¢ |
| **ç¼“å­˜** | Redis + Redisson + Caffeine | å¤šçº§ç¼“å­˜ã€åˆ†å¸ƒå¼é” |
| **æ•°æ®åº“** | ShardingSphere | åˆ†åº“åˆ†è¡¨ |
| **ä»»åŠ¡** | XXL-Job | åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ |
| **å­˜å‚¨** | MinIO | å¯¹è±¡å­˜å‚¨ |
| **å®‰å…¨** | Spring Security + JWT | è®¤è¯æˆæƒ |
| **æ—¥å¿—** | ELK (ES + Logstash + Kibana) | æ—¥å¿—æ”¶é›†åˆ†æ |
| **ç›‘æ§** | SkyWalking + Prometheus + Grafana | é“¾è·¯è¿½è¸ªã€æŒ‡æ ‡ç›‘æ§ |

### 12.2 é¢è¯•é«˜é¢‘é—®é¢˜

#### Q1: å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§ï¼Ÿ
**å›ç­”**: ä½¿ç”¨ Seata AT æ¨¡å¼ï¼Œé€šè¿‡ undo_log å®ç°è‡ªåŠ¨å›æ»šã€‚è®¢å•åˆ›å»ºæ—¶å¼€å¯å…¨å±€äº‹åŠ¡ï¼Œè°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜ï¼Œä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½ä¼šè§¦å‘å…¨å±€å›æ»šã€‚

#### Q2: å¦‚ä½•é˜²æ­¢ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ï¼Ÿ
**å›ç­”**: 
- ç©¿é€ï¼šä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨è¿‡æ»¤ä¸å­˜åœ¨çš„è¯·æ±‚
- å‡»ç©¿ï¼šä½¿ç”¨ Redisson åˆ†å¸ƒå¼é”ï¼Œåªæœ‰ä¸€ä¸ªè¯·æ±‚æŸ¥è¯¢æ•°æ®åº“
- é›ªå´©ï¼šè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´ï¼Œä½¿ç”¨å¤šçº§ç¼“å­˜

#### Q3: å¦‚ä½•ä¿è¯é«˜å¹¶å‘ä¸‹çš„åº“å­˜å‡†ç¡®æ€§ï¼Ÿ
**å›ç­”**: ä½¿ç”¨ Redisson åˆ†å¸ƒå¼é” + æ•°æ®åº“ä¹è§‚é”ï¼ˆversion å­—æ®µï¼‰åŒé‡ä¿è¯ã€‚

#### Q4: å¦‚ä½•å®ç°é™æµé™çº§ï¼Ÿ
**å›ç­”**: ä½¿ç”¨ Sentinel é…ç½®æµæ§è§„åˆ™ï¼ŒQPS è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘é™æµï¼Œè¿”å›é™çº§å“åº”ã€‚åŒæ—¶é…ç½®ç†”æ–­è§„åˆ™ï¼Œé”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼æ—¶è‡ªåŠ¨ç†”æ–­ã€‚

#### Q5: å¦‚ä½•å®ç°åˆ†åº“åˆ†è¡¨ï¼Ÿ
**å›ç­”**: ä½¿ç”¨ ShardingSphereï¼ŒæŒ‰ user_id åˆ†åº“ï¼ŒæŒ‰ order_no åˆ†è¡¨ã€‚é…ç½®åˆ†ç‰‡ç®—æ³•ï¼ˆå–æ¨¡ï¼‰ï¼Œè‡ªåŠ¨è·¯ç”± SQL åˆ°å¯¹åº”çš„åº“è¡¨ã€‚

#### Q6: å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§ï¼Ÿ
**å›ç­”**: 
- ç”Ÿäº§è€…ï¼šå¼€å¯å‘é€ç¡®è®¤ï¼ˆpublisher-confirmsï¼‰
- æ¶ˆè´¹è€…ï¼šæ‰‹åŠ¨ ACKï¼Œå¤±è´¥é‡è¯•
- ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥æ¶ˆæ¯

### 12.3 é¡¹ç›®äº®ç‚¹æ€»ç»“

ğŸŒŸ **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šä½¿ç”¨ Seata ä¿è¯è®¢å•å’Œåº“å­˜çš„å¼ºä¸€è‡´æ€§  
ğŸŒŸ **é«˜å¹¶å‘ä¼˜åŒ–**ï¼šå¤šçº§ç¼“å­˜ + åˆ†å¸ƒå¼é” + å¸ƒéš†è¿‡æ»¤å™¨  
ğŸŒŸ **æµé‡æ§åˆ¶**ï¼šSentinel é™æµé™çº§ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§  
ğŸŒŸ **æ°´å¹³æ‰©å±•**ï¼šShardingSphere åˆ†åº“åˆ†è¡¨ï¼Œæ”¯æŒæµ·é‡æ•°æ®  
ğŸŒŸ **å…¨æ–‡æœç´¢**ï¼šElasticsearch å®ç°å¤æ‚å•†å“æœç´¢  
ğŸŒŸ **å¾®æœåŠ¡æ²»ç†**ï¼šå®Œæ•´çš„ç›‘æ§ã€é“¾è·¯è¿½è¸ªã€æ—¥å¿—åˆ†æ  

---

## é™„å½•ï¼šå¿«é€Ÿéƒ¨ç½²è„šæœ¬

### start-all-advanced.sh

```bash
#!/bin/bash

echo "=== å¯åŠ¨å‡çº§ç‰ˆå¾®æœåŠ¡ç³»ç»Ÿ ==="

# 1. å¯åŠ¨åŸºç¡€ä¸­é—´ä»¶
echo "1. å¯åŠ¨åŸºç¡€ä¸­é—´ä»¶..."
docker start postgres redis kafka zookeeper rabbitmq nacos

# 2. å¯åŠ¨é«˜çº§ä¸­é—´ä»¶
echo "2. å¯åŠ¨é«˜çº§ä¸­é—´ä»¶..."
cd ~/docker-env/seata && docker-compose start
cd ~/docker-env/elk && docker-compose start
cd ~/docker-env/xxl-job && docker start xxl-job-admin
docker start minio sentinel-dashboard

# 3. å¯åŠ¨ç›‘æ§
echo "3. å¯åŠ¨ç›‘æ§..."
cd ~/docker-env/monitor && docker-compose start
cd ~/docker-env/skywalking && docker-compose start

sleep 60

# 4. å¯åŠ¨å¾®æœåŠ¡
echo "4. å¯åŠ¨å¾®æœåŠ¡..."
cd ~/ecommerce-microservices

# å¯åŠ¨è®¤è¯æœåŠ¡
java -jar auth-service/target/auth-service-1.0.0.jar > logs/auth-service.log 2>&1 &

# å¯åŠ¨è®¢å•æœåŠ¡
java -jar order-service/target/order-service-1.0.0.jar > logs/order-service.log 2>&1 &

# å¯åŠ¨åº“å­˜æœåŠ¡
java -jar inventory-service/target/inventory-service-1.0.0.jar > logs/inventory-service.log 2>&1 &

# å¯åŠ¨é€šçŸ¥æœåŠ¡
java -jar notification-service/target/notification-service-1.0.0.jar > logs/notification-service.log 2>&1 &

# å¯åŠ¨æœç´¢æœåŠ¡
java -jar search-service/target/search-service-1.0.0.jar > logs/search-service.log 2>&1 &

# å¯åŠ¨ç½‘å…³
java -jar gateway-service/target/gateway-service-1.0.0.jar > logs/gateway-service.log 2>&1 &

echo "=== æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨ ==="
echo ""
echo "è®¿é—®åœ°å€:"
echo "  - API ç½‘å…³: http://localhost:8000"
echo "  - Nacos: http://localhost:8848/nacos"
echo "  - Sentinel: http://localhost:8858 (sentinel/sentinel)"
echo "  - SkyWalking: http://localhost:8080"
echo "  - Grafana: http://localhost:3000 (admin/Admin@123)"
echo "  - Kibana: http://localhost:5601"
echo "  - MinIO: http://localhost:9001 (admin/Admin@123)"
echo "  - XXL-Job: http://localhost:8099/xxl-job-admin (admin/123456)"
echo "  - RabbitMQ: http://localhost:15672 (admin/Admin@123)"
```

---

## æ€»ç»“

é€šè¿‡æœ¬å‡çº§ç‰ˆæ–‡æ¡£ï¼Œä½ å°†æŒæ¡ï¼š

âœ… **åˆ†å¸ƒå¼äº‹åŠ¡**ï¼šSeata ä¿è¯æ•°æ®ä¸€è‡´æ€§  
âœ… **æµé‡æ²»ç†**ï¼šSentinel é™æµé™çº§ç†”æ–­  
âœ… **å…¨æ–‡æœç´¢**ï¼šElasticsearch å¤æ‚æœç´¢  
âœ… **é«˜çº§ç¼“å­˜**ï¼šå¤šçº§ç¼“å­˜ã€åˆ†å¸ƒå¼é”ã€å¸ƒéš†è¿‡æ»¤å™¨  
âœ… **æ•°æ®åº“æ‰©å±•**ï¼šShardingSphere åˆ†åº“åˆ†è¡¨  
âœ… **æ¶ˆæ¯å¯é æ€§**ï¼šæ­»ä¿¡é˜Ÿåˆ—ã€ç¡®è®¤æœºåˆ¶  
âœ… **å®‰å…¨è®¤è¯**ï¼šJWT ç»Ÿä¸€è®¤è¯  
âœ… **ä»»åŠ¡è°ƒåº¦**ï¼šXXL-Job å®šæ—¶ä»»åŠ¡  
âœ… **å¯¹è±¡å­˜å‚¨**ï¼šMinIO æ–‡ä»¶ç®¡ç†  
âœ… **æ—¥å¿—åˆ†æ**ï¼šELK æ—¥å¿—ç³»ç»Ÿ  

è¿™æ˜¯ä¸€ä¸ª**ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒæ ‡å‡†çš„å¾®æœåŠ¡æ¶æ„**ï¼Œå®Œå…¨å¯ä»¥åº”å¯¹å„ç§é«˜é¢‘é¢è¯•é—®é¢˜ï¼

**ç¥ä½ å­¦ä¹ é¡ºåˆ©ï¼Œé¢è¯•æˆåŠŸï¼ğŸš€**


# Javaå¾®æœåŠ¡ç²¾ç®€é«˜çº§ç‰ˆéƒ¨ç½²æŒ‡å—
## ä¸“ä¸º 4æ ¸16G é…ç½®ä¼˜åŒ–

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

**é€‚ç”¨é…ç½®**ï¼š
- CPU: 4æ ¸
- å†…å­˜: 16GB
- ç£ç›˜: 100GB

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- ä½¿ç”¨ K3sï¼ˆè½»é‡çº§ Kubernetesï¼‰
- å•å‰¯æœ¬éƒ¨ç½²
- ä¸¥æ ¼èµ„æºé™åˆ¶
- ä¸éƒ¨ç½² Istio å’Œ ELK
- æŒ‰éœ€å¯åŠ¨ä¸­é—´ä»¶

**èƒ½è¾¾åˆ°çš„æ•ˆæœ**ï¼š
- æŒæ¡ Kubernetes æ ¸å¿ƒèƒ½åŠ› âœ…
- æŒæ¡ JVM æ€§èƒ½è°ƒä¼˜ âœ…
- æŒæ¡æ•°æ®åº“ä¼˜åŒ– âœ…
- è–ªèµ„ç›®æ ‡ï¼š20K-35K âœ…

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šK3s è½»é‡çº§ Kubernetes

### 1.1 ä¸ºä»€ä¹ˆé€‰æ‹© K3sï¼Ÿ

| ç‰¹æ€§ | æ ‡å‡† K8s | K3s |
|------|---------|-----|
| **å†…å­˜å ç”¨** | 4GB+ | 2GB |
| **å®‰è£…å¤æ‚åº¦** | é«˜ | ä½ |
| **ç»„ä»¶æ•°é‡** | å¤šä¸ª | å•ä¸ªäºŒè¿›åˆ¶ |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | å¼€å‘/è¾¹ç¼˜ |

**K3s ä¼˜åŠ¿**ï¼š
- âœ… 5 åˆ†é’Ÿå®‰è£…å®Œæˆ
- âœ… å†…å­˜å ç”¨å‡å°‘ 50%
- âœ… åŒ…å«æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
- âœ… å®Œå…¨å…¼å®¹ Kubernetes API

### 1.2 å®‰è£… K3s

```bash
# ä¸€é”®å®‰è£… K3s
curl -sfL https://get.k3s.io | sh -

# ç­‰å¾…å®‰è£…å®Œæˆï¼ˆçº¦ 1-2 åˆ†é’Ÿï¼‰
# å®‰è£…æˆåŠŸåï¼ŒK3s ä¼šè‡ªåŠ¨å¯åŠ¨

# é…ç½® kubectlï¼ˆå¯é€‰ï¼‰
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $USER ~/.kube/config

# éªŒè¯å®‰è£…
kubectl get nodes

# è¾“å‡ºç¤ºä¾‹ï¼š
# NAME        STATUS   ROLES                  AGE   VERSION
# dev-server  Ready    control-plane,master   1m    v1.28.3+k3s1

# æŸ¥çœ‹ K3s èµ„æºå ç”¨
kubectl top nodes
```

### 1.3 K3s èµ„æºä¼˜åŒ–

#### 1.3.1 é…ç½® K3s å†…å­˜é™åˆ¶

```bash
# ç¼–è¾‘ K3s é…ç½®
sudo vi /etc/systemd/system/k3s.service

# åœ¨ ExecStart è¡Œæ·»åŠ å‚æ•°
ExecStart=/usr/local/bin/k3s \
    server \
    --kube-apiserver-arg=max-requests-inflight=800 \
    --kube-apiserver-arg=max-mutating-requests-inflight=400

# é‡å¯ K3s
sudo systemctl daemon-reload
sudo systemctl restart k3s
```

#### 1.3.2 ç¦ç”¨ä¸éœ€è¦çš„ç»„ä»¶

```bash
# å¸è½½ Traefikï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
kubectl delete helmchart traefik -n kube-system

# å¸è½½ ServiceLBï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
kubectl delete deployment servicelb -n kube-system
```

### 1.4 å®‰è£… Helm

```bash
# å®‰è£… Helm 3
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# éªŒè¯å®‰è£…
helm version

# æ·»åŠ å¸¸ç”¨ Chart ä»“åº“
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update
```

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šéƒ¨ç½²ä¸­é—´ä»¶ï¼ˆèµ„æºä¼˜åŒ–ç‰ˆï¼‰

### 2.1 åˆ›å»ºå‘½åç©ºé—´

```bash
# åˆ›å»ºä¸­é—´ä»¶å‘½åç©ºé—´
kubectl create namespace middleware

# åˆ›å»ºåº”ç”¨å‘½åç©ºé—´
kubectl create namespace apps
```

### 2.2 éƒ¨ç½² PostgreSQLï¼ˆå•å®ä¾‹ + èµ„æºé™åˆ¶ï¼‰

```bash
# åˆ›å»º values æ–‡ä»¶
cat > postgres-values.yaml <<EOF
auth:
  username: admin
  password: Admin@123
  database: order_db

primary:
  persistence:
    size: 5Gi
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# ä¸éƒ¨ç½²ä»åº“
readReplicas:
  replicaCount: 0

metrics:
  enabled: false
EOF

# ä½¿ç”¨ Helm éƒ¨ç½²
helm install postgres bitnami/postgresql \
  --namespace middleware \
  --values postgres-values.yaml

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n middleware

# è·å–å¯†ç 
export POSTGRES_PASSWORD=$(kubectl get secret --namespace middleware postgres-postgresql -o jsonpath="{.data.postgres-password}" | base64 -d)
echo "PostgreSQL å¯†ç : $POSTGRES_PASSWORD"

# ç«¯å£è½¬å‘ï¼ˆæœ¬åœ°è®¿é—®ï¼‰
kubectl port-forward --namespace middleware svc/postgres-postgresql 5432:5432 &

# æµ‹è¯•è¿æ¥
psql -h localhost -U admin -d order_db
```

#### 2.2.1 åˆå§‹åŒ–æ•°æ®åº“

```bash
# å¤åˆ¶åˆå§‹åŒ–è„šæœ¬åˆ° Pod
kubectl cp init.sql middleware/postgres-postgresql-0:/tmp/

# æ‰§è¡Œåˆå§‹åŒ–
kubectl exec -it -n middleware postgres-postgresql-0 -- \
  psql -U admin -d order_db -f /tmp/init.sql
```

åˆå§‹åŒ–è„šæœ¬ `init.sql`ï¼š

```sql
-- åˆ›å»ºè®¢å•è¡¨
CREATE TABLE IF NOT EXISTS t_order (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(64) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    product_name VARCHAR(255),
    quantity INT NOT NULL,
    total_amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'PENDING',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºåº“å­˜è¡¨
CREATE TABLE IF NOT EXISTS t_inventory (
    id BIGSERIAL PRIMARY KEY,
    product_id BIGINT NOT NULL UNIQUE,
    product_name VARCHAR(255),
    stock INT NOT NULL,
    version INT DEFAULT 0,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ’å…¥æµ‹è¯•æ•°æ®
INSERT INTO t_inventory (product_id, product_name, stock) VALUES
(1001, 'iPhone 15 Pro', 100),
(1002, 'åä¸ºMate 60', 200),
(1003, 'å°ç±³14 Ultra', 150)
ON CONFLICT (product_id) DO NOTHING;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_order_no ON t_order(order_no);
CREATE INDEX IF NOT EXISTS idx_user_id ON t_order(user_id);
CREATE INDEX IF NOT EXISTS idx_product_id ON t_inventory(product_id);
```

### 2.3 éƒ¨ç½² Redisï¼ˆå•å®ä¾‹ + èµ„æºé™åˆ¶ï¼‰

```bash
# åˆ›å»º values æ–‡ä»¶
cat > redis-values.yaml <<EOF
auth:
  password: redis

master:
  persistence:
    size: 2Gi
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 250m
      memory: 128Mi

# ä¸éƒ¨ç½²ä»èŠ‚ç‚¹
replica:
  replicaCount: 0

metrics:
  enabled: false
EOF

# éƒ¨ç½² Redis
helm install redis bitnami/redis \
  --namespace middleware \
  --values redis-values.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n middleware | grep redis

# ç«¯å£è½¬å‘
kubectl port-forward --namespace middleware svc/redis-master 6379:6379 &

# æµ‹è¯•è¿æ¥
redis-cli -h localhost -a redis ping
# åº”è¿”å›: PONG
```

### 2.4 éƒ¨ç½² Kafkaï¼ˆå•èŠ‚ç‚¹ + èµ„æºé™åˆ¶ï¼‰

```bash
# åˆ›å»º values æ–‡ä»¶
cat > kafka-values.yaml <<EOF
replicaCount: 1

persistence:
  size: 5Gi

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

zookeeper:
  replicaCount: 1
  persistence:
    size: 2Gi
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

metrics:
  kafka:
    enabled: false
  jmx:
    enabled: false
EOF

# éƒ¨ç½² Kafka
helm install kafka bitnami/kafka \
  --namespace middleware \
  --values kafka-values.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n middleware | grep kafka

# åˆ›å»º Topic
kubectl exec -it -n middleware kafka-0 -- \
  kafka-topics.sh --create \
    --bootstrap-server localhost:9092 \
    --topic order-created \
    --partitions 3 \
    --replication-factor 1

kubectl exec -it -n middleware kafka-0 -- \
  kafka-topics.sh --create \
    --bootstrap-server localhost:9092 \
    --topic inventory-updated \
    --partitions 3 \
    --replication-factor 1
```

### 2.5 éƒ¨ç½² Nacosï¼ˆå•æœºæ¨¡å¼ï¼‰

```bash
# åˆ›å»º Nacos éƒ¨ç½²æ–‡ä»¶
cat > nacos-deployment.yaml <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nacos
  namespace: middleware
spec:
  selector:
    app: nacos
  ports:
  - name: http
    port: 8848
    targetPort: 8848
  - name: grpc
    port: 9848
    targetPort: 9848
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nacos
  namespace: middleware
spec:
  serviceName: nacos
  replicas: 1
  selector:
    matchLabels:
      app: nacos
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
      - name: nacos
        image: nacos/nacos-server:v2.2.3
        ports:
        - containerPort: 8848
          name: http
        - containerPort: 9848
          name: grpc
        env:
        - name: MODE
          value: "standalone"
        - name: NACOS_AUTH_ENABLE
          value: "true"
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
          requests:
            cpu: 250m
            memory: 256Mi
        volumeMounts:
        - name: nacos-data
          mountPath: /home/nacos/data
  volumeClaimTemplates:
  - metadata:
      name: nacos-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 2Gi
EOF

# éƒ¨ç½² Nacos
kubectl apply -f nacos-deployment.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n middleware | grep nacos

# ç«¯å£è½¬å‘
kubectl port-forward --namespace middleware svc/nacos 8848:8848 &

# è®¿é—® Nacos æ§åˆ¶å°
# URL: http://localhost:8848/nacos
# ç”¨æˆ·å/å¯†ç : nacos/nacos
```

### 2.6 æŸ¥çœ‹ä¸­é—´ä»¶èµ„æºå ç”¨

```bash
# æŸ¥çœ‹æ‰€æœ‰ Pod çš„èµ„æºå ç”¨
kubectl top pods -n middleware

# è¾“å‡ºç¤ºä¾‹ï¼š
# NAME                       CPU(cores)   MEMORY(bytes)
# postgres-postgresql-0      50m          350Mi
# redis-master-0             30m          180Mi
# kafka-0                    200m         800Mi
# kafka-zookeeper-0          50m          300Mi
# nacos-0                    100m         400Mi
# -------------------------------------------
# æ€»è®¡:                      çº¦ 430m      çº¦ 2GB
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šå¾®æœåŠ¡ Helm åŒ–éƒ¨ç½²

### 3.1 åˆ›å»º Helm Chart

```bash
# ä¸ºè®¢å•æœåŠ¡åˆ›å»º Chart
helm create order-service

# Chart ç›®å½•ç»“æ„
# order-service/
# â”œâ”€â”€ Chart.yaml
# â”œâ”€â”€ values.yaml
# â””â”€â”€ templates/
#     â”œâ”€â”€ deployment.yaml
#     â”œâ”€â”€ service.yaml
#     â”œâ”€â”€ configmap.yaml
#     â”œâ”€â”€ secret.yaml
#     â””â”€â”€ hpa.yaml
```

### 3.2 é…ç½® Chart.yaml

```yaml
apiVersion: v2
name: order-service
description: è®¢å•æœåŠ¡ Helm Chartï¼ˆç²¾ç®€ç‰ˆï¼‰
type: application
version: 1.0.0
appVersion: "1.0.0"
```

### 3.3 é…ç½® values.yamlï¼ˆèµ„æºä¼˜åŒ–ï¼‰

```yaml
# å‰¯æœ¬é…ç½®
replicaCount: 1  # å•å‰¯æœ¬

# é•œåƒé…ç½®
image:
  repository: order-service
  pullPolicy: IfNotPresent
  tag: "1.0.0"

# æœåŠ¡é…ç½®
service:
  type: ClusterIP
  port: 8081

# èµ„æºé™åˆ¶ï¼ˆå…³é”®ï¼ï¼‰
resources:
  limits:
    cpu: 500m        # 0.5 æ ¸
    memory: 512Mi    # 512MB
  requests:
    cpu: 250m        # 0.25 æ ¸
    memory: 256Mi    # 256MB

# HPA é…ç½®ï¼ˆé™åˆ¶æœ€å¤§å‰¯æœ¬æ•°ï¼‰
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 3   # æœ€å¤š 3 ä¸ªï¼ˆè€Œä¸æ˜¯ 10 ä¸ªï¼‰
  targetCPUUtilizationPercentage: 80
  targetMemoryUtilizationPercentage: 80

# JVM é…ç½®
env:
  - name: SPRING_PROFILES_ACTIVE
    value: "k8s"
  - name: JAVA_OPTS
    value: "-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

# ä¸­é—´ä»¶è¿æ¥é…ç½®
middleware:
  postgres:
    host: "postgres-postgresql.middleware"
    port: 5432
    database: "order_db"
    username: "admin"
    password: "Admin@123"
  
  redis:
    host: "redis-master.middleware"
    port: 6379
    password: "redis"
  
  kafka:
    bootstrapServers: "kafka.middleware:9092"
  
  nacos:
    serverAddr: "nacos.middleware:8848"
    namespace: "public"
```

### 3.4 é…ç½® Deployment æ¨¡æ¿

ç¼–è¾‘ `templates/deployment.yaml`ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "order-service.fullname" . }}
  labels:
    {{- include "order-service.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "order-service.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "order-service.selectorLabels" . | nindent 8 }}
    spec:
      containers:
      - name: {{ .Chart.Name }}
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        ports:
        - name: http
          containerPort: 8081
          protocol: TCP
        
        # ç¯å¢ƒå˜é‡
        env:
        {{- range .Values.env }}
        - name: {{ .name }}
          value: {{ .value | quote }}
        {{- end }}
        
        # æ•°æ®åº“é…ç½®
        - name: SPRING_DATASOURCE_URL
          value: "jdbc:postgresql://{{ .Values.middleware.postgres.host }}:{{ .Values.middleware.postgres.port }}/{{ .Values.middleware.postgres.database }}"
        - name: SPRING_DATASOURCE_USERNAME
          value: {{ .Values.middleware.postgres.username }}
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "order-service.fullname" . }}-secret
              key: postgres-password
        
        # Redis é…ç½®
        - name: SPRING_REDIS_HOST
          value: {{ .Values.middleware.redis.host }}
        - name: SPRING_REDIS_PORT
          value: {{ .Values.middleware.redis.port | quote }}
        - name: SPRING_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "order-service.fullname" . }}-secret
              key: redis-password
        
        # Kafka é…ç½®
        - name: SPRING_KAFKA_BOOTSTRAP_SERVERS
          value: {{ .Values.middleware.kafka.bootstrapServers }}
        
        # Nacos é…ç½®
        - name: SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR
          value: {{ .Values.middleware.nacos.serverAddr }}
        - name: SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR
          value: {{ .Values.middleware.nacos.serverAddr }}
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: http
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: http
          initialDelaySeconds: 30
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # èµ„æºé™åˆ¶
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
```

### 3.5 é…ç½® HPA æ¨¡æ¿

ç¼–è¾‘ `templates/hpa.yaml`ï¼š

```yaml
{{- if .Values.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "order-service.fullname" . }}
  labels:
    {{- include "order-service.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "order-service.fullname" . }}
  minReplicas: {{ .Values.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.autoscaling.maxReplicas }}
  metrics:
  {{- if .Values.autoscaling.targetCPUUtilizationPercentage }}
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetCPUUtilizationPercentage }}
  {{- end }}
  {{- if .Values.autoscaling.targetMemoryUtilizationPercentage }}
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: {{ .Values.autoscaling.targetMemoryUtilizationPercentage }}
  {{- end }}
{{- end }}
```

### 3.6 é…ç½® Secret æ¨¡æ¿

åˆ›å»º `templates/secret.yaml`ï¼š

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "order-service.fullname" . }}-secret
  labels:
    {{- include "order-service.labels" . | nindent 4 }}
type: Opaque
stringData:
  postgres-password: {{ .Values.middleware.postgres.password }}
  redis-password: {{ .Values.middleware.redis.password }}
```

### 3.7 æ„å»º Docker é•œåƒ

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º Dockerfile
cd ~/ecommerce-microservices/order-service

cat > Dockerfile <<EOF
# ä½¿ç”¨è½»é‡çº§åŸºç¡€é•œåƒ
FROM openjdk:8-jdk-alpine

# æ·»åŠ åº”ç”¨
COPY target/order-service-1.0.0.jar /app.jar

# æš´éœ²ç«¯å£
EXPOSE 8081

# å¯åŠ¨åº”ç”¨
ENTRYPOINT ["java", "-jar", "/app.jar"]
EOF

# æ„å»ºé•œåƒ
docker build -t order-service:1.0.0 .

# éªŒè¯é•œåƒ
docker images | grep order-service
```

### 3.8 éƒ¨ç½²å¾®æœåŠ¡

```bash
# éƒ¨ç½²è®¢å•æœåŠ¡
helm install order-service ./order-service \
  --namespace apps \
  --create-namespace

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n apps

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f -n apps -l app=order-service

# æŸ¥çœ‹ HPA
kubectl get hpa -n apps

# æŸ¥çœ‹æœåŠ¡
kubectl get svc -n apps
```

### 3.9 æµ‹è¯•æœåŠ¡

```bash
# ç«¯å£è½¬å‘
kubectl port-forward -n apps svc/order-service 8081:8081 &

# å¥åº·æ£€æŸ¥
curl http://localhost:8081/actuator/health

# åˆ›å»ºè®¢å•
curl -X POST http://localhost:8081/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "userId": 1001,
    "productId": 1001,
    "productName": "iPhone 15 Pro",
    "quantity": 2,
    "totalAmount": 16998.00
  }'
```

### 3.10 åŒæ ·æ–¹å¼éƒ¨ç½²å…¶ä»–æœåŠ¡

```bash
# å¤åˆ¶ Chart å¹¶ä¿®æ”¹
cp -r order-service inventory-service
cp -r order-service notification-service
cp -r order-service gateway-service

# ä¿®æ”¹ Chart.yaml å’Œ values.yaml ä¸­çš„æœåŠ¡åå’Œç«¯å£

# éƒ¨ç½²
helm install inventory-service ./inventory-service --namespace apps
helm install notification-service ./notification-service --namespace apps
helm install gateway-service ./gateway-service --namespace apps

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡
kubectl get pods -n apps
kubectl get svc -n apps
```

### 3.11 ç½‘å…³æœåŠ¡ç‰¹æ®Šé…ç½®

ç½‘å…³æœåŠ¡éœ€è¦ç‰¹æ®Šçš„ `values.yaml` é…ç½®ï¼š

`gateway-service/values.yaml`:

```yaml
replicaCount: 1

image:
  repository: gateway-service
  pullPolicy: IfNotPresent
  tag: "1.0.0"

service:
  type: NodePort  # ä½¿ç”¨ NodePort æš´éœ²åˆ°å¤–éƒ¨
  port: 8000
  nodePort: 30000  # å›ºå®šèŠ‚ç‚¹ç«¯å£

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 250m
    memory: 256Mi

autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 80

env:
  - name: SPRING_PROFILES_ACTIVE
    value: "k8s"
  - name: JAVA_OPTS
    value: "-Xms256m -Xmx512m -XX:+UseG1GC"

# ç½‘å…³é…ç½®
gateway:
  routes:
    - id: order-service
      uri: "lb://order-service"
      predicates:
        - Path=/api/orders/**
    - id: inventory-service
      uri: "lb://inventory-service"
      predicates:
        - Path=/api/inventory/**
    - id: notification-service
      uri: "lb://notification-service"
      predicates:
        - Path=/api/notifications/**

middleware:
  nacos:
    serverAddr: "nacos.middleware:8848"
    namespace: "public"
```

### 3.12 éƒ¨ç½²ç½‘å…³

```bash
# åˆ›å»ºç½‘å…³ç‰¹å®šçš„ Service é…ç½®
cat > gateway-service/templates/service.yaml <<'EOF'
apiVersion: v1
kind: Service
metadata:
  name: {{ include "gateway-service.fullname" . }}
  labels:
    {{- include "gateway-service.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
  - port: {{ .Values.service.port }}
    targetPort: http
    protocol: TCP
    name: http
    {{- if .Values.service.nodePort }}
    nodePort: {{ .Values.service.nodePort }}
    {{- end }}
  selector:
    {{- include "gateway-service.selectorLabels" . | nindent 4 }}
EOF

# éƒ¨ç½²ç½‘å…³
helm install gateway-service ./gateway-service --namespace apps

# éªŒè¯ç½‘å…³
kubectl get svc -n apps gateway-service

# åº”è¯¥çœ‹åˆ°ï¼š
# NAME              TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
# gateway-service   NodePort   10.43.xxx.xxx   <none>        8000:30000/TCP   1m

# é€šè¿‡ NodePort è®¿é—®ç½‘å…³
curl http://192.168.xxx.xxx:30000/api/orders/health
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šå‰ç«¯é¡¹ç›® Kubernetes éƒ¨ç½²

### 4.0 å‰ç«¯éƒ¨ç½²åˆ° K3s

å‰ç«¯å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼éƒ¨ç½²åˆ° Kubernetesã€‚

#### 4.0.1 æ–¹å¼ä¸€ï¼šä½¿ç”¨ Nginx Ingress éƒ¨ç½²å‰ç«¯

åˆ›å»ºå‰ç«¯ Dockerfileï¼š

`frontend/Dockerfile`:

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16-alpine as build
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

åˆ›å»º Nginx é…ç½®ï¼ˆKubernetes ä¼˜åŒ–ç‰ˆï¼‰ï¼š

`frontend/nginx.conf`:

```nginx
# ============================================
# å‰ç«¯ Nginx é…ç½®ï¼ˆKubernetes ç¯å¢ƒï¼‰
# åŠŸèƒ½ï¼šé™æ€èµ„æº + APIä»£ç† + æ€§èƒ½ä¼˜åŒ–
# ============================================

server {
    listen 80;
    server_name localhost;
    
    # æ—¥å¿—é…ç½®ï¼ˆè¾“å‡ºåˆ°å®¹å™¨æ ‡å‡†è¾“å‡ºï¼‰
    access_log /dev/stdout combined;
    error_log /dev/stderr warn;
    
    # é™æ€èµ„æºæ ¹ç›®å½•
    root /usr/share/nginx/html;
    index index.html;
    
    # ============================================
    # å‰ç«¯é™æ€èµ„æº
    # ============================================
    location / {
        # SPA è·¯ç”±æ”¯æŒ
        try_files $uri $uri/ /index.html;
        
        # å®‰å…¨å¤´
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
    
    # HTMLï¼šä¸ç¼“å­˜
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    # JS/CSSï¼šå¼ºç¼“å­˜1å¹´ï¼ˆæ–‡ä»¶åå¸¦hashï¼‰
    location ~* \.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # å›¾ç‰‡ï¼šç¼“å­˜30å¤©
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 30d;
        add_header Cache-Control "public";
    }
    
    # å­—ä½“ï¼šç¼“å­˜1å¹´
    location ~* \.(woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public";
        add_header Access-Control-Allow-Origin *;
    }
    
    # ============================================
    # API ä»£ç†åˆ° Gatewayï¼ˆKubernetes æœåŠ¡å‘ç°ï¼‰
    # ============================================
    location /api/ {
        # ä½¿ç”¨ Kubernetes DNS æœåŠ¡å‘ç°
        # æ ¼å¼ï¼šæœåŠ¡å.å‘½åç©ºé—´.svc.cluster.local
        proxy_pass http://gateway-service.apps.svc.cluster.local:8000;
        
        # è¯·æ±‚å¤´é…ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # ç¼“å†²é…ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # ============================================
    # å¥åº·æ£€æŸ¥
    # ============================================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

ä¼˜åŒ– Dockerfileï¼ˆå¤šé˜¶æ®µæ„å»º + Alpineï¼‰ï¼š

`frontend/Dockerfile`:

```dockerfile
# ============================================
# æ„å»ºé˜¶æ®µ
# ============================================
FROM node:18-alpine as build

WORKDIR /app

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm config set registry https://registry.npmmirror.com && \
    npm install

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
RUN npm run build

# ============================================
# è¿è¡Œé˜¶æ®µï¼ˆä½¿ç”¨ Nginx Alpineï¼‰
# ============================================
FROM nginx:1.25-alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=build /app/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# åˆ é™¤é»˜è®¤é…ç½®
RUN rm /etc/nginx/conf.d/default.conf.default 2>/dev/null || true

# æ·»åŠ å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨ Nginx
CMD ["nginx", "-g", "daemon off;"]
```

**ä¼˜åŒ–è¯´æ˜ï¼š**
- âœ… ä½¿ç”¨ Alpine é•œåƒï¼Œæœ€ç»ˆé•œåƒå¤§å°ä»… ~50MBï¼ˆvs æ™®é€šç‰ˆ ~200MBï¼‰
- âœ… å¤šé˜¶æ®µæ„å»ºï¼Œä¸åŒ…å« node_modules å’Œæºä»£ç 
- âœ… å†…ç½®å¥åº·æ£€æŸ¥ï¼ŒKubernetes è‡ªåŠ¨ç›‘æ§
- âœ… ä½¿ç”¨å›½å†…é•œåƒæºï¼ŒåŠ é€Ÿæ„å»º

æ„å»ºé•œåƒï¼š

```bash
cd ~/ecommerce-microservices/frontend

# æ„å»º Docker é•œåƒ
docker build -t ecommerce-frontend:1.0.0 .

# éªŒè¯é•œåƒå¤§å°ï¼ˆåº”è¯¥çº¦50MBï¼‰
docker images | grep ecommerce-frontend

# æµ‹è¯•é•œåƒ
docker run -d -p 8080:80 --name test-frontend ecommerce-frontend:1.0.0
curl http://localhost:8080/health
docker rm -f test-frontend
```

åˆ›å»º Kubernetes éƒ¨ç½²é…ç½®ï¼ˆå®Œæ•´ç‰ˆï¼ŒåŒ…å« Ingressï¼‰ï¼š

`frontend/k8s-deployment.yaml`:

```yaml
# ============================================
# Deploymentï¼šå‰ç«¯åº”ç”¨éƒ¨ç½²
# ============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: apps
  labels:
    app: frontend
    version: v1
spec:
  replicas: 1  # 4æ ¸16Gé…ç½®ï¼Œå•å‰¯æœ¬å³å¯
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
        version: v1
    spec:
      containers:
      - name: frontend
        image: ecommerce-frontend:1.0.0
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
        
        # å¥åº·æ£€æŸ¥
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 3
          failureThreshold: 3
        
        readinessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        
        # èµ„æºé™åˆ¶ï¼ˆ4æ ¸16Gé…ç½®ä¼˜åŒ–ï¼‰
        resources:
          limits:
            cpu: 200m      # æœ€å¤§0.2æ ¸
            memory: 256Mi  # æœ€å¤§256MB
          requests:
            cpu: 100m      # æœ€å°‘0.1æ ¸
            memory: 128Mi  # æœ€å°‘128MB
        
        # ç¯å¢ƒå˜é‡
        env:
        - name: TZ
          value: "Asia/Shanghai"

---
# ============================================
# Serviceï¼šå‰ç«¯æœåŠ¡
# ============================================
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: apps
  labels:
    app: frontend
spec:
  type: ClusterIP  # ä½¿ç”¨ Ingressï¼Œä¸éœ€è¦ NodePort
  selector:
    app: frontend
  ports:
  - name: http
    port: 80        # Service ç«¯å£
    targetPort: 80  # Pod ç«¯å£
    protocol: TCP
  sessionAffinity: None

---
# ============================================
# Ingressï¼šå¤–éƒ¨è®¿é—®å…¥å£ï¼ˆæ¨èæ–¹å¼ï¼‰
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frontend-ingress
  namespace: apps
  annotations:
    # Nginx Ingress é…ç½®
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    
    # é™æµé…ç½®ï¼ˆæ¯ç§’100æ¬¡è¯·æ±‚ï¼‰
    nginx.ingress.kubernetes.io/limit-rps: "100"
    
    # å¯ç”¨CORSï¼ˆå¦‚æœéœ€è¦ï¼‰
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    
    # è¶…æ—¶é…ç½®
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # ç¼“å†²é…ç½®
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "4k"
spec:
  ingressClassName: nginx  # ä½¿ç”¨ Nginx Ingress Controller
  rules:
  - host: ecommerce.local  # å¯ä»¥é…ç½®ä¸ºå®é™…åŸŸå
    http:
      paths:
      # å‰ç«¯è·¯ç”±
      - path: /
        pathType: Prefix
        backend:
          service:
            name: frontend
            port:
              number: 80
      
      # API è·¯ç”±ï¼ˆä»£ç†åˆ° Gatewayï¼‰
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: gateway-service
            port:
              number: 8000
```

éƒ¨ç½²å‰ç«¯ï¼š

```bash
# 1. åº”ç”¨é…ç½®
kubectl apply -f frontend/k8s-deployment.yaml

# 2. æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get deployment -n apps frontend
kubectl get pods -n apps -l app=frontend
kubectl get svc -n apps frontend
kubectl get ingress -n apps frontend-ingress

# 3. æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe deployment -n apps frontend
kubectl describe ingress -n apps frontend-ingress

# 4. æŸ¥çœ‹æ—¥å¿—
kubectl logs -n apps -l app=frontend -f

# 5. è·å– Ingress è®¿é—®åœ°å€
INGRESS_IP=$(kubectl get svc -n kube-system traefik -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
echo "è®¿é—®åœ°å€: http://$INGRESS_IP"
echo "æˆ–è€…: http://ecommerce.localï¼ˆéœ€é…ç½® hostsï¼‰"
```

**é…ç½®æœ¬åœ° hostsï¼ˆå¯é€‰ï¼‰ï¼š**

```bash
# è·å– K3s èŠ‚ç‚¹ IP
NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')

# æ·»åŠ åˆ° hosts
echo "$NODE_IP ecommerce.local" | sudo tee -a /etc/hosts

# Windows ç”¨æˆ·ç¼–è¾‘: C:\Windows\System32\drivers\etc\hosts
# æ·»åŠ : 192.168.xxx.xxx ecommerce.local

# è®¿é—®
# æµè§ˆå™¨æ‰“å¼€: http://ecommerce.local
```

**éªŒè¯éƒ¨ç½²ï¼š**

```bash
# 1. æ£€æŸ¥ Pod çŠ¶æ€ï¼ˆåº”è¯¥æ˜¯ Runningï¼‰
kubectl get pods -n apps -l app=frontend
# NAME                        READY   STATUS    RESTARTS   AGE
# frontend-xxxxxxxxxx-xxxxx   1/1     Running   0          1m

# 2. æ£€æŸ¥å¥åº·æ£€æŸ¥
kubectl exec -n apps -it $(kubectl get pod -n apps -l app=frontend -o jsonpath='{.items[0].metadata.name}') -- wget -O- http://localhost/health
# åº”è¯¥è¿”å›: healthy

# 3. æ£€æŸ¥èµ„æºå ç”¨
kubectl top pod -n apps -l app=frontend
# NAME                        CPU(cores)   MEMORY(bytes)
# frontend-xxxxxxxxxx-xxxxx   5m           45Mi

# 4. æµ‹è¯•è®¿é—®
curl http://ecommerce.local
curl http://ecommerce.local/api/orders
```

**æ€§èƒ½ä¼˜åŒ–éªŒè¯ï¼š**

```bash
# æµ‹è¯•é™æ€èµ„æºæ€§èƒ½
ab -n 1000 -c 50 http://ecommerce.local/

# é¢„æœŸç»“æœï¼ˆå•å‰¯æœ¬ Nginxï¼‰ï¼š
# - Requests per second: > 2,000
# - Time per request: < 25ms
# - Failed requests: 0

# æµ‹è¯• API ä»£ç†æ€§èƒ½
ab -n 1000 -c 50 http://ecommerce.local/api/orders

# é¢„æœŸç»“æœï¼š
# - Requests per second: > 500
# - Time per request: < 100ms
```

#### 4.0.2 æ–¹å¼äºŒï¼šç›´æ¥åœ¨å®¿ä¸»æœºè¿è¡Œå‰ç«¯ï¼ˆæ¨èç”¨äºå¼€å‘ï¼‰

```bash
# è¿›å…¥å‰ç«¯ç›®å½•
cd ~/ecommerce-microservices/frontend

# ä¿®æ”¹ vite.config.ts
cat > vite.config.ts <<'EOF'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src')
    }
  },
  
  server: {
    port: 3000,
    host: '0.0.0.0',
    open: true,
    proxy: {
      '/api': {
        target: 'http://192.168.xxx.xxx:30000',  # ç½‘å…³ NodePort
        changeOrigin: true
      }
    }
  }
})
EOF

# å®‰è£…ä¾èµ–
pnpm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
pnpm dev

# åå°è¿è¡Œ
nohup pnpm dev > frontend.log 2>&1 &
```

#### 4.0.3 éªŒè¯å‰ç«¯å’Œåç«¯è¿é€šæ€§

```bash
# 1. æ£€æŸ¥ç½‘å…³æœåŠ¡
kubectl get svc -n apps gateway-service

# 2. æµ‹è¯•ç½‘å…³ API
curl http://192.168.xxx.xxx:30000/api/orders/health

# 3. è®¿é—®å‰ç«¯é¡µé¢
# æµè§ˆå™¨: http://192.168.xxx.xxx:3000 (å¼€å‘æ¨¡å¼)
# æˆ–: http://192.168.xxx.xxx:30080 (ç”Ÿäº§æ¨¡å¼)

# 4. åœ¨å‰ç«¯åˆ›å»ºè®¢å•ï¼Œè§‚å¯Ÿåç«¯æ—¥å¿—
kubectl logs -f -n apps -l app=order-service
```

#### 4.0.4 å‰ç«¯èµ„æºå ç”¨

```bash
# æŸ¥çœ‹å‰ç«¯ Pod èµ„æºä½¿ç”¨
kubectl top pods -n apps | grep frontend

# å‰ç«¯èµ„æºå ç”¨å¾ˆå°ï¼Œé€šå¸¸ï¼š
# CPU: 10-50m
# Memory: 50-100Mi
```

---

## ç¬¬äº”éƒ¨åˆ†ï¼šHPA è‡ªåŠ¨æ‰©ç¼©å®¹å®æˆ˜

### 5.1 å®‰è£… Metrics Server

```bash
# K3s å·²å†…ç½® Metrics Serverï¼Œæ— éœ€å®‰è£…
# éªŒè¯
kubectl top nodes
kubectl top pods -n apps
```

### 5.2 æµ‹è¯• HPA

```bash
# æŸ¥çœ‹ HPA çŠ¶æ€
kubectl get hpa -n apps

# è¾“å‡ºç¤ºä¾‹ï¼š
# NAME            REFERENCE                  TARGETS   MINPODS   MAXPODS   REPLICAS
# order-service   Deployment/order-service   20%/80%   1         3         1

# å‹æµ‹è§¦å‘æ‰©å®¹
kubectl run -it --rm load-generator --image=busybox /bin/sh

# åœ¨å®¹å™¨å†…æ‰§è¡Œï¼ˆæ¨¡æ‹Ÿé«˜è´Ÿè½½ï¼‰
while true; do wget -q -O- http://order-service.apps:8081/api/orders/health; done
```

è§‚å¯Ÿæ‰©å®¹è¿‡ç¨‹ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰ï¼š

```bash
# å®æ—¶è§‚å¯Ÿ HPA
watch kubectl get hpa -n apps

# å®æ—¶è§‚å¯Ÿ Pod
watch kubectl get pods -n apps

# æŸ¥çœ‹æ‰©å®¹äº‹ä»¶
kubectl describe hpa order-service -n apps
```

### 5.3 HPA æ‰©å®¹æ•ˆæœ

```
åˆå§‹çŠ¶æ€ï¼š
- Pod æ•°é‡ï¼š1
- CPU ä½¿ç”¨ç‡ï¼š20%

å‹æµ‹ 1 åˆ†é’Ÿåï¼š
- CPU ä½¿ç”¨ç‡ï¼š85%
- HPA è§¦å‘æ‰©å®¹

å‹æµ‹ 2 åˆ†é’Ÿåï¼š
- Pod æ•°é‡ï¼š2
- CPU ä½¿ç”¨ç‡é™åˆ°ï¼š45%

å‹æµ‹ 3 åˆ†é’Ÿåï¼ˆç»§ç»­é«˜è´Ÿè½½ï¼‰ï¼š
- Pod æ•°é‡ï¼š3ï¼ˆè¾¾åˆ°æœ€å¤§å€¼ï¼‰
- CPU ä½¿ç”¨ç‡ï¼š60%

åœæ­¢å‹æµ‹ï¼š
- 5 åˆ†é’Ÿåè‡ªåŠ¨ç¼©å®¹
- Pod æ•°é‡ï¼š1
```

---

## ç¬¬å…­éƒ¨åˆ†ï¼šJVM æ€§èƒ½è°ƒä¼˜ï¼ˆä¸å é¢å¤–èµ„æºï¼‰

### 6.1 JVM å‚æ•°ä¼˜åŒ–

åœ¨ `values.yaml` ä¸­é…ç½®ï¼š

```yaml
env:
  - name: JAVA_OPTS
    value: >-
      -Xms256m
      -Xmx512m
      -XX:+UseG1GC
      -XX:MaxGCPauseMillis=200
      -XX:+HeapDumpOnOutOfMemoryError
      -XX:HeapDumpPath=/tmp/heapdump.hprof
      -XX:+PrintGCDetails
      -XX:+PrintGCDateStamps
      -Xloggc:/tmp/gc.log
      -XX:+UseGCLogFileRotation
      -XX:NumberOfGCLogFiles=5
      -XX:GCLogFileSize=10M
      -XX:+UseContainerSupport
      -XX:MaxRAMPercentage=80.0
```

### 6.2 æŸ¥çœ‹ GC æ—¥å¿—

```bash
# å¤åˆ¶ GC æ—¥å¿—åˆ°æœ¬åœ°
kubectl cp apps/order-service-xxx:/tmp/gc.log ./gc.log

# ä½¿ç”¨ GCViewer åˆ†æï¼ˆéœ€è¦ä¸‹è½½ï¼‰
java -jar gcviewer.jar gc.log
```

### 6.3 ä½¿ç”¨ Arthas åœ¨çº¿è¯Šæ–­

#### 6.3.1 åœ¨é•œåƒä¸­æ·»åŠ  Arthas

ä¿®æ”¹ `Dockerfile`ï¼š

```dockerfile
FROM openjdk:8-jdk-alpine

# æ·»åŠ  Arthas
RUN wget https://arthas.aliyun.com/arthas-boot.jar -O /opt/arthas-boot.jar

COPY target/order-service-1.0.0.jar /app.jar

EXPOSE 8081

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

#### 6.3.2 ä½¿ç”¨ Arthas

```bash
# è¿›å…¥ Pod
kubectl exec -it -n apps order-service-xxx -- /bin/sh

# å¯åŠ¨ Arthas
java -jar /opt/arthas-boot.jar

# å¸¸ç”¨å‘½ä»¤
dashboard      # æŸ¥çœ‹ JVM æ¦‚è§ˆ
thread         # æŸ¥çœ‹çº¿ç¨‹
thread -b      # æŸ¥çœ‹æ­»é”
thread -n 3    # æŸ¥çœ‹ CPU å ç”¨æœ€é«˜çš„ 3 ä¸ªçº¿ç¨‹
jvm            # æŸ¥çœ‹ JVM ä¿¡æ¯
memory         # æŸ¥çœ‹å†…å­˜
gc             # æŸ¥çœ‹ GC æƒ…å†µ

# ç›‘æ§æ–¹æ³•
monitor -c 5 com.demo.order.service.OrderService createOrder

# è¿½è¸ªæ–¹æ³•
trace com.demo.order.service.OrderService createOrder

# æŸ¥çœ‹æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼
watch com.demo.order.service.OrderService createOrder "{params,returnObj}" -x 2

# ç”Ÿæˆç«ç„°å›¾
profiler start
# ç­‰å¾… 30 ç§’...
profiler stop --format html --file /tmp/flamegraph.html
exit

# å¤åˆ¶ç«ç„°å›¾åˆ°æœ¬åœ°
kubectl cp apps/order-service-xxx:/tmp/flamegraph.html ./flamegraph.html
```

### 6.4 å†…å­˜æ³„æ¼æ’æŸ¥

```bash
# ç”Ÿæˆå †è½¬å‚¨
kubectl exec -n apps order-service-xxx -- \
  jmap -dump:live,format=b,file=/tmp/heapdump.hprof 1

# å¤åˆ¶åˆ°æœ¬åœ°
kubectl cp apps/order-service-xxx:/tmp/heapdump.hprof ./heapdump.hprof

# ä½¿ç”¨ MAT (Eclipse Memory Analyzer) åˆ†æ
# ä¸‹è½½ï¼šhttps://www.eclipse.org/mat/downloads.php
```

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šæ•°æ®åº“ä¼˜åŒ–ï¼ˆä¸å é¢å¤–èµ„æºï¼‰

### 7.1 ç´¢å¼•ä¼˜åŒ–

```bash
# è¿æ¥æ•°æ®åº“
kubectl exec -it -n middleware postgres-postgresql-0 -- \
  psql -U admin -d order_db
```

#### 7.1.1 æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
EXPLAIN ANALYZE
SELECT * FROM t_order 
WHERE user_id = 1001 
  AND status = 'PENDING' 
  AND create_time > '2025-01-01';
```

#### 7.1.2 åˆ›å»ºç´¢å¼•

```sql
-- å¤åˆç´¢å¼•ï¼ˆæœ€å·¦å‰ç¼€ï¼‰
CREATE INDEX idx_user_status_time ON t_order(user_id, status, create_time);

-- éƒ¨åˆ†ç´¢å¼•ï¼ˆåªç´¢å¼•å¾…å¤„ç†è®¢å•ï¼‰
CREATE INDEX idx_pending_orders ON t_order(user_id, create_time)
WHERE status = 'PENDING';

-- è¦†ç›–ç´¢å¼•ï¼ˆé¿å…å›è¡¨ï¼‰
CREATE INDEX idx_order_with_amount ON t_order(user_id) 
INCLUDE (total_amount, product_name);

-- æŸ¥çœ‹ç´¢å¼•
\di
```

### 7.2 æ…¢æŸ¥è¯¢ä¼˜åŒ–

#### 7.2.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—

```sql
-- è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆ1 ç§’ï¼‰
ALTER SYSTEM SET log_min_duration_statement = 1000;

-- é‡æ–°åŠ è½½é…ç½®
SELECT pg_reload_conf();
```

#### 7.2.2 æŸ¥çœ‹æ…¢æŸ¥è¯¢

```sql
-- å®‰è£… pg_stat_statements æ‰©å±•
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT 
  query,
  calls,
  total_exec_time,
  mean_exec_time,
  max_exec_time
FROM pg_stat_statements
WHERE mean_exec_time > 1000
ORDER BY mean_exec_time DESC
LIMIT 10;
```

#### 7.2.3 å¸¸è§ä¼˜åŒ–

```sql
-- ä¼˜åŒ–1ï¼šé¿å… SELECT *
-- æ…¢
SELECT * FROM t_order WHERE user_id = 1001;

-- å¿«
SELECT order_no, total_amount, status FROM t_order WHERE user_id = 1001;

-- ä¼˜åŒ–2ï¼šåˆ†é¡µä¼˜åŒ–
-- æ…¢ï¼ˆOFFSET å¾ˆå¤§æ—¶ï¼‰
SELECT * FROM t_order ORDER BY id LIMIT 10 OFFSET 10000;

-- å¿«ï¼ˆä½¿ç”¨æ¸¸æ ‡ï¼‰
SELECT * FROM t_order WHERE id > 10000 ORDER BY id LIMIT 10;

-- ä¼˜åŒ–3ï¼šIN æ”¹ä¸º EXISTS
-- æ…¢
SELECT * FROM t_order 
WHERE product_id IN (
    SELECT product_id FROM t_inventory WHERE stock > 0
);

-- å¿«
SELECT * FROM t_order o
WHERE EXISTS (
    SELECT 1 FROM t_inventory i 
    WHERE i.product_id = o.product_id AND i.stock > 0
);
```

### 7.3 è¿æ¥æ± ä¼˜åŒ–

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
spring:
  datasource:
    hikari:
      # æœ€å°ç©ºé—²è¿æ¥
      minimum-idle: 5
      # æœ€å¤§è¿æ¥æ•°
      maximum-pool-size: 20
      # è¿æ¥è¶…æ—¶
      connection-timeout: 30000
      # ç©ºé—²è¶…æ—¶
      idle-timeout: 600000
      # æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
      max-lifetime: 1800000
      # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      connection-test-query: SELECT 1
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šç›‘æ§å‘Šè­¦

### 8.1 éƒ¨ç½² Prometheusï¼ˆèµ„æºé™åˆ¶ï¼‰

```bash
# åˆ›å»º values æ–‡ä»¶
cat > prometheus-values.yaml <<EOF
server:
  persistentVolume:
    size: 5Gi
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# ç¦ç”¨ä¸éœ€è¦çš„ç»„ä»¶
alertmanager:
  enabled: false
pushgateway:
  enabled: false
nodeExporter:
  enabled: false
EOF

# éƒ¨ç½² Prometheus
helm install prometheus prometheus-community/prometheus \
  --namespace monitoring \
  --create-namespace \
  --values prometheus-values.yaml

# ç«¯å£è½¬å‘
kubectl port-forward -n monitoring svc/prometheus-server 9090:80 &

# è®¿é—® Prometheus
# URL: http://localhost:9090
```

### 8.2 éƒ¨ç½² Grafanaï¼ˆèµ„æºé™åˆ¶ï¼‰

```bash
# åˆ›å»º values æ–‡ä»¶
cat > grafana-values.yaml <<EOF
adminPassword: Admin@123

persistence:
  enabled: true
  size: 2Gi

resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 250m
    memory: 128Mi
EOF

# éƒ¨ç½² Grafana
helm install grafana grafana/grafana \
  --namespace monitoring \
  --values grafana-values.yaml

# ç«¯å£è½¬å‘
kubectl port-forward -n monitoring svc/grafana 3000:80 &

# è®¿é—® Grafana
# URL: http://localhost:3000
# ç”¨æˆ·å/å¯†ç : admin/Admin@123
```

### 8.3 é…ç½® Grafana æ•°æ®æº

1. ç™»å½• Grafana
2. Configuration â†’ Data Sources â†’ Add data source
3. é€‰æ‹© Prometheus
4. URL: `http://prometheus-server.monitoring:80`
5. Save & Test

### 8.4 å¯¼å…¥ç›‘æ§é¢æ¿

```bash
# JVM ç›‘æ§é¢æ¿ ID: 4701
# Spring Boot ç›‘æ§é¢æ¿ ID: 12900

# åœ¨ Grafana ä¸­ï¼š
# + â†’ Import â†’ è¾“å…¥é¢æ¿ ID â†’ Load â†’ Import
```

---

## ç¬¬ä¹éƒ¨åˆ†ï¼šèµ„æºç›‘æ§å’Œä¼˜åŒ–

### 9.1 æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ

```bash
# æŸ¥çœ‹èŠ‚ç‚¹èµ„æº
kubectl top nodes

# æŸ¥çœ‹æ‰€æœ‰ Pod èµ„æº
kubectl top pods -A

# æŸ¥çœ‹å…·ä½“å‘½åç©ºé—´
kubectl top pods -n middleware
kubectl top pods -n apps
kubectl top pods -n monitoring

# æŸ¥çœ‹ Pod è¯¦ç»†ä¿¡æ¯
kubectl describe pod -n apps order-service-xxx
```

### 9.2 èµ„æºä½¿ç”¨æ€»ç»“

```bash
# åˆ›å»ºèµ„æºæŠ¥å‘Šè„šæœ¬
cat > resource-report.sh <<'EOF'
#!/bin/bash

echo "=== èµ„æºä½¿ç”¨æŠ¥å‘Š ==="
echo ""

echo "èŠ‚ç‚¹èµ„æº:"
kubectl top nodes
echo ""

echo "ä¸­é—´ä»¶èµ„æº:"
kubectl top pods -n middleware
echo ""

echo "åº”ç”¨èµ„æº:"
kubectl top pods -n apps
echo ""

echo "ç›‘æ§èµ„æº:"
kubectl top pods -n monitoring
echo ""

echo "æ€»è®¡:"
kubectl top pods -A | awk 'NR>1 {cpu+=$2; mem+=$3} END {print "CPU:", cpu, "Memory:", mem}'
EOF

chmod +x resource-report.sh

# æ‰§è¡ŒæŠ¥å‘Š
./resource-report.sh
```

### 9.3 ä¼˜åŒ–å»ºè®®

å¦‚æœå†…å­˜ä¸è¶³ï¼š

```bash
# 1. åœæ­¢ä¸éœ€è¦çš„ Pod
kubectl scale deployment order-service --replicas=0 -n apps

# 2. å‡å°‘ JVM å †å†…å­˜
# ä¿®æ”¹ values.yaml
JAVA_OPTS: "-Xms128m -Xmx256m"

# 3. é™ä½èµ„æºé™åˆ¶
resources:
  limits:
    memory: 256Mi  # ä» 512Mi é™åˆ° 256Mi
```

---

## ç¬¬åéƒ¨åˆ†ï¼šå®Œæ•´éƒ¨ç½²è„šæœ¬

### 10.1 ä¸€é”®éƒ¨ç½²è„šæœ¬

```bash
cat > deploy-all.sh <<'EOF'
#!/bin/bash

echo "=== å¼€å§‹éƒ¨ç½²ç²¾ç®€é«˜çº§ç‰ˆå¾®æœåŠ¡ç³»ç»Ÿ ==="

# 1. åˆ›å»ºå‘½åç©ºé—´
echo "1. åˆ›å»ºå‘½åç©ºé—´..."
kubectl create namespace middleware --dry-run=client -o yaml | kubectl apply -f -
kubectl create namespace apps --dry-run=client -o yaml | kubectl apply -f -
kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

# 2. éƒ¨ç½²ä¸­é—´ä»¶
echo "2. éƒ¨ç½²ä¸­é—´ä»¶..."
helm install postgres bitnami/postgresql --namespace middleware --values postgres-values.yaml --wait
helm install redis bitnami/redis --namespace middleware --values redis-values.yaml --wait
helm install kafka bitnami/kafka --namespace middleware --values kafka-values.yaml --wait
kubectl apply -f nacos-deployment.yaml

# 3. ç­‰å¾…ä¸­é—´ä»¶å°±ç»ª
echo "3. ç­‰å¾…ä¸­é—´ä»¶å°±ç»ª..."
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=postgresql -n middleware --timeout=300s
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=redis -n middleware --timeout=300s
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kafka -n middleware --timeout=300s
kubectl wait --for=condition=ready pod -l app=nacos -n middleware --timeout=300s

# 4. åˆå§‹åŒ–æ•°æ®åº“
echo "4. åˆå§‹åŒ–æ•°æ®åº“..."
kubectl exec -it -n middleware postgres-postgresql-0 -- psql -U admin -d order_db < init.sql

# 5. éƒ¨ç½²å¾®æœåŠ¡
echo "5. éƒ¨ç½²å¾®æœåŠ¡..."
helm install order-service ./order-service --namespace apps
helm install inventory-service ./inventory-service --namespace apps
helm install notification-service ./notification-service --namespace apps
helm install gateway-service ./gateway-service --namespace apps

# 6. éƒ¨ç½²ç›‘æ§
echo "6. éƒ¨ç½²ç›‘æ§..."
helm install prometheus prometheus-community/prometheus --namespace monitoring --values prometheus-values.yaml
helm install grafana grafana/grafana --namespace monitoring --values grafana-values.yaml

# 7. æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
echo "7. éƒ¨ç½²å®Œæˆï¼ŒæŸ¥çœ‹çŠ¶æ€..."
echo ""
echo "=== ä¸­é—´ä»¶ ==="
kubectl get pods -n middleware
echo ""
echo "=== åº”ç”¨ ==="
kubectl get pods -n apps
echo ""
echo "=== ç›‘æ§ ==="
kubectl get pods -n monitoring
echo ""

echo "=== éƒ¨ç½²å®Œæˆ ==="
echo "Nacos: http://localhost:8848/nacos (nacos/nacos)"
echo "Grafana: http://localhost:3000 (admin/Admin@123)"
echo "Prometheus: http://localhost:9090"
EOF

chmod +x deploy-all.sh

# æ‰§è¡Œéƒ¨ç½²
./deploy-all.sh
```

### 10.2 æ¸…ç†è„šæœ¬

```bash
cat > cleanup.sh <<'EOF'
#!/bin/bash

echo "=== æ¸…ç†æ‰€æœ‰èµ„æº ==="

# å¸è½½å¾®æœåŠ¡
helm uninstall order-service -n apps
helm uninstall inventory-service -n apps
helm uninstall notification-service -n apps
helm uninstall gateway-service -n apps

# å¸è½½ç›‘æ§
helm uninstall prometheus -n monitoring
helm uninstall grafana -n monitoring

# å¸è½½ä¸­é—´ä»¶
helm uninstall postgres -n middleware
helm uninstall redis -n middleware
helm uninstall kafka -n middleware
kubectl delete -f nacos-deployment.yaml

# åˆ é™¤å‘½åç©ºé—´
kubectl delete namespace apps
kubectl delete namespace middleware
kubectl delete namespace monitoring

echo "=== æ¸…ç†å®Œæˆ ==="
EOF

chmod +x cleanup.sh
```

---

## ç¬¬åä¸€éƒ¨åˆ†ï¼šé¢è¯•å‡†å¤‡

### 11.1 æ ¸å¿ƒé—®é¢˜ä¸ç­”æ¡ˆ

#### Q1: ä½ ä»¬é¡¹ç›®æ˜¯å¦‚ä½•éƒ¨ç½²çš„ï¼Ÿ

**å›ç­”**ï¼š
æˆ‘ä»¬é¡¹ç›®ä½¿ç”¨ Kubernetes è¿›è¡Œå®¹å™¨ç¼–æ’ï¼Œå…·ä½“æ¥è¯´ä½¿ç”¨çš„æ˜¯ K3sï¼ˆè½»é‡çº§ Kubernetesï¼‰ã€‚

**è¯¦ç»†è¯´æ˜**ï¼š
1. ä½¿ç”¨ K3s æ›¿ä»£æ ‡å‡† K8sï¼ŒèŠ‚çœèµ„æºï¼ˆå†…å­˜å ç”¨ä» 4GB é™åˆ° 2GBï¼‰
2. ä½¿ç”¨ Helm æ‰“åŒ…å¾®æœåŠ¡ï¼Œæ–¹ä¾¿ç‰ˆæœ¬ç®¡ç†
3. é…ç½®äº† HPA è‡ªåŠ¨æ‰©ç¼©å®¹ï¼ŒCPU è¶…è¿‡ 80% è‡ªåŠ¨æ‰©å®¹
4. å•å‰¯æœ¬éƒ¨ç½² + ä¸¥æ ¼èµ„æºé™åˆ¶ï¼ˆæ¯ä¸ªæœåŠ¡é™åˆ¶ 512MB å†…å­˜ï¼‰
5. æ‰€æœ‰é…ç½®é€šè¿‡ ConfigMap å’Œ Secret ç®¡ç†

**åŠ åˆ†ç‚¹**ï¼š
- å› å¼€å‘ç¯å¢ƒèµ„æºé™åˆ¶ï¼ˆ4æ ¸16Gï¼‰ï¼Œé‡‡ç”¨ç²¾ç®€éƒ¨ç½²æ–¹æ¡ˆ
- ç”Ÿäº§ç¯å¢ƒä¼šéƒ¨ç½²å¤šå‰¯æœ¬å’Œæ›´å¤šèµ„æº
- ä½†æ ¸å¿ƒèƒ½åŠ›éƒ½å…·å¤‡

---

#### Q2: ä¸ºä»€ä¹ˆä¸ç”¨ Istioï¼Ÿ

**å›ç­”**ï¼š
äº†è§£ Istio æœåŠ¡ç½‘æ ¼ï¼ŒçŸ¥é“å…¶æ ¸å¿ƒåŠŸèƒ½ï¼ˆæµé‡ç®¡ç†ã€å®‰å…¨ã€å¯è§‚æµ‹æ€§ï¼‰ã€‚

**åŸå› è¯´æ˜**ï¼š
1. Istio èµ„æºå ç”¨è¾ƒå¤§ï¼ˆ2-3GBï¼‰ï¼Œå¼€å‘ç¯å¢ƒèµ„æºæœ‰é™
2. æ ¸å¿ƒçš„æµé‡ç®¡ç†åŠŸèƒ½å¯ä»¥ç”¨å…¶ä»–æ–¹å¼å®ç°ï¼š
   - ä½¿ç”¨ Kubernetes Service åšè´Ÿè½½å‡è¡¡
   - ä½¿ç”¨ Ingress åšæµé‡å…¥å£
   - ç°åº¦å‘å¸ƒå¯ä»¥ç”¨ Deployment çš„æ»šåŠ¨æ›´æ–°

**ç†è®ºæŒæ¡**ï¼š
- VirtualService + DestinationRule å®ç°æµé‡è·¯ç”±
- Sidecar æ¨¡å¼å®ç°æœåŠ¡é—´é€šä¿¡æ‹¦æˆª
- mTLS å®ç°æœåŠ¡é—´åŠ å¯†

**é¢è¯•æŠ€å·§**ï¼š
- ä¸è¯´"ä¸ä¼š"ï¼Œè€Œè¯´"äº†è§£åŸç†ï¼Œå› èµ„æºé™åˆ¶æœªéƒ¨ç½²"
- å±•ç¤ºç†è®ºç†è§£
- è¯´æ˜ç”Ÿäº§ç¯å¢ƒä¼šä½¿ç”¨

---

#### Q3: å¦‚ä½•ä¿è¯ç³»ç»Ÿç¨³å®šæ€§ï¼Ÿ

**å›ç­”**ï¼š
ä»å¤šä¸ªå±‚é¢ä¿è¯ç³»ç»Ÿç¨³å®šæ€§ï¼š

**åº”ç”¨å±‚**ï¼š
1. HPA è‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œåº”å¯¹æµé‡æ³¢åŠ¨
2. å¥åº·æ£€æŸ¥ï¼ˆLiveness å’Œ Readiness Probeï¼‰
3. æ»šåŠ¨æ›´æ–°ï¼Œé›¶åœæœºéƒ¨ç½²
4. èµ„æºé™åˆ¶ï¼Œé˜²æ­¢å•ä¸ªæœåŠ¡å ç”¨è¿‡å¤šèµ„æº

**æ•°æ®å±‚**ï¼š
1. æ•°æ®åº“è¿æ¥æ± ï¼ˆHikariCPï¼‰
2. Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
3. å®šæœŸæ•°æ®åº“å¤‡ä»½

**ç›‘æ§å±‚**ï¼š
1. Prometheus é‡‡é›†æŒ‡æ ‡
2. Grafana å®æ—¶ç›‘æ§
3. å‘Šè­¦åŠæ—¶é€šçŸ¥

---

#### Q4: JVM è°ƒä¼˜åšè¿‡å“ªäº›ï¼Ÿ

**å›ç­”**ï¼š
åšè¿‡å¤šæ¬¡ JVM è°ƒä¼˜ï¼Œä¸¾ä¸€ä¸ªä¾‹å­ï¼š

**é—®é¢˜**ï¼š
åº”ç”¨é¢‘ç¹ Full GCï¼Œæ¯æ¬¡åœé¡¿ 1-2 ç§’ã€‚

**æ’æŸ¥**ï¼š
1. ä¸‹è½½ GC æ—¥å¿—åˆ†æ
2. å‘ç°è€å¹´ä»£å ç”¨ç‡ä¸€ç›´ > 90%
3. ä½¿ç”¨ jmap ç”Ÿæˆå †è½¬å‚¨
4. ç”¨ MAT åˆ†æï¼Œå‘ç°ç¼“å­˜å ç”¨è¿‡å¤š

**è§£å†³**ï¼š
1. è°ƒæ•´ç¼“å­˜å¤§å°ï¼ˆé™åˆ¶ 10000 æ¡ï¼‰
2. ä¼˜åŒ– JVM å‚æ•°ï¼š
   ```
   -Xms256m -Xmx512m
   -XX:+UseG1GC
   -XX:MaxGCPauseMillis=200
   ```
3. ä½¿ç”¨ G1 æ”¶é›†å™¨ï¼Œé€‚åˆå°å †

**æ•ˆæœ**ï¼š
- Full GC é¢‘ç‡é™ä½ 90%
- åœé¡¿æ—¶é—´ < 100ms
- è€å¹´ä»£å ç”¨ç‡é™åˆ° 50%

---

#### Q5: å¦‚ä½•ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼Ÿ

**å›ç­”**ï¼š
é‡åˆ°è¿‡ä¸€æ¬¡æ…¢æŸ¥è¯¢é—®é¢˜ï¼š

**é—®é¢˜**ï¼š
è®¢å•æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ 3 ç§’ã€‚

**æ’æŸ¥**ï¼š
1. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
2. ä½¿ç”¨ EXPLAIN åˆ†æ
3. å‘ç°å…¨è¡¨æ‰«æï¼Œç´¢å¼•å¤±æ•ˆ

**åŸå› **ï¼š
æŸ¥è¯¢æ¡ä»¶ç”¨äº†å‡½æ•°ï¼š`WHERE YEAR(create_time) = 2025`

**è§£å†³**ï¼š
1. æ”¹å†™ SQLï¼š`WHERE create_time >= '2025-01-01' AND create_time < '2026-01-01'`
2. åˆ›å»ºå¤åˆç´¢å¼•ï¼š`(user_id, create_time)`
3. åªæŸ¥è¯¢éœ€è¦çš„åˆ—ï¼Œä¸ç”¨ `SELECT *`

**æ•ˆæœ**ï¼š
- å“åº”æ—¶é—´é™åˆ° 50ms
- æ•°æ®åº“ CPU ä» 100% é™åˆ° 20%

---

### 11.2 é¡¹ç›®äº®ç‚¹

**æŠ€æœ¯äº®ç‚¹**ï¼š
1. âœ… Kubernetes (K3s) ç”Ÿäº§éƒ¨ç½²
2. âœ… Helm åº”ç”¨æ‰“åŒ…ç®¡ç†
3. âœ… HPA è‡ªåŠ¨æ‰©ç¼©å®¹
4. âœ… JVM æ·±åº¦è°ƒä¼˜
5. âœ… æ•°æ®åº“ä¼˜åŒ–
6. âœ… å®Œæ•´ç›‘æ§ä½“ç³»

**ä¼˜åŒ–æˆæœ**ï¼š
- QPS: 1000 â†’ 5000ï¼ˆ5å€æå‡ï¼‰
- å“åº”æ—¶é—´: 500ms â†’ 50msï¼ˆ90% é™ä½ï¼‰
- å†…å­˜ä½¿ç”¨: 2GB â†’ 1GBï¼ˆ50% é™ä½ï¼‰

---

## é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰èµ„æº
kubectl get all -n apps

# æŸ¥çœ‹ Pod æ—¥å¿—
kubectl logs -f -n apps <pod-name>

# è¿›å…¥ Pod
kubectl exec -it -n apps <pod-name> -- /bin/sh

# ç«¯å£è½¬å‘
kubectl port-forward -n apps svc/<service-name> <local-port>:<remote-port>

# æŸ¥çœ‹èµ„æºä½¿ç”¨
kubectl top pods -n apps

# æ‰©ç¼©å®¹
kubectl scale deployment <name> --replicas=<count> -n apps

# é‡å¯æœåŠ¡
kubectl rollout restart deployment/<name> -n apps

# æŸ¥çœ‹ HPA
kubectl get hpa -n apps

# æŸ¥çœ‹äº‹ä»¶
kubectl get events -n apps --sort-by='.lastTimestamp'
```

### èµ„æºé…é¢æ€»ç»“

```
ä¸­é—´ä»¶:          2GB
å¾®æœåŠ¡:          1.5GB
ç›‘æ§:            0.8GB
K3s:             2GB
ç³»ç»Ÿé¢„ç•™:        2GB
å¤‡ç”¨:            7.7GB
---------------------------
æ€»è®¡:            16GB
```

---

## æ€»ç»“

å®Œæˆæœ¬ç²¾ç®€é«˜çº§ç‰ˆåï¼Œä½ å°†å…·å¤‡ï¼š

### äº‘åŸç”Ÿèƒ½åŠ›
- âœ… Kubernetes æ ¸å¿ƒæ¦‚å¿µ
- âœ… Helm åº”ç”¨ç®¡ç†
- âœ… HPA è‡ªåŠ¨æ‰©ç¼©å®¹
- âœ… èµ„æºé™åˆ¶å’Œä¼˜åŒ–

### æ€§èƒ½è°ƒä¼˜èƒ½åŠ›
- âœ… JVM å‚æ•°é…ç½®
- âœ… GC æ—¥å¿—åˆ†æ
- âœ… Arthas è¯Šæ–­
- âœ… æ•°æ®åº“ä¼˜åŒ–

### ç›‘æ§è¿ç»´èƒ½åŠ›
- âœ… Prometheus ç›‘æ§
- âœ… Grafana å¯è§†åŒ–
- âœ… å‘Šè­¦é…ç½®

### èƒ½è¾¾åˆ°çš„æ°´å¹³
- æŠ€æœ¯èƒ½åŠ›ï¼šä¸­é«˜çº§å·¥ç¨‹å¸ˆ
- é¢è¯•é€šè¿‡ç‡ï¼š90%+
- **è–ªèµ„èŒƒå›´ï¼š20K-35K**

---

**æ­å–œå®Œæˆç²¾ç®€é«˜çº§ç‰ˆå­¦ä¹ ï¼ä½ å·²ç»æŒæ¡äº†äº‘åŸç”Ÿçš„æ ¸å¿ƒèƒ½åŠ›ï¼ğŸ‰**

**ä¸‹ä¸€æ­¥**ï¼š
1. æ•´ç†æ¶æ„å›¾
2. å‡†å¤‡é¢è¯•ç­”æ¡ˆ
3. å½•åˆ¶æ¼”ç¤ºè§†é¢‘
4. æ›´æ–°ç®€å†
5. å¼€å§‹é¢è¯•ï¼

**ç¥ä½ é¢è¯•æˆåŠŸï¼Œæ‹¿åˆ°æ»¡æ„çš„ offerï¼åŠ æ²¹ï¼ğŸš€**

